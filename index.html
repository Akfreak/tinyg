<html lang="en"><head>
<title>ChiliPeppr - Hardware Fiddle</title>
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script async="" src="//www.google-analytics.com/analytics.js"></script><script src="js/require.js"></script>
	
<script type="text/javascript">



cprequire(["chilipeppr_ready"], function() {
	console.log("seeing if chilipeppr is globally defined...");
	console.log(chilipeppr);
	chilipeppr.load("root", "http://fiddle.jshell.net/chilipeppr/2H9us/show/light/");
});

</script>
<script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jquery" src="//code.jquery.com/jquery-2.1.0.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="bootstrap" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="amplify" src="//www.chilipeppr.com/js/amplify-1.1.2/amplify.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="chilipeppr_init" src="//www.chilipeppr.com/js/app.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="google" src="//www.google-analytics.com/analytics.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="chilipeppr_init2" src="//www.chilipeppr.com/js/app2.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="chilipeppr_ready" src="//www.chilipeppr.com/js/main.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jquerycookie" src="//www.chilipeppr.com/js/jquery-cookie/jquery.cookie.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jqueryui" src="//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.core.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="Three" src="http://threejs.org/build/three.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="ThreeDetector" src="http://threejs.org/examples/js/Detector.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="waypoints" src="//cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.4/waypoints.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jqueryuiWidget" src="//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.widget.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jqueryuiMouse" src="//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.mouse.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jqueryuiResizeable" src="//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.resizable.js"></script><link type="text/css" rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css"><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="ThreeTrackballControls" src="//threejs.org/examples/js/controls/TrackballControls.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="ThreeTween" src="http://www.chilipeppr.com/js/three/tween.min.js"></script></head>
<body><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/ -->




<style type="text/css">
    
  </style>
  


  <div class="modal fade " id="com-chilipeppr-elem-pubsubviewer-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h4 class="modal-title">Modal title</h4>
      </div>
      <div class="modal-body">
          <table class="table table-bordered table-striped">
              <!-- <thead>
                      <tr>
                          <th style="">Signal</th>
                          <th style="">Description</th>
                      </tr>
                  </thead> -->
              <tbody>
                  <tr>
                      <td>ID</td>
                      <td class="pubsub-id">
                          com-chilipeppr-widget-tinyg
                      </td>
                  </tr>
                  <tr>
                      <td>Standalone URL</td>
                      <td class="pubsub-url">
                          http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/
                      </td>
                  </tr>
                  <tr>
                      <td>Fiddle URL</td>
                      <td class="pubsub-fiddleurl">
                          http://jsfiddle.net/chilipeppr/zMbL9/
                      </td>
                  </tr>
                  <tr>
                      <td>Description</td>
                      <td class="pubsub-desc">
                          This element shows a modal of a widget's/element's pubsub so the user can see how this widget/element interacts with other widgets/elements.
                      </td>
                  </tr>
              </tbody>
          </table>

          <div class="pubsub-interface hidden">
              <h4>Interface Implementation</h4>
              <p>This widget/element implements an interface specification. Since Javascript does not have the notion of interfaces like the way languages such as Java have native support for interfaces, ChiliPeppr has defined its own loose version of an interface. If this widget/element has implemented an interface, it means it has followed a general standard set of pubsub signals that other widgets/elements should follow as well to make them swappable.</p>
          <table id="com-chilipeppr-elem-pubsubviewer-interface" class="table table-bordered table-striped">
              <thead>
                  <tr>
                      <th style="">Interface Implementation</th>
                      <th style="">Description</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>
          </div><!-- interface -->
          
          <h4>Publish</h4>
          <p>This widget/element publishes the following signals. These signals are owned by this widget/element and are published to all objects inside the ChiliPeppr environment that listen to them via the chilipeppr.subscribe(signal, callback) method.</p>
          <table id="com-chilipeppr-elem-pubsubviewer-pub" class="table table-bordered table-striped">
              <thead>
                  <tr>
                      <th style="">Signal</th>
                      <th style="">Description</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>

          <h4>Subscribe</h4>
          <p>This widget/element subscribes to the following signals. These signals are owned by this widget/element. Other objects inside the ChiliPeppr environment can publish to these signals via the chilipeppr.publish(signal, data) method.</p>
          <table id="com-chilipeppr-elem-pubsubviewer-sub" class="table table-bordered table-striped">
              <thead>
                  <tr>
                      <th style="">Signal</th>
                      <th style="">Description</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>

          <h4>Foreign Publish</h4>
          <p>This widget/element publishes to the following signals that are owned by other objects.</p>
          <table id="com-chilipeppr-elem-pubsubviewer-foreignpub" class="table table-bordered table-striped">
              <thead>
                  <tr>
                      <th style="">Signal</th>
                      <th style="">Description</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>

          <h4>Foreign Subscribe</h4>
          <p>This widget/element subscribes to the following signals owned by other objects.</p>
          <table id="com-chilipeppr-elem-pubsubviewer-foreignsub" class="table table-bordered table-striped">
              <thead>
                  <tr>
                      <th style="">Signal</th>
                      <th style="">Description</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>
          
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" data-original-title="" title="">Close</button>
        <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-elem-pubsubviewer", ["chilipeppr_ready"], function () {
    return {
        id: "com-chilipeppr-elem-pubsubviewer",
        url: "http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/zMbL9/",
        name: "Element / Pubsub Viewer",
        desc: "This element shows a modal of a widget's/element's pubsub so the user can see how this widget/element interacts with other widgets/elements.",
        isInitted: false,
        init: function () {    
            //var that = this;
            $('#com-chilipeppr-elem-pubsubviewer-modal').on('show.bs.modal', this.onShow.bind(this));
            $('#com-chilipeppr-elem-pubsubviewer-modal').on('hidden.bs.modal', function (e) {
                console.log("modal hidden");
            })
            //this.show();
            this.isInitted = true;
            console.log(this.name + " done initting.");
        },
        cpobject: null,    // the object we're showing pubsub for
        pubsubClick: function(evt) {
            console.log("got pubsub click in dropdown. evt:", evt);
            if (evt.data) {
                console.log("evt had correct object so showing modal:", evt.data);
                this.show(evt.data);
            }
        },
        show: function(cpobject) {
            this.cpobject = cpobject;
            if (!this.isInitted) this.init();
            $('#com-chilipeppr-elem-pubsubviewer-modal').modal('show');
        },
        onShow: function() {
            console.log("modal show pre");
            var o = this.cpobject;
            $('#com-chilipeppr-elem-pubsubviewer-modal .modal-title')
                .text("PubSub Viewer for \"" +
                      o.name + "\"");
            
            // do pre-amble info
            $('#com-chilipeppr-elem-pubsubviewer-modal .pubsub-id').html(o.id);
            $('#com-chilipeppr-elem-pubsubviewer-modal .pubsub-url').html('<a href="' + o.url + '" target="_blank">' + o.url + '</a>');
            $('#com-chilipeppr-elem-pubsubviewer-modal .pubsub-fiddleurl').html('<a href="' + o.fiddleurl + '" target="_blank">' + o.fiddleurl + '</a>');
            $('#com-chilipeppr-elem-pubsubviewer-modal .pubsub-desc').html(o.desc);
            
            // do interface implementations
            if (o.implements && o.implements != null) {
                $('#com-chilipeppr-elem-pubsubviewer-modal .pubsub-interface').removeClass('hidden');
                $('#com-chilipeppr-elem-pubsubviewer-modal #com-chilipeppr-elem-pubsubviewer-interface > tbody > tr').remove();
                if (Object.keys(o.implements).length > 0) {
                    var keys = Object.keys(o.implements);
                    $.each(keys, function(i, key) {
                        $('#com-chilipeppr-elem-pubsubviewer-modal #com-chilipeppr-elem-pubsubviewer-interface > tbody').append('<tr><td>' + key + '</td><td>' + o.implements[key] + '</td></tr>');
                    });
                }
            } else {
                // hide the interface section
                $('#com-chilipeppr-elem-pubsubviewer-modal .pubsub-interface').addClass('hidden');
            }
            
            // do publish
            this.appendKeyVal(o.publish, "#com-chilipeppr-elem-pubsubviewer-pub");
            this.appendKeyVal(o.subscribe, "#com-chilipeppr-elem-pubsubviewer-sub");
            this.appendKeyVal(o.foreignPublish, "#com-chilipeppr-elem-pubsubviewer-foreignpub");
            this.appendKeyVal(o.foreignSubscribe, "#com-chilipeppr-elem-pubsubviewer-foreignsub");
            
            
        },
        appendKeyVal: function(data, id) {
            // remove rows from previous rendering
            $('#com-chilipeppr-elem-pubsubviewer-modal ' + id + ' > tbody > tr').remove();
            if (data !== null && typeof data === 'object' && Object.keys(data).length > 0) {
                
                var keys = Object.keys(data);
                $.each(keys, function(i, key) {
                    $('#com-chilipeppr-elem-pubsubviewer-modal ' + id + ' > tbody').append('<tr><td>' + key + '</td><td>' + data[key] + '</td></tr>');
                });
            } else {
                $('#com-chilipeppr-elem-pubsubviewer-modal ' + id + ' > tbody').append('<tr><td colspan="2">(No signals defined in this widget/element)</td></tr>');
                
            }
        },
        attachTo: function(dropdownMenuEl, cpobject, altTitle) {
            var el = dropdownMenuEl;
            var o = cpobject;
            // this method let's you pass in a dropdown-menu
            // and we'll attach a new section with a divider,
            // the id of the widget, a link to the pubsub vieweer,
            // a linke to the standalone widget, and a link to fork
            // the widget
            
            // see if there's any <li> items. if there are add a divider
            // <li class="divider"></li>
            if (el.children('li').length > 0) {
                // has li's, so add divider
                el.append('<li class="divider"></li>');
            }
            
            // allow user to override the name Widget, i.e. set it to Workspace or Element
            var title = "Widget";
            if (altTitle != null && altTitle.length > 0) title = altTitle;
            
            /*
            <li role="presentation" class="dropdown-header fork-name"></li>
            <li><a href="" target="_blank" class="standalone">View Widget Standalone</a></li>
             <li><a href="" target="_blank" class="fork">Fork Widget</a></li>
            */
            el.append('<li role="presentation" class="dropdown-header fork-name">' + o.id + '</li>');
            var pslink = $('<li><a href="javascript:" class="pubsublink">PubSub for this ' + title + '</a></li>').click(o, this.pubsubClick.bind(this));
            el.append(pslink);
            el.append('<li><a href="' + o.url + '" target="_blank" class="standalone">View ' + title + ' Standalone</a></li>');
            var fork = $('<li><a href="' + o.fiddleurl + '" target="_blank" class="fork">Fork ' + title + '</a></li>').click(o, function() {
                console.log("Got fork click. object:", o);
                ga('send', 'event', 'button', 'click', 'fork' + title + '-' + o.id );
            });
            el.append(fork);
            
            el.children('.panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto'
            });
        }
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/ -->


<div id="root"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/2H9us/show/light/ -->




<style type="text/css">
    #pnlBody .container-fluid {
}
#pnlBody .pnlWorkspaceRtSidebarCollapsed {
    /* padding-right: 45px; */
    padding-right: 10px;
}
#pnlBody .pnlWorkspaceRtSidebarExpanded {
    padding-right: 0;
}
#pnlRtSidebar {
    position: relative;
}
#pnlWorkspace {
    padding-left: 10px;
}
  </style>
  


<script type="text/javascript">//<![CDATA[ 

// Make sure ChiliPeppr is ready to run and fully instantiated
// including all of its dependencies like jquery, bootstrap, etc.
cprequire(["chilipeppr_ready"], function () {

    // Element / Flash Message
    // http://jsfiddle.net/jlauer/qp7Em/
    // "inline:com-chilipeppr-elem-flashmsg"
    chilipeppr.load("#com-chilipeppr-flash",
        "http://fiddle.jshell.net/jlauer/qp7Em/show/light/",

    function () {
        console.log("mycallback got called after loading flash msg module");
        console.log(chilipeppr);
        require(["inline:com-chilipeppr-elem-flashmsg"], function (fm) {
            //console.log("inside require of " + fm.id);
            fm.init();
            //console.log(fm.publish);
            //chilipeppr.publish(fm.subscribe, "Loaded", "The ChiliPeppr Hardware Fiddle main app is loaded.");
            //chilipeppr.publish(fm.subscribe, "", "The ChiliPeppr Hardware Fiddle main app is loaded.");
            //chilipeppr.publish(fm.subscribe, "", "Third time is a charm");
            //console.log(fm);
            
            // Panel / Header
            //http://jsfiddle.net/chilipeppr/7aX6x/
            chilipeppr.load(
                "#pnlHeader",
                "http://fiddle.jshell.net/chilipeppr/7aX6x/show/light/",
        
            function () {
                //setTimeout(function() {
                cprequire(
                ["inline:com-chilipeppr-hdr"],
        
                function (hdr) {
                    console.log("running of " + hdr.id);
                    hdr.init();
                    
                    // LOAD THE WORKSPACE NOW
                    // Now analyze the window.location URL and load the base boot Javascript
                    // for this particular url from the data storage
                    console.log("window.location", window.location.pathname);
                    var path = window.location.pathname;
                    if (path == "/_display/") {
                        // we're inside jsfiddle, so pretend root
                        path = "";
                    } else {
                        path = path.replace(/^\//, "");
                        path = path.replace(/\/$/, "");
                    }
                    console.log("path of this workspace:", path);
                    var jqxhr = $.getJSON("http://www.chilipeppr.com/dataget?key=userUrl:" + path + "&callback=?")
                    .done(function (data) {
                        console.log("got jsnop callback", data);
                        if (data.KeyExists != undefined && data.KeyExists == false) {
                            console.log("this is a url that doesn't exist. show modal to define page.");
                            //chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "No Workspace Exists Here", "You can go ahead and create a workspace here.");
                            $('#pnlWorkspace').text("No workspace exists at \"" + path + "\", therefore you may use it by clicking Edit Boot Javascript from the upper right corner menu.");
                            // Load the edit boot dialog
                            //cprequire(["inline:com-chilipeppr-hdr"], function(hdr) {
                                hdr.editBoot();
                            //});
                            
                        } else if (data.Error && data.Error == true) {
                            //chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Error Retrieving Workspace", data.Msg);
                            $('#pnlWorkspace').text("Error retrieving workspace. " + data.Msg);
                            
                        } else {
                            
                            var p = path;
                            if (p == "") p = "(Default)";
                            $('#pnlWorkspace').text("Loading the workspace for path " + p + "...");
                            chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Loading Workspace", "Loading the workspace for path " + p + "...");
                            eval(data.Value);
                        }
                    })
                    .fail(function (data) {
                        console.log("failed. data:", data);
                        $('#pnlWorkspace').text("Error retrieving workspace. " + JSON.stringify(data));
                
                    })
                    
                    
                });
                //}, 1000);
            });

        });
    });

    /*
    chilipeppr.load("pnlRtSidebar",
        "http://fiddle.jshell.net/jlauer/WXN8J/show/light/");
    */

});
//]]>  

</script>




  <div id="pnlHeader"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/7aX6x/show/light/ -->




<style type="text/css">
    #mainnav {
    margin-bottom: 10px;
}
.com-chilipeppr-mainnav .navbar-collapse {
    /* height:30px; */
}
a.navbar-brand.main-brand {
    color:#bebebe;
    padding-right:10px;
}
a.navbar-brand.subbrand {
    margin-bottom:0;
    padding-left:10px;
}
/* .nav li:hover{
    color: #555;
background-color: #e7e7e7;
} */
  </style>
  


<script type="text/javascript">//<![CDATA[ 

// //www.google-analytics.com/analytics.js
requirejs.config({
    paths: {
        google: '//www.google-analytics.com/analytics'
    }
});

cpdefine("inline:com-chilipeppr-hdr", ["chilipeppr_ready", "google"], function (cp, google) {
    return {
        id: "com-chilipeppr-hdr",
        url: "http://fiddle.jshell.net/jlauer/Qheec/show/light/",
        fiddleurl: "http://jsfiddle.net/jlauer/Qheec/",
        name: "Widget / Header",
        desc: "This widget is the header panel.",
        publish: null,
        subscribe: null,
        isConnected: false,
        init: function () {
            this.setupLinks();
            this.checkLogin();
            this.editBootSetup();
            //this.doAnalytics();
            //this.editBoot();
            console.log(this.name + " done loading.");
        },
        doFork: function() {
            //this.editBoot();
            cprequire(['inline:com-chilipeppr-widget-editbootscript'], function (editboot) {
                console.log("Since we're reopening edit boot dialog in fork mode, need to tell it");
                editboot.init();
                editboot.doFork();
                $('#com-chilipeppr-hdr-editbootmodal').modal({show: true});

                //console.log("re-initted");
            });
        },
        editBootSetup: function() {
            var that = this;
            chilipeppr.load("com-chilipeppr-hdr-editbootmodalbody", "http://fiddle.jshell.net/chilipeppr/uNALR/show/light/", function () {
                console.log("Done lazy loading edit boot jscript content");
                $("#com-chilipeppr-topbar-menu-editboot").click(that.editBoot);
            });
        },
        editBoot: function() {
            console.log("editing boot");
                            
            cprequire(['inline:com-chilipeppr-widget-editbootscript'], function (editboot) {
                console.log("Since we're reopening edit boot dialog, reinitting");
                editboot.init();
                $('#com-chilipeppr-hdr-editbootmodal').modal({show: true});
                console.log("re-initted");
            });
            
        },
        currentUser: null,
        checkLogin: function () {
            var that = this;
            var jqxhr = $.getJSON("http://www.chilipeppr.com/datalogin?callback=?")
            .done(function (data) {
                console.log(data);
                if (data.CurrentUser != undefined && data.CurrentUser != null) {
                    console.log("user logged in ", data.CurrentUser);
                    that.currentUser = data.CurrentUser;
                    $('#com-chilipeppr-hdr-login').text(data.CurrentUser.Email);
                    $('#com-chilipeppr-hdr-dd-login').addClass("hidden");
                    $('#com-chilipeppr-hdr-dd-logout').prop('href', data.LogoutUrl);
                    // if they click their login id log them out
                    $('#com-chilipeppr-hdr-login').prop('href', data.LogoutUrl);
                } else {
                    console.log("user NOT logged in");
                    $('#com-chilipeppr-hdr-login').text("Login");
                    $('#com-chilipeppr-hdr-dd-login').removeClass("hidden");
                    $('#com-chilipeppr-hdr-dd-logout').addClass("hidden");
                    $('#com-chilipeppr-hdr-dd-login').prop('href', data.LoginUrl);
                    $('#com-chilipeppr-hdr-dd-login').prop('target', "new");
                    $('#com-chilipeppr-hdr-login').prop('href', data.LoginUrl);
                    $('#com-chilipeppr-hdr-login').prop('target', "new");
                }
                that.doAnalytics();
            })
            .fail(function () {
                that.doAnalytics();
            })
        },
        doAnalytics: function() {
            //console.log("Doing Google Analytics");
            //console.log("google:", google, "ga:", ga);
            ga('create', 'UA-51962619-1', 'chilipeppr.com');
            ga('require', 'displayfeatures');
            
            // Set the user ID using signed-in user_id.
            //console.log("currentUser", this.currentUser);
            if (this.currentUser != undefined 
                && this.currentUser != null 
                && this.currentUser.Email != undefined 
                && this.currentUser.Email != null) {
                //console.log("Passing user id to Google");
                ga('set', '&uid', this.currentUser.Email);
            }
            
            ga('send', 'pageview');
            
            // resend this every 15 mins
            setTimeout(this.doAnalytics.bind(this), 15 * 60 * 1000);
        },
        setupLinks: function () {
            $('#com-chilipeppr-hdr-wspick').click(this.onWsPick);
            var that = this;
            $('#com-chilipeppr-topbar-menu-forkws').click(function() {
                that.doFork();
            });
        },
        onWsPick: function () {
            console.log("Got into onWsPick");
            // lazy load the picker
            chilipeppr.load("#com-chilipeppr-hdr-modalbody", "http://fiddle.jshell.net/chilipeppr/8UwSX/show/light/", function () {
                console.log("Done lazy loading workspace picker content");
            });
        }
    }
});
//]]>  

</script>




  <nav id="mainnav" class="com-chilipeppr-mainnav navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>

            </button> <a class="navbar-brand main-brand" href="http://chilipeppr.com/"><img src="http://www.chilipeppr.com/img/chilipeppr_logo.png" style="max-height:22px;padding-right:3px;">ChiliPeppr</a>  <a class="navbar-brand subbrand" href="http://chilipeppr.com/">Hardware Fiddle</a>

        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class=""><a id="com-chilipeppr-hdr-wspick" href="#" data-toggle="modal" data-target="#com-chilipeppr-hdr-wspickmodal">Workspaces</a>

                </li>
            </ul>
            <form class="navbar-form navbar-left" role="search">
                <!-- <div class="form-group">
                    <input type="text" class="form-control" placeholder="Search" />
                </div> -->
                <!-- <button type="submit" class="btn btn-default">Submit</button> -->
            </form>
            <ul class="nav navbar-nav navbar-right">
                <li><a id="com-chilipeppr-hdr-login" href="http://www.chilipeppr.com/_ah/logout?continue=https://www.google.com/accounts/Logout%3Fcontinue%3Dhttps://appengine.google.com/_ah/logout%253Fcontinue%253Dhttp://www.chilipeppr.com/%26service%3Dah" style="padding-right:5px;">jlauer@chilipeppr.com</a>

                </li>
                <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" style="padding-left:5px;"> <b class="caret"></b></a>

                    <ul class="dropdown-menu">
                        <li><a id="com-chilipeppr-hdr-dd-login" href="javascript:" class="hidden">Login</a>

                        </li>
                        <li><a id="com-chilipeppr-hdr-dd-logout" href="http://www.chilipeppr.com/_ah/logout?continue=https://www.google.com/accounts/Logout%3Fcontinue%3Dhttps://appengine.google.com/_ah/logout%253Fcontinue%253Dhttp://www.chilipeppr.com/%26service%3Dah">Logout</a>

                        </li>
                        <!-- <li><a id="com-chilipeppr-hdr-dd-yourws" href="javascript:">Your Workspaces</a>
                        
                        </li> -->
                        <li class="divider"></li>
                        <li><a href="javascript:" id="com-chilipeppr-topbar-menu-editboot">Edit Boot Javascript</a>

                        </li>
                        <li class="divider"></li>
                        <li><a href="javascript:" id="com-chilipeppr-topbar-menu-forkws">Fork Boot Script</a>

                        </li>
                        <!-- <li><a href="javascript:">Create New Workspace</a>
                        
                        </li> -->
                    </ul>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>
<!-- Workspace Picker Modal -->
<!-- Modal -->
<div class="modal fade" id="com-chilipeppr-hdr-wspickmodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                 <h4 class="modal-title" id="myModalLabel">Workspace Picker</h4>

            </div>
            <div class="modal-body" id="com-chilipeppr-hdr-modalbody">...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" data-original-title="" title="">Close</button>
                <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
            </div>
        </div>
    </div>
</div>
<!-- End Workspace Picker Modal -->
<!-- Edit Boot Javascript Modal -->
<div class="modal fade" id="com-chilipeppr-hdr-editbootmodal" tabindex="-1" role="dialog" aria-labelledby="editboot-myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                 <h4 class="modal-title" id="editboot-myModalLabel">Edit Boot Javascript</h4>

            </div>
            <div class="modal-body" id="com-chilipeppr-hdr-editbootmodalbody"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/uNALR/show/light/ -->




<style type="text/css">
    .modal-body #com-chilipeppr-widget-editbootscript-body {
    padding:0;
}
#com-chilipeppr-widget-editbootscript-body .alert {
    margin-top:0;
}
  </style>
  


  <div id="com-chilipeppr-widget-editbootscript-body" class="panel-body">
    <form role="form">
        <div class="form-group">
            <div id="forking-panel" class="well hidden"></div>
            <div class="alert alert-warning hidden"></div>
            <label for="inputUrl">URL</label>
            <table>
                <tbody><tr>
                    <td>http://chilipeppr.com/&nbsp;</td>
                    <td>
                        <input type="text" class="form-control" id="com-chilipeppr-widget-editbootscript-inputUrl" placeholder="Pick your URL">
                    </td>
                </tr>
            </tbody></table>
        </div>
        <div class="form-group">
            <label for="com-chilipeppr-widget-editbootscript-inputScript">Base Boot Javascript</label>
            <textarea id="com-chilipeppr-widget-editbootscript-inputScript" class="form-control" rows="5"></textarea>
        </div>
        <div id="com-chilipeppr-widget-editbootscript-inputScriptExample" class="hidden">// Sample Base Boot Javascript
// ----------------------
// You should create a JSFiddle that loads your content 
// by forking an existing workspace to get started. Then 
// you can also fork any widgets, elements, or other 
// JSFiddles that you need to modify so that others can 
// benefit from your modifications.
            
// The chilipeppr.load() method is used to load a 
// JSFiddle and inject it's HTML (inluding its 
// CSS/Javascript) into a DOM element. The first 
// parament must be the HTML ID of the DOM element.
chilipeppr.load("pnlWorkspace",
     // Edit URL below to your JSFiddle
    "http://fiddle.jshell.net/myfiddlenuser/n3DLs/show/light/", function() {
		
        console.log("My workspace done loading.");
            
        // This is an example of publishing to the flash message 
        // feature that is loaded by the root panel. Chilipeppr 
        // Hardware Fiddle recommends you loosely couple your 
        // widgets/elements by using the pubsub calls built 
        // into the top-level chilipeppr object.
        // Parameters: pubsub-channel (string), title (string), body (string)
        chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "My Workspace Loaded", "I just loaded my workspace.");
            
        // You can run other code here once your workspace is loaded
        // however it's more likely you will run init() code inside each
        // of your widgets inside your workspace JSFiddle rather than here
    }
);</div>
        <button id="com-chilipeppr-widget-editbootscript-submitBtn" class="btn btn-primary pull-right" data-original-title="" title="">Save Changes</button>
    </form>
</div>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine('inline:com-chilipeppr-widget-editbootscript', ['chilipeppr_ready'], function () {

    return {

        id: 'com-chilipeppr-widget-editbootscript',
        url: "http://fiddle.jshell.net/chilipeppr/uNALR/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/uNALR/",
        name: "Widget / Edit Boot Javascript",
        desc: "This widget lets you define your base Javascript that gets executed when your URL is entered. The root panel is loaded first by ChiliPeppr and then you can load your own content in the body area. Your code is only executed once the root panel is loaded.",
        publish: [''],
        subscribe: [''],
        isForkMode: false,

        init: function () {
            this.isForkMode = false;
            this.urlSetup();
            this.formSetup();
            var url = this.extractUrl();
            var forkDom = $('#com-chilipeppr-widget-editbootscript-body #forking-panel');
            forkDom.addClass("hidden");
            //if (!url) url = "asdf";
            if (url) {
                // perform submit
                this.urlSubmit();
            } else {
                // this is root
                var that = this;
                this.urlSubmit(null, function() {
                    if (!that.isForkMode) {
                        var warningDom = $('#com-chilipeppr-widget-editbootscript-body .alert');
                        warningDom.text("This is the root URL. You may not edit it, but you may copy the Javascript for your own Hardware Fiddle. It would be best to fork the workspace in JSFiddle and modify your boot script to reference your new fork.");
                    }
                });
            }                
                
        },
        doFork: function() {
            console.log("entering fork mode");
            this.isForkMode = true;
            // we're letting the user pick a new url, but copying the javascript
            // from the current page
            var forkDom = $('#com-chilipeppr-widget-editbootscript-body #forking-panel');
            forkDom.removeClass("hidden");
            forkDom.text("We are going to fork this current boot script for you. Please pick a new URL for your workspace, keep or edit the Javascript, and then hit Save Changes. The Base Boot Javascript contains the code for the current page " + this.extractUrl("(root)") + " that you are on. You'll notice the base Javascript loads an external URL (which is most likely a JSFiddle). You should navigate directly to that URL in another tab and fork it. Then place a URL to your new code in this boot script."); 
        },
        extractUrl: function(ifNullStr) {
            // read the window.location to extract the url for this fiddle
            console.log("window.location", window.location.pathname);
            var path = window.location.pathname;
            if (path == "/_display/") {
                // we're inside jsfiddle, so ignore
                //return "(inside jsfiddle)";
                path = null;
            } else {
                path = path.replace(/^\//, "");
                path = path.replace(/\/$/, "");
                //return path;
            }
            if (ifNullStr && path == null) path = ifNullStr;
            return path;
        },
        copyExampleJscript: function() {
            var jscriptDom = $('#com-chilipeppr-widget-editbootscript-inputScript');
            var jscriptExampleDom = $('#com-chilipeppr-widget-editbootscript-inputScriptExample');
            jscriptDom.val(jscriptExampleDom.text());
        },
        urlSetup: function () {
            var that = this;
            $('#com-chilipeppr-widget-editbootscript-inputUrl').blur(function(e) { 
                that.urlSubmit(e); 
            });
            var url = this.extractUrl();
            console.log("url for this fiddle", url);
            if (url) {
                $('#com-chilipeppr-widget-editbootscript-inputUrl').val(url);
            }
        },
        urlSubmit: function (e, callback) {
            var that = this;
            if (e) e.preventDefault();
            console.log("url submit. e:", e, " isForkMode:", this.isForkMode);
            var warningDom = $('#com-chilipeppr-widget-editbootscript-body .alert');
            var jscriptDom = $('#com-chilipeppr-widget-editbootscript-inputScript');
            var jscriptExampleDom = $('#com-chilipeppr-widget-editbootscript-inputScriptExample');
            warningDom.removeClass("hidden");
            warningDom.text("Checking URL availability...");
            var userUrl = $('#com-chilipeppr-widget-editbootscript-inputUrl').val();
            console.log("user url:", userUrl);
            var jqxhr = $.getJSON("http://www.chilipeppr.com/dataget?key=userUrl:" + userUrl + "&callback=?")
                .done(function (data) {
                    console.log("got jsnop callback", data);
                    if (data.KeyExists != undefined && data.KeyExists == false) {
                        warningDom.removeClass("alert-warning");
                        warningDom.addClass("alert-info");
                        if (that.isForkMode) {
                            warningDom.text("URL is available for your use. Since we're in forking mode, the base boot Javascript is a copy of the script used on this page and you may keep it or edit it for your new workspace.");
                        } else {
                            warningDom.text("URL is available for your use. Showing you sample Javascript for your boot script.");
                            jscriptDom.val(jscriptExampleDom.text());
                        }
                    } else if (data.Error && data.Error == true) {
                        warningDom.removeClass("alert-info");
                        warningDom.addClass("alert-warning");
                        warningDom.text(data.Msg);
                    } else {
                        // this url is taken, but see if we own it
                        var jqxhr = $.getJSON("http://www.chilipeppr.com/datalogin?callback=?")
                        .done(function (logindata) {
                            console.log("logindata", logindata);
                            if (logindata.CurrentUser != undefined && logindata.CurrentUser != null) {
                                console.log("user logged in ", logindata.CurrentUser);
                                if (data.User == logindata.CurrentUser.Email) {
                                    warningDom.removeClass("alert-warning");
                                    warningDom.addClass("alert-info");
                                    warningDom.text("You own this URL, so you can edit the base boot Javascript.");
                                } else {
                                    warningDom.removeClass("alert-info");
                                    warningDom.addClass("alert-warning");
                                    warningDom.text("This URL is taken by another user already, so you may not use it.");
                                }
                            } else {
                                console.log("user NOT logged in");
                                warningDom.removeClass("alert-info");
                                warningDom.addClass("alert-warning");
                                warningDom.text("You must be logged in to create/edit a URL and edit the base boot Javascript.");
                            }
                            if (callback) callback.apply(null);
                        })
                        
                        //warningDom.text("URL is available. " + JSON.stringify(data));
                        // place jscript into box (everything is public)
                        jscriptDom.val(data.Value);
                    }
                })
                .fail(function (data) {
                    console.log("failed. data:", data);
                    warningDom.text("Failed to execute Ajax call. Huh?");
                })
        },
        formSetup: function() {
            $('#com-chilipeppr-widget-editbootscript-submitBtn').click(this.formSubmit);
            $('#com-chilipeppr-widget-editbootscript-body input,select').keypress(function(event) { return event.keyCode != 13; });
        },
        formSubmit: function (e) {
            console.log("e:", e);
            e.preventDefault();
            console.log("form submit");
            var warningDom = $('#com-chilipeppr-widget-editbootscript-body .alert');
            warningDom.text("Submitting form...");
            var userUrl = $('#com-chilipeppr-widget-editbootscript-inputUrl').val();
            var userScript = $('#com-chilipeppr-widget-editbootscript-inputScript').val();
            console.log("user url:", userUrl);
            console.log("user script:", userScript);
            var jqxhr = $.getJSON("http://www.chilipeppr.com/dataput?callback=?", { key: "userUrl:" + userUrl, val: userScript })
                .done(function (data) {
                console.log("got jsnop callback", data);
                if (data.Error && data.Error == true) {
                    warningDom.text(data.Msg);
                } else {
                    //warningDom.text("Successfully saved record. " + JSON.stringify(data));
                    warningDom.html("Successfully saved URL and base boot script. Navigate to your new workspace <a href=\"http://chilipeppr.com/" + userUrl + "\">http://chilipeppr.com/" + userUrl + "</a>");
                }
            })
                .fail(function (data) {
                console.log("failed. data:", data);
                warningDom.text("Failed to execute Ajax call. Huh?");
            })
        },
        checkLogin: function () {
            var jqxhr = $.getJSON("http://www.chilipeppr.com/datalogin?callback=?")
            .done(function (data) {
                console.log(data);
                if (data.CurrentUser != undefined && data.CurrentUser != null) {
                    console.log("user logged in ", data.CurrentUser);
                } else {
                    console.log("user NOT logged in");
                }
            })
            .fail(function () {
            })
        },
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/uNALR/show/light/ -->
</div>
            <div class="modal-footer hidden">
                <button type="button" class="btn btn-default" data-dismiss="modal" data-original-title="" title="">Close</button>
                <button type="button" class="btn btn-primary" data-original-title="" title="">Save changes</button>
            </div>
        </div>
    </div>
</div>
<!-- End Edit Boot Javascript Modal -->
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/7aX6x/show/light/ -->
</div>
<div id="pnlBody">
    <div class="container-fluid">
        <div class="row">
            <!-- Flash Message -->
            <div id="com-chilipeppr-flash"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/jlauer/qp7Em/show/light/ -->




<style type="text/css">
    .com-chilipeppr-elem-flashmsg .popover .arrow {
    display:none;
}

.com-chilipeppr-elem-flashmsg .popover {
    max-width: none;
}
  </style>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-elem-flashmsg", ["chilipeppr_ready"], function () {
    //console.log("Inside of define for com-chilipeppr-elem-flashmsg");
    return {
        id: "com-chilipeppr-elem-flashmsg",
        url: "http://fiddle.jshell.net/jlauer/qp7Em/show/light/",
        fiddleurl: "http://jsfiddle.net/jlauer/qp7Em/",
        name: "Element / Flash Messsage",
        desc: "This element shows a flash message at the top of the browser.",
        publish: null,
        subscribe: "/com-chilipeppr-elem-flashmsg/flashmsg",
        queue: [],
        init: function () {
            //console.log("init called");
            chilipeppr.subscribe(this.subscribe, this, this.showQueue);
        },
        showQueue: function(title, body, delay) {
            if (this.isShowing) {
                // queue it
                //console.log("msg showing. so queueing");
                this.queue.push({title: title, body: body, delay: delay});
            } else {
                // show immediately
                this.show.apply(this, arguments);
            }
            
        },
        show: function (title, body, delay) {
            this.isShowing = true;
            this.title = title;
            this.body = body;
            this.delay = 3000;
            if (delay) this.delay = delay;
            if (arguments.length == 1) {
                // they just want a body
                this.title = "";
                this.body = title;
            }
            $(".com-chilipeppr-elem-flashmsg").popover({
                animation: true,
                trigger: 'manual',
                title: this.title,
                content: this.body,
                container: ".com-chilipeppr-elem-flashmsg",
                delay: 0,
                html: true
            });
            $(".com-chilipeppr-elem-flashmsg").popover('show');
            //console.log(this);
            //console.log(this.delay);
            var that = this;
            setTimeout(function(){that.hide.apply(that,null)}, this.delay);
        },
        hide: function () {
            $(".com-chilipeppr-elem-flashmsg").popover('destroy');
            this.isShowing = false;
            //console.log(this);
            //console.log(this.queue);
            if (this.queue.length > 0) {
                // there's a msg in the queue. show it.
                var msg = this.queue.shift();
                this.show(msg.title, msg.body, msg.delay);
            }
        }
    };
});

//]]>  

</script>




  <div class="com-chilipeppr-elem-flashmsg" data-container="body" data-toggle="popover" data-placement="auto" data-original-title="" title=""><div class="popover fade bottom in" style="display: block; top: 62px; left: 454px;"><div class="arrow"></div><h3 class="popover-title">Serial Port System Message</h3><div class="popover-content">Serial port ajax connection closed. readyState: 3</div></div></div>
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/jlauer/qp7Em/show/light/ -->
</div>
            <!-- Main Workspace Area -->
            <div id="pnlWorkspace" class="pnlWorkspaceRtSidebarCollapsed col-xs-12"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/2J3JH/show/light/ -->




<style type="text/css">
    #com-chilipeppr-ws-gcode-wrapper .dropdown-menu {
    /* z-index:6; */
    /* position:inherit; */
}
#com-chilipeppr-ws-gcode-wrapper .panel-heading {
    /* padding: 10px 12px; */
}
#com-chilipeppr-ws-gcode-wrapper .well.com-chilipeppr-ws-hdr {
    /* padding: 10px 15px; */
}
#com-chilipeppr-ws-gcode-dragdrop {
    margin-right:6px;
}
#com-chilipeppr-ws-gcode-hdr {
    margin-bottom:10px;
}
.panel {
    margin-bottom:10px;
}
#com-chilipeppr-ws-gcode-wrapper #com-chilipeppr-widget-gcode-body {
    /* max-height:250px; */
    height:100px;
}
#com-chilipeppr-ws-gcode-wrapper .com-chilipeppr-widget-spconsole {
    margin-bottom:0;
}
#com-chilipeppr-ws-gcode-dragdropoverlay {
    position: absolute;
    top:0;
    bottom:0;
    left:0;
    right:0;
    z-index:10;
    background-color: rgba(255, 255, 255, 0.5);
    font-size: 20px;
    padding:100px;
    border: 3px dashed #3276b1;
    text-align:center;
    pointer-events: none;
}
#com-chilipeppr-ws-gcode-dragdropoverlay .well {
    background-color: rgba(127, 127, 127, 0.5);
}
#com-chilipeppr-ws-gcode-wrapper.hover {
    /* background-color: blue; */
}
.com-chilipeppr-elem-dragdrop {
    border: 1px dashed gray;
    border-radius: 4px;
    padding:0 6px;
}
.padrt {
    padding-right:10px;
}
.zhigh {
    /* z-index:5; */
    position:relative;
}
#com-chilipeppr-ws-gcode-wrapper .dropdown-menu {
    /* z-index:20; */
}
#mainnav {
    z-index:5;
}
.nopadding {
    padding:0;
}
#com-chilipeppr-widget-3dviewer .panel-heading, #com-chilipeppr-3dviewer-controlpanel .panel-heading {
    background:none;
    /* border:none; */
    padding:10px 15px;
    margin-bottom:0;
}
#com-chilipeppr-3dviewer-controlpanel {
    padding:0 10px;
    float:left;
}
#com-chilipeppr-gcode-list {
    /* padding-right: 10px; */
    /* z-index:5; */
    /* position: relative; */
}
#com-chilipeppr-serialport-ws-hdr {
    /* z-index:5; */
}
.well.com-chilipeppr-ws-hdr {
    padding:10px 15px;
    /* padding:8px; */
    /* padding-left:15px; */
    /* margin:0; */
    /* margin-bottom:10px; */
}
#chilipeppr-3dviewer {
    /* z-index: -1; */
    padding-right:10px;
}
#com-chilipeppr-widget-3dviewer-renderArea {
    /* z-index:0; */
}
.row .widget {
    margin:0;
    padding:0;
}
.dropArea.hover {
    background: #dddddd;
}
#pnlWorkspace.hover {
    background: red;
}
body.hover {
    background: #5bc0de;
}
#chilipeppr-serialport-wrapper .com-chilipeppr-widget-serialport-spselector {
    max-height: none;
}
#chilipeppr-serialport-log {
    /*height:200px;*/
    /* padding-right:10px; */
    /* z-index:5; */
    /* position: relative; */
}
.nomargin {
    margin:0;
}
.noheight {
    height:0;
}
  </style>
  


<script type="text/javascript">//<![CDATA[ 

// Makes sure we only run once jquery is loaded as well
// as ensuring we don't load javascript libraries multiple times
cprequire(["chilipeppr_ready"], function () {

    // Define standard ChiliPeppr objects
    var ws = {
        id: "com-chilipeppr-ws-tinyg",
        url: 'http://jsfiddle.net/chilipeppr/2J3JH/show/light',
        fiddleurl: 'http://jsfiddle.net/chilipeppr/2J3JH/',
        name: "Workspace / TinyG",
        desc: "This is a workspace for ChiliPeppr's Hardware Fiddle. It is geared towards CNC machines using TinyG.",
        foreignSubscribe: {
            "/com-chilipeppr-elem-dragdrop/ondragover" : "The Chilipeppr drag drop element will publish on channel /com-chilipeppr-elem-dragdrop/ondropped when a file is dropped so we subscribe to it so we can load a Gcode file when the user drags it onto the browser. It also adds a hover class to the bound DOM elem so we can add a CSS to hilite on hover",
            "/com-chilipeppr-elem-dragdrop/ondragleave" : "We need to know when the drag is over to remove the CSS hilites.",
            "/com-chilipeppr-widget-gcode/resize" : "We watch if the Gcode viewer resizes so that we can reposition or resize other elements in the workspace. Specifically we ask the Serial Port Console to resize. We also redraw the 3D Viewer so it fills the whole screen."
        },
        foreignPublish: {
        }
    }
            
    // Load top bar elements

    // Element / Drag Drop
    // Load the dragdrop element into workspace toolbar
    // http://jsfiddle.net/chilipeppr/Z9F6G/
    chilipeppr.load("#com-chilipeppr-ws-gcode-dragdrop",
        "http://fiddle.jshell.net/chilipeppr/Z9F6G/show/light/", function () {
        require(["inline:com-chilipeppr-elem-dragdrop"], function (dd) {
            console.log("inside require of dragdrop");
            $('.com-chilipeppr-elem-dragdrop').removeClass('well');
            dd.init();
            // The Chilipeppr drag drop element will publish
            // on channel /com-chilipeppr-elem-dragdrop/ondropped
            // when a file is dropped so subscribe to it
            // It also adds a hover class to the bound DOM elem
            // so you can add CSS to hilite on hover
            dd.bind("#com-chilipeppr-ws-gcode-wrapper", null);
            //$(".com-chilipeppr-elem-dragdrop").popover('show');
            //dd.bind("#pnlWorkspace", null);
            var ddoverlay = $('#com-chilipeppr-ws-gcode-dragdropoverlay');
            chilipeppr.subscribe("/com-chilipeppr-elem-dragdrop/ondragover", function () {
                //console.log("got dragdrop hover");
                ddoverlay.removeClass("hidden");
            });
            chilipeppr.subscribe("/com-chilipeppr-elem-dragdrop/ondragleave", function () {
                ddoverlay.addClass("hidden");
                //console.log("got dragdrop leave");
            });
            console.log(dd);
        });
    });

    // Workspace Menu with Workspace Billboard
    // http://jsfiddle.net/jlauer/yC8Hv/
    chilipeppr.load(
        "#com-chilipeppr-ws-gcode-menu-billboard",
        "http://fiddle.jshell.net/chilipeppr/Guvv4/show/light/");
    chilipeppr.load(
        "http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", 
        function () {
            require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo(
                        $('#com-chilipeppr-ws-gcode-menu .dropdown-menu'), 
                        ws, 
                        "Workspace"
                    );
                });
            });
            

    // 3D Viewer
    // http://jsfiddle.net/chilipeppr/y3HRF
    chilipeppr.load("#com-chilipeppr-3dviewer",
        "http://fiddle.jshell.net/chilipeppr/y3HRF/show/light/",

    function () {
        console.log("got callback done loading 3d");

        cprequire(
        ['inline:com-chilipeppr-widget-3dviewer'],

        function (threed) {
            console.log("Running 3dviewer");
            threed.init();
            console.log("3d viewer initted");
            
            // Ok, do someting whacky. Try to move the 3D Viewer 
            // Control Panel to the center column
            setTimeout(function() {
                var element = $('#com-chilipeppr-3dviewer .panel-heading').detach();
                $('#com-chilipeppr-3dviewer').addClass("noheight");
                $('#com-chilipeppr-widget-3dviewer').addClass("nomargin");
                $('#com-chilipeppr-3dviewer-controlpanel').append(element);
            }, 10);
            
            // listen to resize events so we can resize our 3d viewer
            // this was done to solve the scrollbar residue we were seeing
            // resize this console on a browser resize
            var mytimeout = null;
            $(window).on('resize', function (evt) {
                //console.log("3d view force resize");
                if (mytimeout !== undefined && mytimeout != null) {
                    clearTimeout(mytimeout);
                    //console.log("cancelling timeout resize");
                }
                mytimeout = setTimeout(function() {
                    console.log("3d view force resize. 1 sec later");
                    threed.resize();
                }, 1000);
                
            });
        });

    });

    // Gcode List
    // http://jsfiddle.net/chilipeppr/F2Qn3/
    chilipeppr.load("#com-chilipeppr-gcode-list",
        "http://fiddle.jshell.net/chilipeppr/F2Qn3/show/light/",

    function () {
        cprequire(
        ["inline:com-chilipeppr-widget-gcode"],

        function (gcodelist) {
            gcodelist.init();
        });
    });

    // Serial Port Log Window
    // http://jsfiddle.net/chilipeppr/JB2X7/
    chilipeppr.load("#com-chilipeppr-serialport-log",
        "http://fiddle.jshell.net/chilipeppr/JB2X7/show/light/",

    function () {
        cprequire(
        ["inline:com-chilipeppr-widget-spconsole"],

        function (spc) {
            spc.init(true);
            
            // resize this console on a browser resize
            $(window).on('resize', function (evt) {
                //console.log("serial-port-console. resize evt:", evt);
                if ($.isWindow(evt.target)) {
                    //console.log("resize was window. so resizing");
                    spc.resize();
                } else {
                    //console.log("resize was not window, so ignoring");
                }
            });
            // resize this console if we get a publish
            // from the gcode viewer widget
            chilipeppr.subscribe("/com-chilipeppr-widget-gcode/resize", spc, spc.resize);

        });
    });

    // XYZ
    // http://jsfiddle.net/chilipeppr/gh45j/
    chilipeppr.load(
        "com-chilipeppr-xyz",
        "http://fiddle.jshell.net/chilipeppr/gh45j/show/light/",

    function () {
        cprequire(
        ["inline:com-chilipeppr-widget-xyz"],

        function (xyz) {
            xyz.init();
        });
    });

    // TinyG
    // http://jsfiddle.net/chilipeppr/XxEBZ/
    // com-chilipeppr-tinyg
    chilipeppr.load(
        "com-chilipeppr-tinyg",
        "http://fiddle.jshell.net/chilipeppr/XxEBZ/show/light/",

    function () {
        cprequire(
        ["inline:com-chilipeppr-widget-tinyg"],

        function (tinyg) {
            tinyg.init();
        });
    });
    
    // Serial Port Selector
    // http://jsfiddle.net/chilipeppr/4RgrS/
    chilipeppr.load("com-chilipeppr-serialport-spselector",
        "http://fiddle.jshell.net/chilipeppr/4RgrS/show/light/",

    function () {
        cprequire(
        ["inline:com-chilipeppr-widget-serialport"],

        function (sp) {
            sp.setSingleSelectMode();
            //sp.init("192.168.1.7");
            sp.init();
            //$('.com-chilipeppr-widget-serialport-console').removeClass("hidden");
            //$('.com-chilipeppr-widget-serialport-consoleinput').removeClass("hidden");
            //$('.com-chilipeppr-widget-serialport-status').removeClass("hidden");
        });
    });
    

});
//]]>  

</script>




  <!-- This is the workspace layout for the Gcode Workspace -->
<div id="com-chilipeppr-ws-gcode-wrapper" class="dropArea">
    <div id="com-chilipeppr-ws-gcode-dragdropoverlay" class="hidden">
        <div class="well">Drag and Drop Gcode Files Onto Browser Window</div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-3 widget padrt">
                <!-- 3D Viewer. Must be loaded at top to get z-orders correct -->
                <div id="com-chilipeppr-3dviewer" class="noheight"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/y3HRF/show/light/ -->




<style type="text/css">
    #com-chilipeppr-widget-3dviewer .panel-heading {
    z-index:1;
    position:relative;
}
#com-chilipeppr-widget-3dviewer-body {
    /* height: 350px; */
    padding:0;
    margin:0;
    position: relative;
    border:0px solid red;
    background-color: blue;
}
#com-chilipeppr-widget-3dviewer-renderArea {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    top: 0;
    background-color: #000000;
    /* z-index:0; */
}
button.com-chilipeppr-widget-3d-menu-samplerun, button.com-chilipeppr-widget-3d-menu-samplerunstop {
    /* color: blue; */
}
#com-chilipeppr-widget-3dviewer .disabled .glyphicon {
    color: #dddddd;
}
#com-chilipeppr-widget-3dviewer #warningArea {
    position: absolute;
    top:0;
    left:0;
    padding: 10px;
    font-size: 9px;
    color: white;
}
#com-chilipeppr-widget-3dviewer-infoArea {
    position: absolute;
    bottom:0;
    left:0;
    padding: 10px;
    font-size: 9px;
    color: #333333;
    /* background-color: black; */
}
#com-chilipeppr-widget-3dviewer-infoArea .info {
    position: absolute;
    bottom:0;
    left:0;
    color: blue;
    background-color:red;
}
#com-chilipeppr-widget-3dviewer-renderArea .data-details {
    position: absolute;
    bottom:0;
    left:10;
    /* background-color: transparent; */
    color: #333333;
    padding: 10px;
    font-size: 9px;
}
  </style>
  


  <div id="com-chilipeppr-widget-3dviewer" class="panel panel-default nomargin" style="float:left;">
    
    <div id="com-chilipeppr-widget-3dviewer-body" class="panel-body">
        <!-- WebGL rendering area -->
        <div id="com-chilipeppr-widget-3dviewer-renderArea">
            <div class="data-details">Drag and Drop Gcode Here...</div>
        <canvas width="1245" height="526" style="width: 1245px; height: 526px;"></canvas></div>
        <div id="warningArea">
            <div class="alert alert-warning alert-dismissable hidden">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>G2/G3 arcs only rendered as straight lines. They are yellow to show where actual positioning in your CNC will differ from 3D rendering. If anyone wants to fork and fix arcs, feel free.</div>
            
        </div>
<!--         <div id="com-chilipeppr-widget-3dviewer-infoArea">
            <div class="info">
            2,345 gcode lines
            </div>
            4,534 gcode lines
        </div>
         -->    </div>
</div>
  


<script type="text/javascript">//<![CDATA[ 

requirejs.config({
    paths: {
        Three: 'http://threejs.org/build/three.min',
        ThreeDetector: 'http://threejs.org/examples/js/Detector',
        ThreeStats: 'http://threejs.org/examples/js/libs/stats.min',
        ThreeTrackballControls: '//threejs.org/examples/js/controls/TrackballControls',
        ThreeOrbitControls: '//threejs.org/examples/js/controls/OrbitControls',
        ThreeHelvetiker: 'https://mrdoob.github.com/three.js/examples/fonts/helvetiker_regular.typeface',
        ThreeTypeface: 'https://superi.googlecode.com/svn-history/r1953/trunk/MBrand/MBrand/Scripts/typeface-0.15',
        //ThreeTween: 'https://raw.githubusercontent.com/sole/tween.js/master/build/tween.min',
        ThreeTween: 'http://www.chilipeppr.com/js/three/tween.min',
        ThreeSparks: 'https://raw.githubusercontent.com/zz85/sparks.js/master/Sparks',
        ThreeParticle: 'https://raw.githubusercontent.com/squarefeet/ShaderParticleEngine/master/build/ShaderParticles.min'
    },
    shim: {
        ThreeTrackballControls: ['Three'],
        ThreeTween: ['Three'],
        ThreeSparks: ['Three'],
        ThreeParticle: ['Three']
    }
});

cpdefine('inline:com-chilipeppr-widget-3dviewer', ['chilipeppr_ready', 'Three', 'ThreeDetector', 'ThreeTrackballControls', 'ThreeTween'], function () {

    return {

        id: 'com-chilipeppr-widget-3dviewer',
        url: "http://fiddle.jshell.net/chilipeppr/y3HRF/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/y3HRF/",
        name: "Widget / 3D GCode Viewer",
        desc: "Visualize your GCode in 3D by simulating your GCode run or seeing where your run is at in 3D while your CNC operation is in action.",
        publish: {},
        subscribe: {
            '/gotoline': "This widget subscribes to this channel so other widgets can move the toolhead and highlight the Gcode line being worked on. This would mostly be when sending Gcode from a Gcode viewer/sender widget, that widget can have the 3D view follow along. Just the line number should be sent as the 3D viewer has it's own cache of the Gcode data loaded.",
            '/resize' : "You can ask this widget to resize itself. It will resize the rendering area to the region it is bound to (typically the window width/height)."
        },
        foreignSubscribe: {
            "/com-chilipeppr-interface-cnccontroller/axes" : "If we see this signal come in, we move the toolhead to the xyz position in the payload of the signal.",
            "/com-chilipeppr-elem-dragdrop/ondropped" : "When a user drags and drops a file to the main window, we want to get notified so we can load it into the 3D viewer. During development mode in JSFiddle, this widget loads it's own com-chilipeppr-elem-dragdrop so you can test development, but when this widget is loaded in a full ChiliPeppr app it uses the global com-chilipeppr-elem-dragdrop."
        },
        //foreignPublish: {
        //},
        scene: null,
        object: null,
        camera: null,
        controls: null,
        toolhead: null,
        tween: null,
        tweenHighlight: null,
        tweenIndex: null,
        tweenSpeed: 1,
        tweenPaused: false,
        tweenIsPlaying: false,
        wantAnimate: true, // we automatically timeout rendering to save on cpu
        initOptions: {},
        init: function (initOptions) {
            this.initOptions = initOptions;
            var that = this;
            /*
            if (!Modernizr.webgl) {
                alert('Sorry, you need a WebGL capable browser to use this.\n\nGet the latest Chrome or FireFox.');
                return;
            }

            if (!Modernizr.localstorage) {
                alert("Man, your browser is ancient. I can't work with this. Please upgrade.");
                return;
            }
            */

            // Show 'About' dialog for first time visits.
            /*
            if (!localStorage.getItem("not-first-visit")) {
                localStorage.setItem("not-first-visit", true);
                setTimeout(about, 500);
            }
            */

            // Drop files from desktop onto main page to import them.
            // We also can subscribe to the main chilipeppr drag/drop
            // pubsub to get drop events from a parent, rather than doing
            // this on our own
            
            // subscribe to file load events
            chilipeppr.subscribe("/com-chilipeppr-elem-dragdrop/ondropped", this, this.onPubSubFileLoaded);
            
            if (this.initOptions && this.initOptions.doMyOwnDragDrop) {
                $('body').on('dragover', function (event) {
                    event.stopPropagation();
                    event.preventDefault();
                    event.originalEvent.dataTransfer.dropEffect = 'copy'
                }).on('drop', function (event) {
                    console.log("got drop:", event);
                    event.stopPropagation();
                    event.preventDefault();
                    var files = event.originalEvent.dataTransfer.files;
                    if (files.length > 0) {
                        var reader = new FileReader();
                        reader.onload = function () {
                            console.log("opening file. reader:", reader);
                            that.openGCodeFromText(reader.result);
                        };
                        reader.readAsText(files[0]);
                    }
                });
            }
            
            that.scene = that.createScene($('#com-chilipeppr-widget-3dviewer-renderArea'));
            var lastImported = localStorage.getItem('last-imported');
            var lastLoaded = localStorage.getItem('last-loaded');
            if (lastImported) {
                that.openGCodeFromText(lastImported);
            } else {
                //console.log("would have opened octocat");
                //that.openGCodeFromPath(lastLoaded || 'examples/octocat.gcode');
                console.log("loading chilipeppr logo");
                that.openGCodeFromPath(lastLoaded || 'http://www.chilipeppr.com/3d/chilipepprlogo.nc');
            }

            // setup toolbar buttons
            this.btnSetup();
            
            this.forkSetup();
            //this.setDetails("blah");
            
            // subscribe to gotoline signal so we can move toolhead to correct location
            // to sync with the gcode sender
            chilipeppr.subscribe('/' + this.id + '/gotoline', this, this.gotoLine);

            // subscribe to gotoline signal so we can move toolhead to correct location
            // to sync with the actual milling machine
            chilipeppr.subscribe('/com-chilipeppr-interface-cnccontroller/axes', this, this.gotoXyz);
            
            // we can be asked to resize ourself by a publish call to this signal
            chilipeppr.subscribe('/' + this.id + '/resize', this, this.resize);

        },
        btnSetup: function() {
            
            // attach button bar features
            var that = this;
            this.isLookAtToolHeadMode = true;
            $('.com-chilipeppr-widget-3d-menu-lookattoolhead').click(function () {
                if (that.isLookAtToolHeadMode) {
                    // turn off looking at toolhead
                    that.isLookAtToolHeadMode = false;
                    $('.com-chilipeppr-widget-3d-menu-lookattoolhead').removeClass("active btn-primary");
                } else {
                    // turn on looking at toolhead
                    that.isLookAtToolHeadMode = true;
                    that.lookAtToolHead();
                    $('.com-chilipeppr-widget-3d-menu-lookattoolhead').addClass("active btn-primary");
                }                    
            });
            $('.com-chilipeppr-widget-3d-menu-viewextents').click(function () {
                that.viewExtents()
            });
            $('.com-chilipeppr-widget-3d-menu-samplerun').click(function () {
                that.playSampleRun()
            });
            $('.com-chilipeppr-widget-3d-menu-samplerunstop').click(function () {
                that.stopSampleRun()
            });
            $('.com-chilipeppr-widget-3d-menu-samplerunspeed').click(function () {
                that.speedUp()
            });
            $('.com-chilipeppr-widget-3d-menu-samplerunpause').click(function () {
                that.pauseSampleRun()
            }).prop('disabled', true);
            $('.com-chilipeppr-widget-3d-menu-samplerunstop').prop('disabled', true);
            $('.btn').popover({
                animation: true,
                placement: "auto",
                trigger: "hover"
            });
        },
        forkSetup: function () {
            //$('#com-chilipeppr-widget-3dviewer .fork').prop('href', this.fiddleurl);
            //$('#com-chilipeppr-widget-3dviewer .standalone').prop('href', this.url);
            //var t = $('#com-chilipeppr-widget-3dviewer .fork-name');
            //t.html(this.id);
            $('#com-chilipeppr-widget-3dviewer .panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true
            });
            
            // load the pubsub viewer / fork element which decorates our upper right pulldown
            // menu with the ability to see the pubsubs from this widget and the forking links
            var that = this;
            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($('#com-chilipeppr-widget-3dviewer-dropdown'), that);
                });
            });

            //console.log("title in menu", t);
        },
        onPubSubFileLoaded: function(txt) {
            this.openGCodeFromText(txt);
        },
        error: function (msg) {
            alert(msg);
        },
        loadFile: function (path, callback /* function(contents) */ ) {
            var that = this;
            $.get(path, null, callback, 'text')
                .error(function () {
                that.error()
            });
        },
        setDetails: function(txt) {
            $('#com-chilipeppr-widget-3dviewer-renderArea .data-details').text(txt);
        },
        speedUp: function () {
            //var txt = $('.com-chilipeppr-widget-3d-menu-samplerunspeed').text();
            console.log("speedUp. tweenSpeed:", this.tweenSpeed);
            //var s = this.tweenSpeed;
            this.tweenSpeed = this.tweenSpeed * 10;
            if (this.tweenSpeed > 1024) this.tweenSpeed = 1;
            var txt = "x" + this.tweenSpeed;
            $('.com-chilipeppr-widget-3d-menu-samplerunspeed').text(txt);
        },
        openGCodeFromPath: function (path) {
            var that = this;
            //$('#openModal').modal('hide');
            if (that.object) {
                //TWEEN.removeAll();
                this.stopSampleRun();
                that.scene.remove(that.object);
            }
            that.loadFile(path, function (gcode) {
                that.object = that.createObjectFromGCode(gcode);
                that.scene.add(that.object);
                that.viewExtents();
                localStorage.setItem('last-loaded', path);
                localStorage.removeItem('last-imported');
            });
        },
        openGCodeFromText: function (gcode) {
            console.log("openGcodeFromText");
            this.wakeAnimate();
            //$('#openModal').modal('hide');
            if (this.object) {
                //TWEEN.removeAll();
                this.stopSampleRun();
                this.scene.remove(this.object);
            }
            this.object = this.createObjectFromGCode(gcode);
            console.log("done creating object:", this.object);
            this.scene.add(this.object);
            //this.lookAtCenter();
            this.viewExtents();
            this.setDetails(this.object.userData.lines.length + " GCode Lines");
            this.wakeAnimate();
            localStorage.setItem('last-imported', gcode);
            localStorage.removeItem('last-loaded');
        },
        lookAtCenter: function () {
            // this method makes the trackball controls look at center of gcode object
            this.controls.target.x = this.object.userData.center2.x;
            this.controls.target.y = this.object.userData.center2.y;
            this.controls.target.z = this.object.userData.center2.z;
        },
        isLookAtToolHeadMode: false,
        lookAtToolHead: function () {
            // this method makes the trackball controls look at the tool head
            //console.log("lookAtToolHead. controls:", this.controls, "toolhead:", this.toolhead);
            if (this.isLookAtToolHeadMode) {
                this.controls.target.x = this.toolhead.position.x;
                this.controls.target.y = this.toolhead.position.y;
                this.controls.target.z = this.toolhead.position.z - 20;
            }
        },
        toCameraCoords: function (position) {
            return this.camera.matrixWorldInverse.multiplyVector3(position.clone());
        },
        scaleInView: function () {
            // NOT WORKING YET
            var tmp_fov = 0.0;

            for (var i = 0; i < 8; i++) {
                proj2d = this.toCameraCoords(boundbox.geometry.vertices[i]);

                angle = 114.59 * Math.max( // 2 * (Pi / 180)
                Math.abs(Math.atan(proj2d.x / proj2d.z) / this.camera.aspect),
                Math.abs(Math.atan(proj2d.y / proj2d.z)));
                tmp_fov = Math.max(tmp_fov, angle);
            }

            this.camera.fov = tmp_fov + 5; // An extra 5 degrees keeps all lines visible
            this.camera.updateProjectionMatrix();
        },
        viewExtents: function () {
            console.log("viewExtents. object.userData:", this.object.userData);
            console.log("controls:", this.controls);
            this.wakeAnimate();
            var ud = this.object.userData;
            //this.controls.enabled = false;
            this.controls.reset();
            //this.controls.object.rotation._x = 0.5;
            //this.controls.object.rotation._y = 0.5;
            //this.controls.object.rotation._z = 0.5;
            //this.controls.object.rotation = THREE.Euler(0.5, 0.5, 0.5);
            //this.controls.object.setRotationFromEuler(THREE.Euler(0.5,0.5,0.5));

            // get max of any of the 3 axes to use as max extent
            var lenx = Math.abs(ud.bbbox2.min.x) + ud.bbbox2.max.x;
            var leny = Math.abs(ud.bbbox2.min.y) + ud.bbbox2.max.y;
            var lenz = Math.abs(ud.bbbox2.min.z) + ud.bbbox2.max.z;
            var maxlen = Math.max(lenx, leny, lenz);
            var dist = 2 * maxlen;
            // center camera on gcode objects center pos, but twice the maxlen
            this.controls.object.position.x = ud.center2.x;
            this.controls.object.position.y = ud.center2.y;
            this.controls.object.position.z = ud.center2.z + dist;
            this.controls.target.x = ud.center2.x;
            this.controls.target.y = ud.center2.y;
            this.controls.target.z = ud.center2.z;
            console.log("maxlen:", maxlen, "dist:", dist);
            var fov = 2.2 * Math.atan(maxlen / (2 * dist)) * (180 / Math.PI);
            console.log("new fov:", fov, " old fov:", this.controls.object.fov);
            this.controls.object.fov = fov;
            //this.controls.object.setRotationFromEuler(THREE.Euler(0.5,0.5,0.5));
            //this.controls.object.rotation.set(0.5,0.5,0.5,"XYZ");
            //this.controls.object.rotateX(2);
            //this.controls.object.rotateY(0.5);
            
            var L = dist;
            var camera = this.controls.object;
            var vector = controls.target.clone();
            var l = (new THREE.Vector3()).subVectors(camera.position, vector).length();
            var up = camera.up.clone();
            var quaternion = new THREE.Quaternion();
            
            // Zoom correction
            camera.translateZ(L - l);
            console.log("up:", up);
            up.y = 1; up.x = 0; up.z = 0;
            quaternion.setFromAxisAngle(up, 0.5);
            //camera.position.applyQuaternion(quaternion);
            up.y = 0; up.x = 1; up.z = 0;
            quaternion.setFromAxisAngle(up, 0.5);
            camera.position.applyQuaternion(quaternion);
            up.y = 0; up.x = 0; up.z = 1;
            quaternion.setFromAxisAngle(up, 0.5);
            //camera.position.applyQuaternion(quaternion);
            
            camera.lookAt(vector);
                        
            //this.camera.rotateX(90);
            
            this.controls.object.updateProjectionMatrix();
            //this.controls.enabled = true;
            //this.scaleInView();
            //this.controls.rotateCamera(0.5);
            //this.controls.noRoll = true;
            //this.controls.noRotate = true;
        },
        stopSampleRun: function (evt) {
            console.log("stopSampleRun. tween:", this.tween);
            this.tweenIsPlaying = false;
            //this.tween.stopChainedTweens();
            //console.log("_onCompleteCallback:", this.tween._onCompleteCallback);
            //this.tween._onCompleteCallback.apply(this.tween, null);
            if (this.tweenHighlight) this.scene.remove(this.tweenHighlight);
            if (this.tween) this.tween.stop();
            //TWEEN.stopChainedTweens();
            //TWEEN.removeAll();
            //TWEEN.stop();
            $('.com-chilipeppr-widget-3d-menu-samplerun').prop('disabled', false);
            $('.com-chilipeppr-widget-3d-menu-samplerunstop').prop('disabled', true);
            $('.com-chilipeppr-widget-3d-menu-samplerunstop').popover('hide');
            this.animAllowSleep();
        },
        pauseSampleRun: function () {
            console.log("pauseSampleRun");
            if (this.tweenPaused) {
                // the tween was paused, it's being non-paused
                console.log("unpausing tween");
                this.animNoSleep();
                this.tweenIsPlaying = true;
                this.tweenPaused = false;
                this.playNextTween();
            } else {
                console.log("pausing tween on next playNextTween()");
                this.tweenIsPlaying = false;
                this.tweenPaused = true;
                this.animAllowSleep();
            }
        },
        gotoXyz: function(data) {
            // we are sent this command by the CNC controller generic interface
            console.log("gotoXyz. data:", data);
            this.animNoSleep();
            this.tweenIsPlaying = false;
            this.tweenPaused = true;
            
            if ('x' in data && data.x != null) this.toolhead.position.x = data.x;
            if ('y' in data && data.y != null) this.toolhead.position.y = data.y;
            if ('z' in data && data.z != null) this.toolhead.position.z = data.z + 20;
            this.lookAtToolHead();
            this.animAllowSleep();
        },
        gotoLine: function(data) {
            // this method is sort of like playNextTween, but we are jumping to a specific
            // line based on the gcode sender
            console.log("got gotoLine. data:", data);
            //this.stopSampleRun();
            //this.tweenPaused = false;
            //this.pauseSampleRun();
            this.animNoSleep();
            this.tweenIsPlaying = false;
            this.tweenPaused = true;
            
            var lines = this.object.userData.lines;
            console.log("userData.lines:", lines[data.line]);
            var curLine = lines[data.line];
            var curPt = curLine.p2;
            //if (false && lines[data.line].p2) curPt = lines[data.line].p2;
            //else curPt = {x:0,y:0,z:0};
            console.log("p2 for toolhead move. curPt:", curPt);
            this.toolhead.position.x = curPt.x;
            this.toolhead.position.y = curPt.y;
            this.toolhead.position.z = curPt.z + 20;
            this.lookAtToolHead();
            this.animAllowSleep();
            
            /* GOOD STUFF BUT IF DON'T WANT ANIM*/
            if (this.tweenHighlight) this.scene.remove(this.tweenHighlight);
            if (this.tween) this.tween.stop();
            if (data.anim && data.anim == "anim") {
                console.log("being asking to animate gotoline");
                this.animNoSleep();
                this.tweenPaused = false;
                this.tweenIsPlaying = true;
                this.tweenIndex = data.line;
                this.playNextTween(true);
            }
        },
        playNextTween: function (isGotoLine) {

            if (this.tweenPaused) return;
            
            //this.wakeAnimate();

            var that = this;
            var lines = this.object.userData.lines;
            if (this.tweenIndex + 1 > lines.length - 1) {
                // done tweening
                console.log("Done with tween");
                this.stopSampleRun();
                return;
            }

            var lineMat = new THREE.LineBasicMaterial({
                color: 0xff0000,
                lineWidth: 1,
                transparent: true,
                opacity: 1,
            });

            // find next correct tween, i.e. ignore fake commands
            var isLooking = true;
            var indxStart = this.tweenIndex + 1;
            //console.log("starting while loop");
            while(isLooking) {
                if (indxStart > lines.length - 1) {
                    console.log("we are out of lines to look at");
                    that.stopSampleRun();
                    return;
                }
                if (lines[indxStart].args.isFake) {
                    // this is fake, skip it
                    //console.log("found fake line at indx:", indxStart);
                } else {
                    // we found a good one. use it
                    //console.log("found one at indx:", indxStart);
                    isLooking = false;
                    break;
                }
                indxStart++;
            }
            var ll;
            if (lines[this.tweenIndex].p2) ll = lines[this.tweenIndex].p2;
            else ll = {x:0,y:0,z:0};
            console.log("start line:", lines[this.tweenIndex], "ll:", ll);
            
            this.tweenIndex = indxStart;
            var cl = lines[this.tweenIndex].p2;
            console.log("end line:", lines[this.tweenIndex], " el:", cl);
            
            var curTween = new TWEEN.Tween({
                x: ll.x,
                y: ll.y,
                z: ll.z
            })
                .to({
                x: cl.x,
                y: cl.y,
                z: cl.z
            }, 1000 / that.tweenSpeed)
            .onStart(function () {
                that.tween = curTween;
                //console.log("onStart");
                // create a new line to show path
                var lineGeo = new THREE.Geometry();
                lineGeo.vertices.push(new THREE.Vector3(ll.x, ll.y, ll.z), new THREE.Vector3(cl.x, cl.y, cl.z));
                var line = new THREE.Line(lineGeo, lineMat);
                line.type = THREE.Lines;
                that.tweenHighlight = line;
                that.scene.add(line);

            })
            .onComplete(function () {
                //console.log("onComplete");
                that.scene.remove(that.tweenHighlight);
                //setTimeout(function() {that.playNextTween();}, 0);
                if (isGotoLine) {
                    console.log("got onComplete for tween and since isGotoLine mode we are stopping");
                    that.stopSampleRun();
                } else {
                    that.playNextTween();
                }
            })
            .onUpdate(function () {
                that.toolhead.position.x = this.x;
                that.toolhead.position.y = this.y;
                that.toolhead.position.z = this.z + 20;
                that.lookAtToolHead();
            });
            //lastTween.chain(curTween);
            //lastTween = curTween;
            this.tween = curTween;
            //this.tweenIndex++;
            this.tween.start();
        },
        playSampleRun: function (evt) {
            console.log("controls:", this.controls);
            //this.wakeAnimate();
            this.animNoSleep();
            $('.com-chilipeppr-widget-3d-menu-samplerun').prop('disabled', true);
            $('.com-chilipeppr-widget-3d-menu-samplerun').popover('hide');
            $('.com-chilipeppr-widget-3d-menu-samplerunstop').prop('disabled', false);
            $('.com-chilipeppr-widget-3d-menu-samplerunpause').prop('disabled', false);

            this.tweenPaused = false;
            this.tweenIsPlaying = true;
            this.tweenIndex = 0;

            var that = this;
            console.log("playSampleRun");
            //console.log("playSampleRun click:", evt, that);

            // cleanup previous run
            TWEEN.removeAll();

            // we will tween all gcode locs in order
            //var lines = this.object.userData.lines;
            //var pstart = this.object.userData.lines[0];
            var tween = new TWEEN.Tween({
                x: 0,
                y: 0,
                z: 0
            })
                .to({
                x: 0,
                y: 0,
                z: 0
            }, 20)
            .easing(TWEEN.Easing.Quadratic.InOut)
            .onComplete(function () {
                //console.log("onComplete");
                that.playNextTween();
            })
            .onUpdate(function () {
                that.toolhead.position.x = this.x;
                that.toolhead.position.y = this.y;
                that.toolhead.position.z = this.z + 20;
            });

            this.tween = tween;
            this.tweenIndex = 0;
            this.tween.start();

            /*
            //var mylines = this.object.userData.lines.slice
            lastTween = tween;
            var lineMat = new THREE.LineBasicMaterial({
                        color: 0xFF0000,
                        lineWidth: 1,
                        blending: THREE.AdditiveBlending,
                        transparent: true,
                        opacity: 1,
                    });
            $.each(this.object.userData.lines.slice(1), function(val, item) {
                //console.log(val,item); 
                var ll = lines[val].p2;
                var cl = item.p2;
                //console.log(ll, cl);
                //var lineHighlight;
                var curTween = new TWEEN.Tween( { x: ll.x, y: ll.y, z: ll.z} )
                .to( {x: cl.x, y: cl.y, z: cl.z}, 1000 / that.tweenSpeed)
                //.easing( TWEEN.Easing.Quadratic.InOut )
                .onStart( function() {
                    that.tween = curTween;
                    //console.log("onStart");
                    // create a new line to show path
                    var lineGeo = new THREE.Geometry();
                    lineGeo.vertices.push(new THREE.Vector3(ll.x, ll.y, ll.z), new THREE.Vector3(cl.x, cl.y, cl.z));
                    var line = new THREE.Line(lineGeo, lineMat);
                    line.type = THREE.Lines;
                    that.tweenHighlight = line;
                    that.scene.add(line);
                })
                .onComplete( function() {
                    //console.log("onComplete");
                    that.scene.remove(that.tweenHighlight);
                })
                .onUpdate( function () {
                    that.toolhead.position.x = this.x;
                    that.toolhead.position.y = this.y;
                    that.toolhead.position.z = this.z + 20;
                    that.lookAtToolHead();
                } );
                lastTween.chain(curTween);
                lastTween = curTween;
            });
            
            tween.start();
            */
        },
        makeSprite: function (scene, rendererType, vals) {
            var canvas = document.createElement('canvas'),
                context = canvas.getContext('2d'),
                metrics = null,
                textHeight = 100,
                textWidth = 0,
                actualFontSize = 10;
            var txt = vals.text;
            if (vals.size) actualFontSize = vals.size;

            context.font = "normal " + textHeight + "px Arial";
            metrics = context.measureText(txt);
            var textWidth = metrics.width;

            canvas.width = textWidth;
            canvas.height = textHeight;
            context.font = "normal " + textHeight + "px Arial";
            context.textAlign = "center";
            context.textBaseline = "middle";
            //context.fillStyle = "#ff0000";
            context.fillStyle = vals.color;

            context.fillText(txt, textWidth / 2, textHeight / 2);

            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            var material = new THREE.SpriteMaterial({
                map: texture,
                useScreenCoordinates: false
            });
            material.transparent = true;
            //var textObject = new THREE.Sprite(material);
            var textObject = new THREE.Object3D();
            textObject.position.x = vals.x;
            textObject.position.y = vals.y;
            textObject.position.z = vals.z;
            var sprite = new THREE.Sprite(material);
            textObject.textHeight = actualFontSize;
            textObject.textWidth = (textWidth / textHeight) * textObject.textHeight;
            if (rendererType == "2d") {
                sprite.scale.set(textObject.textWidth / textWidth, textObject.textHeight / textHeight, 1);
            } else {
                sprite.scale.set(textWidth / textHeight * actualFontSize, actualFontSize, 1);
            }

            textObject.add(sprite);

            scene.add(textObject);
        },
        element: null,
        createScene: function (element) {

            console.log("inside createScene: element:", element);
            if (!Detector.webgl) Detector.addGetWebGLMessage();

            // store element on this object
            this.element = element;
            
            // Scene
            var scene = new THREE.Scene();
            this.scene = scene;

            // Lights...
            [
                [0, 0, 1, 0xFFFFCC],
                [0, 1, 0, 0xFFCCFF],
                [1, 0, 0, 0xCCFFFF],
                [0, 0, -1, 0xCCCCFF],
                [0, -1, 0, 0xCCFFCC],
                [-1, 0, 0, 0xFFCCCC]
            ].forEach(function (position) {
                var light = new THREE.DirectionalLight(position[3]);
                light.position.set(position[0], position[1], position[2]).normalize();
                scene.add(light);
            });

            // Camera...
            var fov = 45,
                aspect = element.width() / element.height(),
                near = 0.0000000001,
                far = 10000000,
                camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
            this.camera = camera;
            camera.rotationAutoUpdate = true;
            camera.position.x = 10;
            camera.position.y = -100;
            camera.position.z = 200;
            scene.add(camera);

            // Controls
            //var mouseEvtContainer = $('#com-chilipeppr-widget-3dviewer-renderArea');
            //console.log(mouseEvtContainer);
            //controls = new THREE.TrackballControls(camera, mouseEvtContainer[0]);
            controls = new THREE.TrackballControls(camera, element[0]);
            this.controls = controls; // set property for later use
            //controls = new THREE.OrbitControls(camera);
            controls.noPan = false;
            controls.dynamicDampingFactor = 0.15;
            //controls.staticMoving = true;
            //controls.target.x = 50;
            //controls.target.y = 100;
            //controls.autoRotate = true;
            console.log("controls:", controls);
            //controls.target.z = 100;
            //controls.addEventListener( 'change', render );

            // Renderer
            /*
            var renderer = new THREE.WebGLRenderer({
                clearColor: 0x000000,
                clearAlpha: 1
            });
            */
            var renderer = new THREE.WebGLRenderer({
                antialias: true,
                preserveDrawingBuffer: false,
                alpha: true
            });
            this.renderer = renderer;
            //renderer.setClearColor( scene.fog.color, 1 );
            renderer.setClearColor(0xeeeeee, 1);
            renderer.setSize(element.width(), element.height());
            element.append(renderer.domElement);
            //renderer.autoClear = true;
            //renderer.clear();

            // Arrow Helper
            /*
            var dir = new THREE.Vector3( 1, 0, 0 );
            var origin = new THREE.Vector3( 0, 0, 0 );
            var length = 100;
            var hex = 0xffff00;
            
            var arrowHelper = new THREE.ArrowHelper( dir, origin, length, hex );
            scene.add( arrowHelper );
            */

            //scene.add( new THREE.PointLightHelper( light, 5 ) );
            // Show grid

            var helper = new THREE.GridHelper(200, 10);
            helper.setColors(0x0000ff, 0x808080);
            helper.position.y = 0;
            helper.position.x = 0;
            helper.position.z = 0;
            helper.rotation.x = 90 * Math.PI / 180;
            helper.material.opacity = 0.2;
            helper.material.transparent = true;
            console.log("helper:", helper);
            scene.add(helper);

            /*
            // sparks
            var particleGroup = new SPE.Group({
                texture: '', 
        		maxAge: 1,
                colorize: 1,
                transparent: 1,
                alphaTest: 0.5,
                depthWrite: false,
                depthTest: true,
                blending: THREE.NormalBlending
        	});

        	var emitter = new SPE.Emitter({
        		position: new THREE.Vector3(0, 0, 0),
                positionSpread: new THREE.Vector3( 0, 0, 1 ),

        		acceleration: new THREE.Vector3(0, -1, 0),
        		accelerationSpread: new THREE.Vector3( 1, 0, 1 ),

        		velocity: new THREE.Vector3(0, 0, 1),
        		velocitySpread: new THREE.Vector3(1, 1, 1),

        		colorStart: new THREE.Color('red'),
        		colorEnd: new THREE.Color('blue'),
                opacityStart: 0,
                opacityStartSpread: 0,
                opacityMiddle: 0.5,
                opacityMiddleSpread: 0,
                opacityEnd: 1,
                opacityEndSpread: 1,
                
        		sizeStart: 0.01,
        		sizeEnd: 0.5,

        		particleCount: 5
        	});

        	particleGroup.addEmitter( emitter );
            var clock = new THREE.Clock();
        	scene.add( particleGroup.mesh );
            */

            // axes
            axes = new THREE.AxisHelper(100);
            scene.add(axes);

            // add axes labels
            this.makeSprite(scene, "webgl", {
                x: 110,
                y: 0,
                z: 0,
                text: "X",
                color: "#ff0000"
            });
            this.makeSprite(scene, "webgl", {
                x: 0,
                y: 110,
                z: 0,
                text: "Y",
                color: "#00ff00"
            });
            this.makeSprite(scene, "webgl", {
                x: 0,
                y: 0,
                z: 110,
                text: "Z",
                color: "#0000ff"
            });

            // ToolHead Cylinder
            // API: THREE.CylinderGeometry(bottomRadius, topRadius, height, segmentsRadius, segmentsHeight)
            var cylinder = new THREE.Mesh(new THREE.CylinderGeometry(0, 5, 40, 15, 1, false), new THREE.MeshNormalMaterial());
            cylinder.overdraw = true;
            cylinder.rotation.x = -90 * Math.PI / 180;
            cylinder.position.z = 20;
            cylinder.material.opacity = 0.5;
            cylinder.material.transparent = true;
            console.log("cone:", cylinder);
            this.toolhead = cylinder;
            scene.add(cylinder);

            // Action!
            //controls.addEventListener( 'change', test );
            //element.on('change', test);
            var mouseEvtContainer = $('#com-chilipeppr-widget-3dviewer-renderArea');
            console.log(mouseEvtContainer);
            //mouseEvtContainer.on('mousemove mousedown mousewheel hover click dblclick scroll touchstart touchmove touchenter focus resize', this.wakeAnimate.bind(this));
            //controls.addEventListener( 'change', this.wakeAnimate.bind(this));
            controls.addEventListener( 'start', this.animNoSleep.bind(this));
            controls.addEventListener( 'end', this.animAllowSleep.bind(this));
            //mouseEvtContainer.on('', wakeAnimate);
            /*
            function test(evt) {
                console.log("got event listener", evt);
            }
            function slowDown() {
                requestAnimationFrame(animate); // And repeat...
            }
            */
            console.log("this wantAnimate:", this);
            this.wantAnimate = true;
            //this.camera = camera; 
            //var that = this;
            /*
            function animate() {
                TWEEN.update();
                //setTimeout(slowDown, 100);
                if (that.wantAnimate) requestAnimationFrame(animate); // And repeat...
                controls.update();
                // Use a fixed time-step here to avoid gaps
                //render( clock.getDelta() );
                //render();
                renderer.render(scene, camera);
            }
            */
            
            //setTimeout(this.sleepAnimate, 5000);

            /*
            function render2(dt) {
                //controls.update();
                //particleGroup.tick( dt );
                renderer.render(scene, camera);
                //console.log(camera);
                //TWEEN.update();
                requestAnimationFrame(render); // And repeat...
                //stats.update();
            }
            */
            //render( clock.getDelta() );
            //setTimeout(animate, 0);
            //render();
            //animate();
            //this.animate();
            this.wakeAnimate();

            // Fix coordinates up if window is resized.
            var that = this;
            $(window).on('resize', function () {
                //console.log("got resize event. resetting aspect ratio.");
                renderer.setSize(element.width(), element.height());
                camera.aspect = element.width() / element.height();
                camera.updateProjectionMatrix();
                controls.screen.width = window.innerWidth;
                controls.screen.height = window.innerHeight;
                that.wakeAnimate();
                //render();
            });

            return scene;
        },
        resize: function() {
            //console.log("got resize event. resetting aspect ratio.");
            this.renderer.setSize(this.element.width(), this.element.height());
            this.camera.aspect = this.element.width() / this.element.height();
            this.camera.updateProjectionMatrix();
            this.controls.screen.width = window.innerWidth;
            this.controls.screen.height = window.innerHeight;
            this.wakeAnimate();
        },
        mytimeout: null,
        animate: function() {
            TWEEN.update();
            if (this.wantAnimate) {
                requestAnimationFrame(this.animate.bind(this));
            }
            this.controls.update();
            this.renderer.render(this.scene, this.camera);
        },
        wakeAnimate: function(evt) {
            //console.log("wakeAnimate:", evt);
            this.wantAnimate = true;
            //controls.update();
            //clearTimeout(this.mytimeout);
            if (!this.mytimeout) {
                this.mytimeout = setTimeout(this.sleepAnimate.bind(this), 10000);
                //console.log("wakeAnimate");
                requestAnimationFrame(this.animate.bind(this));
            }
        },
        sleepAnimate: function() {
            this.mytimeout = null;
            if (this.isNoSleepMode) {
                // skip sleeping the anim
                console.log("Being asked to sleep anim, but in NoSleepMode");
            } else {
                this.wantAnimate = false;
                console.log("slept animate");
            }
        },
        cancelSleep: function() {
            clearTimeout(this.mytimeout);
        },
        isNoSleepMode: false,
        animNoSleep: function() {
            //console.log("anim no sleep");
            this.isNoSleepMode = true;
            //this.cancelSleep();
            this.wakeAnimate();
        },
        animAllowSleep: function() {
            //console.log("anim allow sleep");
            
            // even if we're being asked to allow sleep
            // but the tween is playing, don't allow it
            if (this.tweenIsPlaying) return;
            
            // if we get here, then allow sleep
            this.isNoSleepMode = false;
            if (!this.mytimeout) this.mytimeout = setTimeout(this.sleepAnimate.bind(this), 5000);
        },
        /**
         * Parses a string of gcode instructions, and invokes handlers for
         * each type of command.
         *
         * Special handler:
         *   'default': Called if no other handler matches.
         */
        GCodeParser: function (handlers) {
            this.handlers = handlers || {};

            this.lastArgs = {cmd: null};
            
            this.parseLine = function (text, info) {
                //text = text.replace(/;.*$/, '').trim(); // Remove comments
                //text = text.replace(/\(.*$/, '').trim(); // Remove comments
                //text = text.replace(/<!--.*?-->/, '').trim(); // Remove comments
                var origtext = text;
                // remove line numbers if exist
                if (text.match(/^N/i)) {
                    // yes, there's a line num
                    text = text.replace(/^N\d+\s*/ig, "");
                }
                // collapse leading zero g cmds to no leading zero
                text = text.replace(/G00/i, 'G0');
                text = text.replace(/G0(\d)/i, 'G$1');
                // add spaces after g cmds and xyzijk params
                text = text.replace(/([gmtxyzij])/ig, " $1");
                // remove front and trailing space
                text = text.trim();
                
                // see if comment
                var isComment = false;
                if (text.match(/^(;|\(|<)/)) {
                    text = origtext;
                    isComment = true;
                } else {
                    // make sure to remove inline comments
                    text = text.replace(/\(.*?\)/g, "");
                }
                //console.log("gcode txt:", text);
                
                if (text && !isComment) {
                    //console.log("there is txt and it's not a comment");
                    //console.log("");
                    // preprocess XYZIJ params to make sure there's a space
                    //text = text.replace(/(X|Y|Z|I|J|K)/ig, "$1 ");
                    //console.log("gcode txt:", text);
                    var tokens = text.split(/\s+/);
                    //console.log("tokens:", tokens);
                    if (tokens) {
                        var cmd = tokens[0];
                        cmd = cmd.toUpperCase();
                        // check if a g or m cmd was included in gcode line
                        // you are allowed to just specify coords on a line
                        // and it should be assumed that the last specified gcode
                        // cmd is what's assumed
                        isComment = false;
                        if (!cmd.match(/^(G|M|T)/i)) {
                            // if comment, drop it
                            /*
                            if (cmd.match(/(;|\(|<)/)) {
                                // is comment. do nothing.
                                isComment = true;
                                text = origtext;
                                //console.log("got comment:", cmd);
                            } else {
                            */

                                //console.log("no cmd so using last one. lastArgs:", this.lastArgs);
                                // we need to use the last gcode cmd
                                cmd = this.lastArgs.cmd;
                                //console.log("using last cmd:", cmd);
                                tokens.unshift(cmd); // put at spot 0 in array
                                //console.log("tokens:", tokens);
                            //}
                        } else {
                            
                            // we have a normal cmd as opposed to just an xyz pos where
                            // it assumes you should use the last cmd
                            // however, need to remove inline comments (TODO. it seems parser works fine for now)
                            
                        }
                        var args = {
                            'cmd': cmd,
                            'text': text,
                            'origtext': origtext,
                            'indx': info,
                            'isComment': isComment
                        };
                        
                        //console.log("args:", args);
                        if (tokens.length > 1  && !isComment) {
                            tokens.splice(1).forEach(function (token) {
                                //console.log("token:", token);
                                if (token && token.length > 0) {
                                    var key = token[0].toLowerCase();
                                    var value = parseFloat(token.substring(1));
                                    args[key] = value;
                                } else {
                                    //console.log("couldn't parse token in foreach. weird:", token);
                                }
                            });
                        }
                        var handler = this.handlers[cmd] || this.handlers['default'];

                        // don't save if saw a comment
                        if (!args.isComment) {
                            this.lastArgs = args;
                            //console.log("just saved lastArgs for next use:", this.lastArgs);
                        } else {
                            //console.log("this was a comment, so didn't save lastArgs");
                        }
                        //console.log("calling handler: ", cmd, ", args:", args);
                        if (handler) {
                            
                            return handler(args, info, this);
                        } else {
                            console.error("No handler for gcode command!!!");
                        }
                            
                    }
                } else {
                    // it was a comment or the line was empty
                    // we still need to create a segment with xyz in p2
                    // so that when we're being asked to /gotoline we have a position
                    // for each gcode line, even comments. we just use the last real position
                    // to give each gcode line (even a blank line) a spot to go to
                    var args = {
                        'cmd': 'empty or comment',
                        'text': text,
                        'origtext': origtext,
                        'indx': info,
                        'isComment': isComment
                    };
                    var handler = this.handlers['default'];
                    return handler(args, info, this);
                }
            }

            this.parse = function (gcode) {
                var lines = gcode.split(/\r{0,1}\n/);
                for (var i = 0; i < lines.length; i++) {
                    if (this.parseLine(lines[i], i) === false) {
                        break;
                    }
                }
            }
        },
        createObjectFromGCode: function (gcode, indxMax) {
            // Credit goes to https://github.com/joewalnes/gcode-viewer
            // for the initial inspiration and example code.
            // 
            // GCode descriptions come from:
            //    http://reprap.org/wiki/G-code
            //    http://en.wikipedia.org/wiki/G-code
            //    SprintRun source code

            // these are extra Object3D elements added during
            // the gcode rendering to attach to scene
            this.extraObjects = [];
            
            var lastLine = {
                x: 0,
                y: 0,
                z: 0,
                e: 0,
                f: 0,
                extruding: false
            };

            var layers = [];
            var layer = undefined;
            var lines = [];
            var bbbox = {
                min: {
                    x: 100000,
                    y: 100000,
                    z: 100000
                },
                max: {
                    x: -100000,
                    y: -100000,
                    z: -100000
                }
            };
            var bbbox2 = {
                min: {
                    x: 100000,
                    y: 100000,
                    z: 100000
                },
                max: {
                    x: -100000,
                    y: -100000,
                    z: -100000
                }
            };

            this.newLayer = function (line) {
                //console.log("layers:", layers, "layers.length", layers.length);

                layer = {
                    type: {},
                    layer: layers.length,
                    z: line.z,
                };
                layers.push(layer);
            };

            this.getLineGroup = function (line, args) {
                //console.log("getLineGroup:", line);
                if (layer == undefined) this.newLayer(line);
                var speed = Math.round(line.e / 1000);
                var grouptype = (line.extruding ? 10000 : 0) + speed;
                var color = new THREE.Color(line.extruding ? 0xff00ff : 0x0000ff);
                if (line.g0) {
                    grouptype = "g0";
                    color = new THREE.Color(0x00ff00);
                } else if (line.g2) {
                    grouptype = "g2";
                    color = new THREE.Color(0x999900);
                } else if (line.arc) {
                    grouptype = "arc";
                    color = new THREE.Color(0x0099ff);
                }
                // see if we have reached indxMax, if so draw, but 
                // make it ghosted
                if (args.indx > indxMax) {
                    grouptype = "ghost";
                    //console.log("args.indx > indxMax", args, indxMax);
                    color = new THREE.Color(0x000000);
                }
                //if (line.color) color = new THREE.Color(line.color);
                if (layer.type[grouptype] == undefined) {
                    layer.type[grouptype] = {
                        type: grouptype,
                        feed: line.e,
                        extruding: line.extruding,
                        color: color,
                        segmentCount: 0,
                        material: new THREE.LineBasicMaterial({
                            opacity: line.extruding ? 0.3 : line.g2 ? 0.2 : 0.5,
                            transparent: true,
                            linewidth: 1,
                            vertexColors: THREE.FaceColors
                        }),
                        geometry: new THREE.Geometry(),
                    }
                    if (args.indx > indxMax) {
                        layer.type[grouptype].material.opacity = 0.05;
                    }
                }
                return layer.type[grouptype];
            };

            this.drawArc = function(aX, aY, aZ, endaZ, aRadius, aStartAngle, aEndAngle, aClockwise) {
                //console.log("drawArc:", aX, aY, aZ, aRadius, aStartAngle, aEndAngle, aClockwise);
                var ac = new THREE.ArcCurve(aX, aY, aRadius, aStartAngle, aEndAngle, aClockwise);
                //console.log("ac:", ac);
                var acmat = new THREE.LineBasicMaterial({
                    color: 0x00ddff,
                    opacity: 0.5,
                    transparent: true
                });
                var acgeo = new THREE.Geometry();
                var ctr = 0;
                var z = aZ;
                ac.getPoints(20).forEach(function (v) {
                    //console.log(v);
                    z = (((endaZ - aZ) / 20) * ctr) + aZ;
                    acgeo.vertices.push(new THREE.Vector3(v.x, v.y, z));
                    ctr++;
                });
                var aco = new THREE.Line(acgeo, acmat);
                //aco.position.set(pArc.x, pArc.y, pArc.z);
                //console.log("aco:", aco);
                this.extraObjects.push(aco);
            };
            
            this.drawArcFrom2PtsAndCenter = function(vp1, vp2, vpArc, args) {
                //var radius = vp1.distanceTo(vpArc);
                //console.log("radius:", radius);
                
                // Find angle
                var p1deltaX = vpArc.x - vp1.x;
                var p1deltaY = vpArc.y - vp1.y; 
                var anglepArcp1 = Math.atan(p1deltaY / p1deltaX);
                
                var p2deltaX = vpArc.x - vp2.x;
                var p2deltaY = vpArc.y - vp2.y; 
                var anglepArcp2 = Math.atan(p2deltaY / p2deltaX);
                
                // Draw arc from arc center
                var radius = vpArc.distanceTo(vp1);
                var radius2 = vpArc.distanceTo(vp2);
                //console.log("radius:", radius);
                if (Number((radius).toFixed(2)) != Number((radius2).toFixed(2))) console.log("Radiuses not equal. r1:", radius, ", r2:", radius2, " with args:", args, " rounded vals r1:", Number((radius).toFixed(2)), ", r2:", Number((radius2).toFixed(2)));
                
                // arccurve
                var clwise = true;
                if (args.clockwise != null && args.clockwise == false) clwise = false;
                //if (anglepArcp1 < 0) clockwise = false;
                if (p1deltaX >= 0) anglepArcp1 += Math.PI;
                if (p2deltaX >= 0) anglepArcp2 += Math.PI;
                this.drawArc(vpArc.x, vpArc.y, vp1.z, vp2.z, radius, anglepArcp1, anglepArcp2, clwise);
                
                /*
                    // figure out angle from vpArc to vp1 and vp2
                    var angle1 = vpArc.angleTo(vp1);
                    console.log("angle1:", angle1);
                    var angle2 = vpArc.angleTo(vp2);
                    console.log("angle2:", angle2);
                    // theta length is the angle1 - angle2
                    var theta = angle2 + angle1;
                    console.log("theta:", theta);
                    
                    // figure out Vector2 angle from vpArc to vp1 and vp2
                    THREE.Vector2.prototype.angleTo = function(v) {
                        var theta = this.dot( v ) / ( this.length() * v.length() );
                        // clamp, to handle numerical problems
                        return Math.acos( THREE.Math.clamp( theta, -1, 1 ) );
                    };
                    var v2vpArc = new THREE.Vector2(vpArc.x, vpArc.y);
                    var v2angle1 = v2vpArc.angleTo(new THREE.Vector2(vp1.x, vp1.y));
                    console.log("v2angle1:", v2angle1);
                    var v2angle2 = v2vpArc.angleTo(new THREE.Vector2(vp2.x, vp2.y));
                    console.log("v2angle2:", v2angle2);
                    // theta length is the angle1 - angle2
                    var v2theta = v2angle2 + v2angle1;
                    console.log("v2theta:", v2theta);
                    
                    // arccurve
                    // ( aX, aY, aRadius, aStartAngle, aEndAngle, aClockwise )
                    var ac = new THREE.ArcCurve(vpArc.x, vpArc.y, radius, Math.PI, Math.PI * 2, false);
                    console.log("ac:", ac);
                    var acmat = new THREE.LineBasicMaterial( { 
                        color: 0x00ff00,
                        opacity: 0.5,
                        transparent: true} );
                    var acgeo = new THREE.Geometry();
                    ac.getPoints(20).forEach(function(v) {
                        console.log(v);
                        acgeo.vertices.push(new THREE.Vector3(v.x, v.y, vpArc.z));
                    });
                    var aco = new THREE.Line( acgeo, acmat);
                    //aco.position.set(pArc.x, pArc.y, pArc.z);
                    console.log("aco:", aco);
                    this.extraObjects.push(aco);
                    */
                
                /*
                    // the circle for the arc g2/g3
                    var circgeo = new THREE.CircleGeometry( radius, 30 );
                    //circgeo.vertices.shift(); // remove center
                    var circmat = new THREE.LineBasicMaterial( { 
                        color: 0x33ddff,
                        opacity: 0.5,
                        transparent: true} );
                    var circ = new THREE.Line( circgeo, circmat );
                    circ.position.set(pArc.x, pArc.y, pArc.z);
                    circgeo.vertices.forEach(function(v) {
                        //console.log("v:", v);
                    });
                    this.extraObjects.push( circ );
                    */
                
                /*
                    // draw a sphere at center of circle
                    var radiusSphere = radius / 50;
                    var sphereGeometry = new THREE.SphereGeometry( radiusSphere, 8, 4 );
                    var sphereMaterial = new THREE.MeshLambertMaterial( { color: 0x0000ff } );
                    var sphere = new THREE.Mesh( sphereGeometry, sphereMaterial );
                    sphere.position.set(pArc.x, pArc.y, pArc.z);
                    this.extraObjects.push( sphere );
                    */
                
                
                // remove vertices that are above the max x and below the min x
                // of the start/end positions
                //circgeo.vertices
                
                /*                    
                    var curve = new THREE.QuadraticBezierCurve3(vp1, vpArc, vp2);
                    console.log("curve:", curve);
                    var ptarray = curve.getPoints(5);
                    console.log(ptarray);
                    //geometry.vertices.push(ptarray);
                    
                    for (var i = 0; i < ptarray.length; i++) {
                        console.log("adding pt:", ptarray[i]);
                        geometry.vertices.push(ptarray[i]);
                        geometry.colors.push(group.color);
                        if (i > 0 && i < ptarray.length - 1) {
                            console.log("adding pt 2nd time to end/start next line", ptarray[i]);
                            geometry.vertices.push(ptarray[i]);
                            geometry.colors.push(group.color);
                        }
                    }
                    */
                /*
                    var arcShape = new THREE.Shape();
                    arcShape.moveTo( p1.x, p1.y, p1.z );
                    arcShape.absarc( 10, 10, 40, 0, Math.PI*2, false );
                    */
                /*
                    for (var i = 0; i <= segmentCount; i++) {
                        var theta = (i / segmentCount) * Math.PI * 2;
                        geometry.vertices.push(
                            new THREE.Vector3(
                                Math.cos(theta) * radius,
                                Math.sin(theta) * radius,
                                0));
                        geometry.colors.push(group.color);
                    }
                    */
            };
            
            this.addSegment = function (p1, p2, args) {
                //console.log("");
                //console.log("addSegment p2:", p2);
                // add segment to array for later use
                lines.push({
                    p2: p2,
                    'args': args
                });

                var group = this.getLineGroup(p2, args);
                var geometry = group.geometry;

                group.segmentCount++;
                // see if we need to draw an arc
                if (p2.arc) {
                    //console.log("");
                    //console.log("drawing arc. p1:", p1, ", p2:", p2);
                    
                    //var segmentCount = 12;
                    // figure out the 3 pts we are dealing with
                    // the start, the end, and the center of the arc circle
                    // radius is dist from p1 x/y/z to pArc x/y/z
                    var vp1 = new THREE.Vector3(p1.x, p1.y, p1.z);
                    var vp2 = new THREE.Vector3(p2.x, p2.y, p2.z);
                    var pArc = {
                        x: p2.arci ? p1.x + p2.arci : p1.x,
                        y: p2.arcj ? p1.y + p2.arcj : p1.y,
                        z: p2.arck ? p1.z + p2.arck : p1.z,
                    };
                    //console.log("new pArc:", pArc);
                    var vpArc = new THREE.Vector3(pArc.x, pArc.y, pArc.z);
                    //console.log("vpArc:", vpArc);
                    
                    this.drawArcFrom2PtsAndCenter(vp1, vp2, vpArc, args);
                    
                    // still push the normal p1/p2 point for debug
                    p2.g2 = true;
                    group = this.getLineGroup(p2, args);
                    geometry = group.geometry;
                    geometry.vertices.push(
                        new THREE.Vector3(p1.x, p1.y, p1.z));
                    geometry.vertices.push(
                        new THREE.Vector3(p2.x, p2.y, p2.z));
                    geometry.colors.push(group.color);
                    geometry.colors.push(group.color);
                } else {
                    geometry.vertices.push(
                        new THREE.Vector3(p1.x, p1.y, p1.z));
                    geometry.vertices.push(
                        new THREE.Vector3(p2.x, p2.y, p2.z));
                    geometry.colors.push(group.color);
                    geometry.colors.push(group.color);
                }
                
                if (p2.extruding) {
                    bbbox.min.x = Math.min(bbbox.min.x, p2.x);
                    bbbox.min.y = Math.min(bbbox.min.y, p2.y);
                    bbbox.min.z = Math.min(bbbox.min.z, p2.z);
                    bbbox.max.x = Math.max(bbbox.max.x, p2.x);
                    bbbox.max.y = Math.max(bbbox.max.y, p2.y);
                    bbbox.max.z = Math.max(bbbox.max.z, p2.z);
                }
                if (p2.g0) {
                    // we're in a toolhead move, label moves
                    /*
                    if (group.segmentCount < 2) {
                    this.makeSprite(this.scene, "webgl", {
                        x: p2.x,
                        y: p2.y,
                        z: p2.z + 0,
                        text: group.segmentCount,
                        color: "#ff00ff",
                        size: 3,
                    });
                    }
                    */
                }
                // global bounding box calc
                bbbox2.min.x = Math.min(bbbox2.min.x, p2.x);
                bbbox2.min.y = Math.min(bbbox2.min.y, p2.y);
                bbbox2.min.z = Math.min(bbbox2.min.z, p2.z);
                bbbox2.max.x = Math.max(bbbox2.max.x, p2.x);
                bbbox2.max.y = Math.max(bbbox2.max.y, p2.y);
                bbbox2.max.z = Math.max(bbbox2.max.z, p2.z);
            }
            var relative = false;

            this.delta = function (v1, v2) {
                return relative ? v2 : v2 - v1;
            }

            this.absolute = function (v1, v2) {
                return relative ? v1 + v2 : v2;
            }

            this.addFakeSegment = function(args) {
                //line.args = args;
                var arg2 = {
                    isFake : true,
                    text : args.text,
                    indx : args.indx
                };
                if (arg2.text.match(/^(;|\(|<)/)) arg2.isComment = true;
                lines.push({
                    p2: lastLine,    // since this is fake, just use lastLine as xyz
                    'args': arg2
                });
            }

            var cofg = this;
            var parser = new this.GCodeParser({
                /* When doing CNC, generally G0 just moves to a new location
                as fast as possible which means no milling or extruding is happening in G0.
                So, let's color it uniquely to indicate it's just a toolhead move. */
                G0: function (args, indx) {
                    //G1.apply(this, args, line, 0x00ff00);
                    //console.log("G0", args);
                    var newLine = {
                        x: args.x !== undefined ? cofg.absolute(lastLine.x, args.x) : lastLine.x,
                        y: args.y !== undefined ? cofg.absolute(lastLine.y, args.y) : lastLine.y,
                        z: args.z !== undefined ? cofg.absolute(lastLine.z, args.z) : lastLine.z,
                        e: args.e !== undefined ? cofg.absolute(lastLine.e, args.e) : lastLine.e,
                        f: args.f !== undefined ? cofg.absolute(lastLine.f, args.f) : lastLine.f,
                    };
                    newLine.g0 = true;
                    //cofg.newLayer(newLine);
                    cofg.addSegment(lastLine, newLine, args);
                    lastLine = newLine;
                },
                G1: function (args, indx) {
                    // Example: G1 Z1.0 F3000
                    //          G1 X99.9948 Y80.0611 Z15.0 F1500.0 E981.64869
                    //          G1 E104.25841 F1800.0
                    // Go in a straight line from the current (X, Y) point
                    // to the point (90.6, 13.8), extruding material as the move
                    // happens from the current extruded length to a length of
                    // 22.4 mm.

                    var newLine = {
                        x: args.x !== undefined ? cofg.absolute(lastLine.x, args.x) : lastLine.x,
                        y: args.y !== undefined ? cofg.absolute(lastLine.y, args.y) : lastLine.y,
                        z: args.z !== undefined ? cofg.absolute(lastLine.z, args.z) : lastLine.z,
                        e: args.e !== undefined ? cofg.absolute(lastLine.e, args.e) : lastLine.e,
                        f: args.f !== undefined ? cofg.absolute(lastLine.f, args.f) : lastLine.f,

                    };
                    /* layer change detection is or made by watching Z, it's made by
         watching when we extrude at a new Z position */
                    if (cofg.delta(lastLine.e, newLine.e) > 0) {
                        newLine.extruding = cofg.delta(lastLine.e, newLine.e) > 0;
                        if (layer == undefined || newLine.z != layer.z) cofg.newLayer(newLine);
                    }
                    cofg.addSegment(lastLine, newLine, args);
                    lastLine = newLine;
                },
                G2: function (args, indx, gcp) {
                    /* this is an arc move from lastLine's xy to the new xy. for now let's
                    cheat and just show it as a line move. */
                    var newLine = {
                        x: args.x !== undefined ? cofg.absolute(lastLine.x, args.x) : lastLine.x,
                        y: args.y !== undefined ? cofg.absolute(lastLine.y, args.y) : lastLine.y,
                        z: args.z !== undefined ? cofg.absolute(lastLine.z, args.z) : lastLine.z,
                        e: args.e !== undefined ? cofg.absolute(lastLine.e, args.e) : lastLine.e,
                        f: args.f !== undefined ? cofg.absolute(lastLine.f, args.f) : lastLine.f,
                        arci: args.i ? args.i : null,
                        arcj: args.j ? args.j : null,
                        arck: args.k ? args.k : null,
                        arcr: args.r ? args.r : null,
                        
                    };
                   
                    //console.log("G2 newLine:", newLine);
                    //newLine.g2 = true;
                    newLine.arc = true;
                    newLine.clockwise = true;
                    if (args.clockwise) newLine.clockwise = args.clockwise;
                    cofg.addSegment(lastLine, newLine, args);
                    lastLine = newLine;
                    //console.log("G2. args:", args);
                },
                G3: function (args, indx, gcp) {
                    /* this is an arc move from lastLine's xy to the new xy. for now let's
                    cheat and just show it as a line move. */
                    args.arc = true;
                    args.clockwise = false;
                    gcp.handlers.G2(args, indx, gcp);
                },

                G21: function (args) {
                    // G21: Set Units to Millimeters
                    // Example: G21
                    // Units from now on are in millimeters. (This is the RepRap default.)

                    // No-op: So long as G20 is not supported.
                    cofg.addFakeSegment(args);

                },

                G73: function(args, indx, gcp) {
                    // peck drilling. just treat as g1
                    console.log("G73 gcp:", gcp);
                    gcp.handlers.G1(args);
                },
                G90: function (args) {
                    // G90: Set to Absolute Positioning
                    // Example: G90
                    // All coordinates from now on are absolute relative to the
                    // origin of the machine. (This is the RepRap default.)

                    relative = false;
                    cofg.addFakeSegment(args);
                },

                G91: function (args) {
                    // G91: Set to Relative Positioning
                    // Example: G91
                    // All coordinates from now on are relative to the last position.

                    // TODO!
                    relative = true;
                    cofg.addFakeSegment(args);
                },

                G92: function (args) { // E0
                    // G92: Set Position
                    // Example: G92 E0
                    // Allows programming of absolute zero point, by reseting the
                    // current position to the values specified. This would set the
                    // machine's X coordinate to 10, and the extrude coordinate to 90.
                    // No physical motion will occur.

                    // TODO: Only support E0
                    var newLine = lastLine;
                    newLine.x = args.x !== undefined ? args.x : newLine.x;
                    newLine.y = args.y !== undefined ? args.y : newLine.y;
                    newLine.z = args.z !== undefined ? args.z : newLine.z;
                    newLine.e = args.e !== undefined ? args.e : newLine.e;
                    lastLine = newLine;
                    cofg.addFakeSegment(args);
                },
                M30: function (args) {
                    cofg.addFakeSegment(args);
                },
                M82: function (args) {
                    // M82: Set E codes absolute (default)
                    // Descriped in Sprintrun source code.

                    // No-op, so long as M83 is not supported.
                    cofg.addFakeSegment(args);
                },

                M84: function (args) {
                    // M84: Stop idle hold
                    // Example: M84
                    // Stop the idle hold on all axis and extruder. In some cases the
                    // idle hold causes annoying noises, which can be stopped by
                    // disabling the hold. Be aware that by disabling idle hold during
                    // printing, you will get quality issues. This is recommended only
                    // in between or after printjobs.

                    // No-op
                    cofg.addFakeSegment(args);
                },

                'default': function (args, info) {
                    //if (!args.isComment)
                    //    console.log('Unknown command:', args.cmd, args, info);
                    cofg.addFakeSegment(args);
                },
            });

            parser.parse(gcode);

            console.log("inside creatGcodeFromObject. this:", this);

            console.log("Layer Count ", layers.length);

            
            var object = new THREE.Object3D();

            for (var lid in layers) {
                var layer = layers[lid];
                //		console.log("Layer ", layer.layer);
                for (var tid in layer.type) {
                    var type = layer.type[tid];
                    //			console.log("Layer ", layer.layer, " type ", type.type, " seg ", type.segmentCount);
                    object.add(new THREE.Line(type.geometry, type.material, THREE.LinePieces));
                }
            }
            console.log("extraOjbects", this.extraObjects);
            this.extraObjects.forEach(function(obj) {
                object.add(obj);
            });

            console.log("bbox ", bbbox);

            // Center
            var scale = 1; // TODO: Auto size

            var center = new THREE.Vector3(
            bbbox.min.x + ((bbbox.max.x - bbbox.min.x) / 2),
            bbbox.min.y + ((bbbox.max.y - bbbox.min.y) / 2),
            bbbox.min.z + ((bbbox.max.z - bbbox.min.z) / 2));
            console.log("center ", center);

            var center2 = new THREE.Vector3(
            bbbox2.min.x + ((bbbox2.max.x - bbbox2.min.x) / 2),
            bbbox2.min.y + ((bbbox2.max.y - bbbox2.min.y) / 2),
            bbbox2.min.z + ((bbbox2.max.z - bbbox2.min.z) / 2));
            console.log("center2 of all gcode ", center2);

            // store meta data in userData of object3d for later use like in animation
            // of toolhead
            object.userData.bbbox2 = bbbox2;
            object.userData.lines = lines;
            object.userData.layers = layers;
            object.userData.center2 = center2;
            object.userData.extraObjects = this.extraObjects;
            
            console.log("userData for this object3d:", object.userData);
            /*
            this.camera.target.x = center2.x;
            this.camera.target.y = center2.y;
            this.camera.target.z = center2.z;
            */

            //object.position = center.multiplyScalar(-scale);

            //object.scale.multiplyScalar(scale);
            console.log("final object:", object);

            return object;
        }
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/y3HRF/show/light/ -->
</div>
                <!-- Workspace Hdr -->
                <div id="com-chilipeppr-ws-gcode-hdr" class="com-chilipeppr-ws-hdr zhigh well">Workspace - TinyG
                    <div id="com-chilipeppr-ws-gcode-menu" class="pull-right">            
                        <div class="btn-group">
                            <div class="dropdown">
                                <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""><span class="caret"></span></button>
                                <ul class="dropdown-menu" role="menu">
                                    <li id="com-chilipeppr-ws-gcode-menu-billboard" style="width:350px;"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/Guvv4/show/light/ -->




<style type="text/css">
    .com-chilipeppr-ws-billboard-content {
    padding: 6px 20px;
}
.com-chilipeppr-ws-billboard-title {
    margin-bottom:6px;
}
.com-chilipeppr-ws-billboard-url {
    /* font-size: 9px; */
    padding-top:0px;
    margin-bottom:6px;
    font-size:12px;
}
.com-chilipeppr-ws-billboard-img {
    border:0px solid red;
    border-radius: 5px;
    position: relative;
    width:100%;
    height:160px;
    background-position: center;
    background-size: cover;
}
.com-chilipeppr-ws-billboard-stats {
    position: absolute;
    top: 4px;
    left: 10px;
}
.com-chilipeppr-ws-billboard-desc {
    /* font-size:11px; */
}
.com-chilipeppr-ws-billboard-detail-title {
    font-weight: bold;
}
.com-chilipeppr-ws-billboard-stats2 {
    position: absolute;
    bottom: 0px;
    left: 0px;
    right: 0px;
    padding: 4px 10px 10px 10px;
    background-color: rgba(255, 255, 255, 0.5);
}
  </style>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-ws-billboard-tinyg", ["chilipeppr_ready"], function () {
    return {
        id: "com-chilipeppr-ws-billboard-tinyg",
        url: "http://fiddle.jshell.net/chilipeppr/Guvv4/show/light",
        fiddleurl: "http://fiddle.jshell.net/chilipeppr/Guvv4/",
        name: "Element / Billboard / TinyG Workspace",
        desc: "This is the billboard for TinyG Workspace."
    }
});
//]]>  

</script>




  <div id="com-chilipeppr-ws-billboard-tinyg">
    <div class="com-chilipeppr-ws-billboard-content">
         <h4 class="com-chilipeppr-ws-billboard-title" style="">TinyG Workspace</h4>

        <p class="com-chilipeppr-ws-billboard-url" style=""><a href="http://chilipeppr.com/tinyg">chilipeppr.com/tinyg</a>

        </p>
        <p class="com-chilipeppr-ws-billboard-desc">This workspace is a full-blown Gcode sender for your TinyG. The workspace connects to your TinyG via the serial port over the ChiliPeppr Serial Port JSON Server. It lets you view your Gcode in 3D, view the XYZA positions, perform jogging, and see advanced real-time details from the TinyG.</p>
        <div class="com-chilipeppr-ws-billboard-imgcontain" style="border:0px solid red; position: relative;">
            <a href="http://chilipeppr.com/tinyg"><div class="com-chilipeppr-ws-billboard-img" style="background-image: url('http://chilipeppr.com/img/tinyg.jpg')"></div></a>
            <div class="com-chilipeppr-ws-billboard-stats2">
                <!--
                <div class="row">
                    <div class="col-xs-4"><b>Views</b>

                    </div>
                    <div class="col-xs-4"><b>Users</b>

                    </div>
                    <div class="col-xs-4"><b>Forks</b>

                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-4"><span class="label label-default">6,324</span>

                    </div>
                    <div class="col-xs-4"><span class="label label-default">1,234</span>

                    </div>
                    <div class="col-xs-4"><span class="label label-default">34</span>

                    </div>
                </div>
                -->
            </div>
        </div>
        <!-- end img div container -->
    </div>
</div>
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/Guvv4/show/light/ -->
</li>
                                <li class="divider"></li><li role="presentation" class="dropdown-header fork-name">com-chilipeppr-ws-tinyg</li><li><a href="javascript:" class="pubsublink">PubSub for this Workspace</a></li><li><a href="http://jsfiddle.net/chilipeppr/2J3JH/show/light" target="_blank" class="standalone">View Workspace Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/2J3JH/" target="_blank" class="fork">Fork Workspace</a></li></ul>
                            </div>
                        </div>
                    </div>
                    <div id="com-chilipeppr-ws-gcode-dragdrop" class="pull-right"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/Z9F6G/show/light/ -->




<style type="text/css">
    .com-chilipeppr-elem-dragdrop.well {
    padding: 0px 20px;
    /* background-color: #428bca; */
}
.com-chilipeppr-elem-dragdrop.hover {
    background-color: #428bca;
}
  </style>
  


  <div class="com-chilipeppr-elem-dragdrop" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="hover" data-title="Drag and Drop" data-content="Drag a Gcode file onto your browser window to load it." data-original-title="" title=""> <span class="glyphicon glyphicon-file"></span><span class="glyphicon glyphicon-share-alt"></span>

</div>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-elem-dragdrop", ["chilipeppr_ready"], function () {
    console.log("Inside of define for com-chilipeppr-elem-dragdrop");
    return {
        id: "com-chilipeppr-elem-dragdrop",
        url: "http://fiddle.jshell.net/chilipeppr/Z9F6G/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/Z9F6G/",
        name: "Element / Drag Drop",
        desc: "An element that presents a drag and drop icon that allows files to be dragged onto it. A pubsub event called /com-chilipeppr-elem-dragdrop/ondropped is published when the drop is complete. The contents of the file are passed in the pubsub call so different widgets/elements can consume the contents of the file.",
        publish: {
            "/com-chilipeppr-elem-dragdrop/ondropped":"When the file is dropped. Payload contains the file.",
            "/com-chilipeppr-elem-dragdrop/ondragover":"When the mouse is hovering over drop area so you can hilite/react. Empty payload.",
            "/com-chilipeppr-elem-dragdrop/ondragleave": "When mouse stops hovering so you can remove hilites. Empty payload.",
            "/com-chilipeppr-elem-dragdrop/ondragdone" : "When user drops the file onto browser so you can remove hilites. Empty payload. Don't confuse this with ondropped which is the pubsub that actually contains file that was dropped."
        },
        subscribe: null,
        hasHtml: true,
        hasCss: true,
        hasJs: true,
        dropArea: null,
        txtDomElemSelector: null,
        init: function () {
            console.log("init called");
            $(".com-chilipeppr-elem-dragdrop").popover({animation:true,delay:100});
            //$(".com-chilipeppr-elem-dragdrop").popover('show');
            //console.log(this);
        },
        bind: function (dropDomElemSelector, txtDomElemSelector) {
            // Create drag and drop
            //dropArea = $('.dropArea');
            this.dropArea = $(dropDomElemSelector);
            this.txtDomElemSelector = $(txtDomElemSelector);

            // Attach our drag and drop handlers.
            this.dropArea.bind({
                dragover: function () {
                    $(this).addClass('hover');
                    $(".com-chilipeppr-elem-dragdrop").addClass('hover');
                    //$(".com-chilipeppr-elem-dragdrop").popover('show');
                    chilipeppr.publish("/com-chilipeppr-elem-dragdrop/ondragover", "");
                    return false;
                },
                dragend: function () {
                    $(this).removeClass('hover');
                    $(".com-chilipeppr-elem-dragdrop").removeClass('hover');
                    //$(".com-chilipeppr-elem-dragdrop").popover('hide');
                    chilipeppr.publish("/com-chilipeppr-elem-dragdrop/ondragleave", "");
                    return false;
                },
                dragleave: function () {
                    $(this).removeClass('hover');
                    $(".com-chilipeppr-elem-dragdrop").removeClass('hover');
                    //$(".com-chilipeppr-elem-dragdrop").popover('hide');
                    chilipeppr.publish("/com-chilipeppr-elem-dragdrop/ondragleave", "");

                    return false;
                },
                drop: function (e) {
                    $(this).removeClass('hover');
                    $(".com-chilipeppr-elem-dragdrop").removeClass('hover');
                    //$(".com-chilipeppr-elem-dragdrop").popover('hide');
                    chilipeppr.publish("/com-chilipeppr-elem-dragdrop/ondragleave", "");

                    e = e || window.event;
                    e.preventDefault();

                    // jQuery wraps the originalEvent, so we try to detect that here...
                    e = e.originalEvent || e;
                    //console.log(e);

                    // Using e.files with fallback because e.dataTransfer is immutable and can't be overridden in Polyfills (http://sandbox.knarly.com/js/dropfiles/).            
                    var files = (e.files || e.dataTransfer.files);
                    //console.log(files);
                    for (var i = 0; i < files.length; i++) {
                        (function (i) {
                            // Loop through our files with a closure so each of our FileReader's are isolated.
                            var reader = new FileReader();
                            //console.log(reader);
                            //console.log("file");
                            //console.log(files[i]);
                            var thefile = files[i];
                            reader.onload = function (event) {
                                //console.log(event);
                                //console.log(event.target.result);
                                //console.log(event.target.result);
                                $(this.txtDomElemSelector).html(event.target.result);

                                // publish event to pubsub
                                chilipeppr.publish("/com-chilipeppr-elem-dragdrop/ondropped", event.target.result);
                                chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "File Loaded", 
                                                   '<div class="row">' +
                                                   '<div class="col-xs-3">' + 
                                                   "Name: " + 
                                                   '</div><div class="col-xs-9">' + 
                                                   thefile.name +  
                                                   '</div>' + 
                                                   '</div><div class="row">' +
                                                   '<div class="col-xs-3">' + 
                                                   "Size: " + 
                                                   '</div><div class="col-xs-9">' + 
                                                   thefile.size + 
                                                   '</div>' + 
                                                   '</div><div class="row">' +
                                                   '<div class="col-xs-3">' + 
                                                   "Last Modified: " + 
                                                   '</div><div class="col-xs-9">' + 
                                                   thefile.lastModifiedDate +
                                                   '</div>' +
                                                   '</div>' +
                                                   "</div>", 1000 * 3);
                            };
                            //reader.readAsDataURL(files[i]);
                            reader.readAsText(files[i]);

                        })(i);
                    }

                    return false;
                }
            });
            // end drop area code
        }
    };
});

console.log("Element / Drag drop done loading.");
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/Z9F6G/show/light/ -->
</div>
                </div>
                <!-- Gcode List -->
                <div id="com-chilipeppr-gcode-list" class="zhigh"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/F2Qn3/show/light/ -->




<style type="text/css">
    #com-chilipeppr-widget-gcodeviewer {
}
#com-chilipeppr-widget-gcodeviewer .btn-group {
    padding-left:0;
}
#com-chilipeppr-widget-gcodeviewer .panel-heading {
    /* overflow-x: hidden; */
}
#com-chilipeppr-widget-gcode-body {
    padding:0;
    margin:0;
    height: 200px;
    overflow: scroll;
    overflow-x: hidden;
    position:inherit;
}
#com-chilipeppr-widget-gcode-feedrate {
    padding:0;
    padding-top:10px;
}
#com-chilipeppr-widget-gcode-tbl tr.gcode-rowhilite {
    background-color: #f5f5f5;
}
#com-chilipeppr-widget-gcode-tbl tr.gcode-rowhilite:hover {
    background-color: #d5d5d5;
}
#com-chilipeppr-widget-gcode-tbl .feedrate-adjust {
    color: blue;
}
#com-chilipeppr-widget-gcode-body .popover {
    max-width: 450px;
    width: 450px;
}
.com-chilipeppr-widget-gcode .btn-group {
    padding-left: 6px;
}
.com-chilipeppr-widget-gcode .popover .popover-content {
    font-size: 10px;
}
.com-chilipeppr-widget-gcode .g {
}
.com-chilipeppr-widget-gcode .gcode-comment {
    color: silver;
    /* max-width:150px; */
    word-wrap: break-word;
    /* display: block; */
    text-overflow: ellipsis;
}
.com-chilipeppr-gcode-tip {
    background-color: #e9e9e9;
    padding: 3px;
    border-radius: 6px;
}
.com-chilipeppr-widget-gcode .btn .glyphicon-play {
    /* width: 50px; */
}
.com-chilipeppr-widget-gcode .btn .glyphicon-stop {
    /* width: 30px; */
}
#com-chilipeppr-widget-gcode-tbl .glyphicon-ok {
    color: #dddddd;
}
#com-chilipeppr-widget-gcode-feedrate .glyphicon {
    padding:0;
    margin:0;
}
#com-chilipeppr-widget-gcode-feedrate .btn {
    /* padding:2px; */
    /* margin:0; */
}
#com-chilipeppr-widget-gcode-footer .stats-hdr {
    font-size:10px;
    /* font-weight:bold; */
}
#com-chilipeppr-widget-gcode-footer .stats-val {
    font-size:10px;
    font-weight:bold;
}
#com-chilipeppr-widget-gcode-body-wrapper {
    /* position:relative; */
    /* border:1px solid green; */
    /* height:100%; */
}
#com-chilipeppr-widget-gcode-body-jumpscroll-wrapper {
    position:relative;
    /* border: 1px solid red; */
    /* background-color:green; */
    /* height:100%; */
    /* width:100%; */
    /* display: table-cell; */
}
#com-chilipeppr-widget-gcode-body-jumpscroll {
    /* position: absolute; */
    border: 1px solid red;
    /* display: table-cell; */
    right:0;
    /* top:0; */
    height:100%;
    width:20px;
    background-color:silver;
}
.paginator {
    position: absolute;
    /* min-height:25px; */
    /* display: table-cell; */
    /* height:10px; */
    width:20px;
    height:20%;
    /* background-color: rgba(0,0,255,0.5); */
    /* border-bottom:1px solid silver; */
    /* margin-bottom:1px; */
    /* padding-bottom:1px; */
    padding:0;
    margin:0;
    overflow:hidden;
}
.paginator-first, .paginator-last {
    position:absolute;
    height:24px;
}
.paginator-first {
    top:0;
}
.paginator-last {
    bottom:0;
}
.jumpbtn {
    padding:0;
    margin:0;
}
.com-chilipeppr-gcode-jumpscroll .btn {
    border-radius:0;
    padding:0;
    margin:0;
    /* padding:1px 8px; */
    width:20px;
    background-color: none;
    /* background-color: rgba(255,255,255,0.5); */
    border:0;
    height:100%;
}
.com-chilipeppr-gcode-jumpscroll .glyphicon-minus {
    /* color: #fdfdfd; */
    color: rgba(255,255,255,0);
}
#com-chilipeppr-widget-gcode-footer {
    overflow-x: hidden;
}
#com-chilipeppr-widget-gcodeviewer .btnIconBlue {
    color: #428bca;
}
#com-chilipeppr-widget-gcodeviewer .btnIconWarning {
    color: #f0ad4e;
}
#com-chilipeppr-widget-gcodeviewer .plannerpauseindicator {
    cursor:none;
}

  </style>
  


  <div id="com-chilipeppr-widget-gcodeviewer" class="panel panel-default com-chilipeppr-widget-gcode  ui-resizable">
    <div class="panel-heading">
        <div class="" style="padding-bottom:10px;"><span class="panel-title" data-original-title="" title="">Gcode</span></div>
        <div class="btn-toolbar" role="toolbar" style="position:absolute;right:0px;top:0px;padding:10px 15px;">
            <div class="btn-group plannerpause" data-toggle="popover" data-content="This indicator shows that we're being asked to pause our sending of commands to the CNC controller so we don't overfill the buffer." data-original-title="" title="">
                <span disabled="true" class="plannerpauseindicator glyphicon glyphicon glyphicon-time btn btn-sm" data-original-title="" title=""></span>
            </div>
            <div class="btn-group" style="margin-left:0px;">
                <button type="button" id="com-chilipeppr-widget-gcode-play" class="btn btn-default btn-sm" data-original-title="" title=""><span class="glyphicon glyphicon-play"></span>
    
                </button>
                <button type="button" id="com-chilipeppr-widget-gcode-pause" disabled="" class="btn btn-default btn-sm" data-original-title="" title=""><span class="glyphicon glyphicon-pause"></span>
    
                </button>
                <button type="button" id="com-chilipeppr-widget-gcode-stop" disabled="" class="btn btn-default btn-sm" data-original-title="" title=""><span class="glyphicon glyphicon-stop"></span>
    
                </button>
                <button type="button" id="com-chilipeppr-widget-gcode-stepback" class="btn btn-default btn-sm" data-original-title="" title=""><span class="glyphicon glyphicon-step-backward"></span>
    
                </button>
                <button type="button" id="com-chilipeppr-widget-gcode-stepfwd" class="btn btn-default btn-sm" data-original-title="" title=""><span class="glyphicon glyphicon-step-forward"></span></button>
                <button type="button" id="com-chilipeppr-widget-gcode-btnoptions" class="btn btn-default btn-sm" data-original-title="" title=""><span class="glyphicon glyphicon-cog"></span></button>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>
    
                </button>
                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                    <!-- <li role="presentation" class="dropdown-header fork-name"></li>
                    <li><a href="" class="standalone" target="_blank">View Widget Standalone</a></li>
                    <li><a href="" class="fork" target="_blank">Fork Widget</a></li> -->
                <li role="presentation" class="dropdown-header fork-name">com-chilipeppr-widget-gcode</li><li><a href="javascript:" class="pubsublink">PubSub for this Widget</a></li><li><a href="http://fiddle.jshell.net/chilipeppr/F2Qn3/show/light/" target="_blank" class="standalone">View Widget Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/F2Qn3/" target="_blank" class="fork">Fork Widget</a></li></ul>
            </div>
        </div>
        <div id="com-chilipeppr-widget-gcode-feedrate" class="" style="padding-top:5px;overflow:hidden;">
            <div class="input-group input-group-sm" style=" "> <span class="input-group-btn ">
                <button class="btn btn-default" id="com-chilipeppr-widget-gcode-feedrate-adjust" type="button" data-original-title="" title="">Feedrate X</button></span>

                <input type="text" id="com-chilipeppr-widget-gcode-feedrate-val" class="form-control" value="1.00"> <span class="input-group-btn ">
                        <button class="btn btn-default" id="com-chilipeppr-widget-gcode-feedrate-up" type="button" data-original-title="" title=""><span class="glyphicon glyphicon-arrow-up btn-xs "></span>

                </button>
                <button class="btn btn-default" id="com-chilipeppr-widget-gcode-feedrate-down" type="button" data-original-title="" title=""><span class="glyphicon glyphicon-arrow-down btn-xs"></span>

                </button>
                <button class="btn btn-default" id="com-chilipeppr-widget-gcode-feedrate-reset" type="button" data-original-title="" title="">Reset</button>
                </span>
            </div>
        </div>
    </div>
    <!-- Need 2 col layout to get jumpscroller on right full height -->
    <table id="#com-chilipeppr-widget-gcode-body-2col" style="position:relative;">
        <tbody><tr>
            <td>
                <div id="com-chilipeppr-widget-gcode-body" class="panel-body ">
                    <div id="com-chilipeppr-elem-gcodedata"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/QPG2v/show/light/ -->




<style type="text/css">
    
  </style>
  


  
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-elem-gcodedata", ["chilipeppr_ready"], function () {
    return {
        id: "inline:com-chilipeppr-elem-gcodedata",
        url: "http://fiddle.jshell.net/jlauer/gY2pf/show/light/",
        fiddleurl: "http://jsfiddle.net/jlauer/gY2pf/",
        name: "Element / Gcode Data",
        desc: "List of Gcode commands from Wikipedia",
        publish: null,
        subscribe: null,
        init: function () {
            //console.log("init called");
            console.log("Element / Gcode Data done loading.");
        },
        gcode: [{
            code: "G00",
            desc: "Rapid positioning",
            m: "M",
            t: "T",
            info: "On 2- or 3-axis moves, G00 (unlike <a href=\"#G01\">G01</a>) traditionally does not necessarily move in a single straight line between start point and end point. It moves each axis at its max speed until its vector is achieved. Shorter vector usually finishes first (given similar axis speeds). This matters because it may yield a dog-leg or hockey-stick motion, which the programmer needs to consider depending on what obstacles are nearby, to avoid a crash. Some machines offer interpolated rapids as a feature for ease of programming (safe to assume a straight line)."
        }, {
            code: "G01",
            desc: "<a href=\"/wiki/Linear_interpolation\" title=\"Linear interpolation\">Linear interpolation</a>",
            m: "M",
            t: "T",
            info: "The most common workhorse code for feeding during a cut. The program specs the start and end points, and the control automatically calculates (<a href=\"/wiki/Interpolation\" title=\"Interpolation\">interpolates</a>) the intermediate points to pass through that will yield a straight line (hence \"<a href=\"/wiki/Linear\" title=\"Linear\" class=\"mw-redirect\">linear</a>\"). The control then calculates the angular velocities at which to turn the axis <a href=\"/wiki/Leadscrew\" title=\"Leadscrew\">leadscrews</a> via their servomotors or stepper motors. The computer performs thousands of calculations per second, and the motors react quickly to each input. Thus the actual toolpath of the machining takes place with the given feedrate on a path that is accurately linear to within very small limits."
        }, {
            code: "G02",
            desc: "Circular interpolation, clockwise",
            m: "M",
            t: "T",
            info: "Very similar in concept to G01. Again, the control <a href=\"/wiki/Interpolation\" title=\"Interpolation\">interpolates</a> intermediate points and commands the servo- or stepper motors to rotate the amount needed for the leadscrew to translate the motion to the correct tool tip positioning. This process repeated thousands of times per minute generates the desired toolpath. In the case of G02, the interpolation generates a circle rather than a line. As with G01, the actual toolpath of the machining takes place with the given feedrate on a path that accurately matches the ideal (in G02's case, a circle) to within very small limits. In fact, the interpolation is so precise (when all conditions are correct) that milling an interpolated circle can obviate operations such as drilling, and often even fine boring. <b>Addresses for radius or arc center:</b> G02 and G03 take either an <a href=\"#R\">R</a> address (for the radius desired on the part) or <a href=\"#I\">IJK</a> addresses (for the component vectors that define the vector from the arc start point to the arc center point). <b>Cutter comp:</b> On most controls you cannot start <a href=\"#G41\">G41</a> or <a href=\"#G42\">G42</a> in <a href=\"#G02\">G02</a> or <a href=\"#G03\">G03</a> modes. You must already have compensated in an earlier <a href=\"#G01\">G01</a> block. Often a short linear lead-in movement will be programmed, merely to allow cutter compensation before the main event, the circle-cutting, begins. <b>Full circles:</b> When the arc start point and the arc end point are identical, a 360Â° arc, a full circle, will be cut. (Some older controls cannot support this because arcs cannot cross between quadrants of the cartesian system. Instead, four quarter-circle arcs are programmed back-to-back.)"
        }, {
            code: "G03",
            desc: "Circular interpolation, counterclockwise",
            m: "M",
            t: "T",
            info: "Same corollary info as for G02."
        }, {
            code: "G04",
            desc: "Dwell",
            m: "M",
            t: "T",
            info: "Takes an address for dwell period (may be <a href=\"#X\">X</a>, <a href=\"#U\">U</a>, or <a href=\"#P\">P</a>). The dwell period is specified by a control parameter, typically set to <a href=\"/wiki/Millisecond\" title=\"Millisecond\">milliseconds</a>. Some machines can accept either X1.0 (<a href=\"/wiki/Second\" title=\"Second\">s</a>) or P1000 (<a href=\"/wiki/Millisecond\" title=\"Millisecond\">ms</a>), which are equivalent. <b><span id=\"Choosing_dwell_duration\">Choosing dwell duration</span></b>: Often the dwell needs only to last one or two full spindle rotations. This is typically much less than one second. Be aware when choosing a duration value that a long dwell is a waste of cycle time. In some situations it won't matter, but for high-volume repetitive production (over thousands of cycles), it is worth calculating that perhaps you only need 100 <a href=\"/wiki/Millisecond\" title=\"Millisecond\">ms</a>, and you can call it 200 to be safe, but 1000 is just a waste (too long)."
        }, {
            code: "G05",
            ext: "P10000",
            desc: "High-precision contour control (HPCC)",
            m: "M",
            t: "",
            info: "Uses a deep look-ahead <a href=\"/wiki/Data_buffer\" title=\"Data buffer\">buffer</a> and simulation processing to provide better axis movement acceleration and deceleration during contour milling"
        }, {
            code: "G05.1",
            ext: "Q1.",
            desc: "AI Advanced Preview Control",
            m: "M",
            t: "",
            info: "Uses a deep look-ahead <a href=\"/wiki/Data_buffer\" title=\"Data buffer\">buffer</a> and simulation processing to provide better axis movement acceleration and deceleration during contour milling"
        }, {
            code: "G06.1",
            ext: "G06.1",
            desc: "Non Uniform Rational B Spline Machining",
            m: "M",
            t: "",
            info: "Activates Non-Uniform Rational B Spline for complex curve and waveform machining (this code is confirmed in Mazatrol 640M ISO Programming)"
        }, {
            code: "G07",
            desc: "Imaginary axis designation",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G09",
            desc: "Exact stop check, non-modal",
            m: "M",
            t: "T",
            info: "The modal version is <a href=\"#G61\">G61</a>."
        }, {
            code: "G10",
            desc: "Programmable data input",
            m: "M",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G11",
            desc: "Data write cancel",
            m: "M",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G12",
            desc: "Full-circle interpolation, clockwise",
            m: "M",
            t: "",
            info: "Fixed cycle for ease of programming 360Â° circular interpolation with blend-radius lead-in and lead-out. Not standard on Fanuc controls."
        }, {
            code: "G13",
            desc: "Full-circle interpolation, counterclockwise",
            m: "M",
            t: "",
            info: "Fixed cycle for ease of programming 360Â° circular interpolation with blend-radius lead-in and lead-out. Not standard on Fanuc controls."
        }, {
            code: "G17",
            desc: "XY plane selection",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G18",
            desc: "ZX plane selection",
            m: "M",
            t: "T",
            info: "On most CNC lathes (built 1960s to 2000s), ZX is the only available plane, so no <a href=\"#G17\">G17</a> to <a href=\"#G19\">G19</a> codes are used. This is now changing as the era begins in which live tooling, multitask/multifunction, and mill-turn/turn-mill gradually become the \"new normal\". But the simpler, traditional form factor will probably not disappearâ€”it will just move over to make room for the newer configurations. See also <a href=\"#V\">V</a> address."
        }, {
            code: "G19",
            desc: "YZ plane selection",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G20",
            desc: "Programming in <a href=\"/wiki/Inch\" title=\"Inch\">inches</a>",
            m: "M",
            t: "T",
            info: "Somewhat uncommon except in USA and (to lesser extent) Canada and UK. However, in the global marketplace, competence with both G20 and G21 always stands some chance of being necessary at any time. The usual minimum increment in G20 is one ten-thousandth of an inch (0.0001\"), which is a larger distance than the usual minimum increment in G21 (one thousandth of a millimeter, .001&nbsp;mm, that is, one <a href=\"/wiki/Micrometre\" title=\"Micrometre\">micrometre</a>). This physical difference sometimes favors G21 programming."
        }, {
            code: "G21",
            desc: "Programming in <a href=\"/wiki/Millimeter\" title=\"Millimeter\" class=\"mw-redirect\">millimeters</a> (mm)",
            m: "M",
            t: "T",
            info: "Prevalent worldwide. However, in the global marketplace, competence with both G20 and G21 always stands some chance of being necessary at any time."
        }, {
            code: "G28",
            desc: "Return to home position (machine zero, aka machine reference point)",
            m: "M",
            t: "T",
            info: "Takes X Y Z addresses which define the intermediate point that the tool tip will pass through on its way home to machine zero. They are in terms of part zero (aka program zero), NOT machine zero."
        }, {
            code: "G30",
            desc: "Return to secondary home position (machine zero, aka machine reference point)",
            m: "M",
            t: "T",
            info: "Takes a P address specifying <i>which</i> machine zero point is desired, <i>if</i> the machine has several secondary points (P1 to P4). Takes X Y Z addresses which define the intermediate point that the tool tip will pass through on its way home to machine zero. They are in terms of part zero (aka program zero), NOT machine zero."
        }, {
            code: "G31",
            desc: "Skip function (used for probes and tool length measurement systems)",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G32",
            desc: "Single-point threading, longhand style (if not using a cycle, e.g., <a href=\"#G76_thread_on_lathe\">G76</a>)",
            m: "",
            t: "T",
            info: "Similar to <a href=\"#G01\">G01</a> linear interpolation, except with automatic spindle synchronization for <a href=\"/wiki/Threading_(manufacturing)#Single-point_threading\" title=\"Threading (manufacturing)\">single-point threading</a>."
        }, {
            code: "G33",
            desc: "Constant-<a href=\"/wiki/Screw_thread#Lead.2C_pitch.2C_and_starts\" title=\"Screw thread\">pitch</a> threading",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G33 T",
            desc: "Single-point threading, longhand style (if not using a cycle, e.g., <a href=\"#G76_thread_on_lathe\">G76</a>)",
            m: "",
            t: "T",
            info: "Some lathe controls assign this mode to G33 rather than G32."
        }, {
            code: "G34",
            desc: "Variable-pitch threading",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G40",
            desc: "Tool radius compensation off",
            m: "M",
            t: "T",
            info: "Turn off <a href=\"/wiki/Cutter_location\" title=\"Cutter location\">cutter radius compensation (CRC)</a>. Cancels G41 or G42."
        }, {
            code: "G41",
            desc: "Tool radius compensation left",
            m: "M",
            t: "T",
            info: "Turn on <a href=\"/wiki/Cutter_location\" title=\"Cutter location\">cutter radius compensation (CRC)</a>, left, for climb milling.<br><b>Milling:</b> Given righthand-helix cutter and <a href=\"#M03\">M03</a> spindle direction, G41 corresponds to <a href=\"/wiki/Milling_cutter#Conventional_milling_versus_climb_milling\" title=\"Milling cutter\">climb milling (down milling)</a>. Takes an address (<a href=\"#D\">D</a> or <a href=\"#H\">H</a>) that calls an offset register value for radius.<br><b>Turning:</b> Often needs no D or H address on lathes, because whatever tool is active automatically calls its geometry offsets with it. (Each turret station is bound to its geometry offset register.)<p>G41 and G42 for milling has been partially automated and obviated (although not completely) since <a href=\"/wiki/Computer-aided_manufacturing\" title=\"Computer-aided manufacturing\">CAM</a> programming has become more common. CAM systems allow the user to program as if with a zero-diameter cutter. The fundamental concept of cutter radius compensation is still in play (i.e., that the surface produced will be distance R away from the cutter center), but the programming mindset is different; the human does not choreograph the toolpath with conscious, painstaking attention to G41, G42, and G40, because the CAM software takes care of it. The software has various CRC mode selections, such as <i>computer, control, wear, reverse wear, off</i>, some of which do not use G41/G42 at all (good for roughing, or wide finish tolerances), and others which use it so that the wear offset can still be tweaked at the machine (better for tight finish tolerances).</p>\""
        }, {
            code: "G42",
            desc: "Tool radius compensation right",
            m: "M",
            t: "T",
            info: "Turn on <a href=\"/wiki/Cutter_location\" title=\"Cutter location\">cutter radius compensation (CRC)</a>, right, for conventional milling. Similar corollary info as for <a href=\"#G41\">G41</a>. Given righthand-helix cutter and M03 spindle direction, G42 corresponds to <a href=\"/wiki/Milling_cutter#Conventional_milling_versus_climb_milling\" title=\"Milling cutter\">conventional milling (up milling)</a>."
        }, {
            code: "G43",
            desc: "Tool height offset compensation negative",
            m: "M",
            t: "",
            info: "Takes an address, usually H, to call the tool length offset register value. The value is <i>negative</i> because it will be <i>added</i> to the gauge line position. G43 is the commonly used version (vs G44)."
        }, {
            code: "G44",
            desc: "Tool height offset compensation positive",
            m: "M",
            t: "",
            info: "Takes an address, usually H, to call the tool length offset register value. The value is <i>positive</i> because it will be <i>subtracted</i> from the gauge line position. G44 is the seldom-used version (vs G43)."
        }, {
            code: "G45",
            desc: "Axis offset single increase",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G46",
            desc: "Axis offset single decrease",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G47",
            desc: "Axis offset double increase",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G48",
            desc: "Axis offset double decrease",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G49",
            desc: "Tool length offset compensation cancel",
            m: "M",
            t: "",
            info: "Cancels <a href=\"#G43\">G43</a> or <a href=\"#G44\">G44</a>."
        }, {
            code: "G50",
            ext: "RPM clamp",
            desc: "Define the maximum spindle speed",
            m: "",
            t: "T",
            info: "Takes an <a href=\"#S\">S</a> address integer which is interpreted as rpm. Without this feature, <a href=\"#G96\">G96</a> mode (CSS) would rev the spindle to \"wide open throttle\" when closely approaching the axis of rotation."
        }, {
            code: "G50 Scaling",
            ext: "Scaling off",
            desc: "Scaling function cancel",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G50 Position",
            ext: "Position register",
            desc: "Position register (programming of vector from part zero to tool tip)",
            m: "",
            t: "T",
            info: "Position register is one of the original methods to relate the part (program) coordinate system to the tool position, which indirectly relates it to the machine coordinate system, the only position the control really \"knows\". Not commonly programmed anymore because <a href=\"#G54_to_G59\">G54 to G59</a> (WCSs) are a better, newer method. Called via G50 for turning, <a href=\"#G92_position_register\">G92</a> for milling. Those G addresses also have alternate meanings (which see). Position register can still be useful for datum shift programming. The \"manual absolute\" switch, which has very few useful applications in WCS contexts, was more useful in position register contexts, because it allowed the operator to move the tool to a certain distance from the part (for example, by touching off a 2.0000\" gage) and then declare to the control what the distance-to-go shall be (2.0000)."
        }, {
            code: "G52",
            desc: "Local coordinate system (LCS)",
            m: "M",
            t: "",
            info: "Temporarily shifts program zero to a new location. It is simply \"an offset from an offset\", that is, an additional offset added onto the <a href=\"#G54_to_G59\">WCS</a> offset. This simplifies programming in some cases. The typical example is moving from part to part in a multipart setup. With <b>G54</b> active, <b>G52 X140.0 Y170.0</b> shifts program zero 140&nbsp;mm over in X and 170&nbsp;mm over in Y. When the part \"over there\" is done, <b>G52 X0 Y0</b> returns program zero to normal G54 (by reducing G52 offset to nothing). The same result can also be achieved (1) using multiple WCS origins, G54/G55/G56/G57/G58/G59; (2) on newer controls, G54.1 P1/P2/P3/etc. (all the way up to P48); or (3) using <a href=\"#G10\">G10</a> for programmable data input, in which the program can write new offset values to the offset registers. Which method to use depends on shop-specific application."
        }, {
            code: "G53",
            desc: "Machine coordinate system",
            m: "M",
            t: "T",
            info: "Takes absolute coordinates (X,Y,Z,A,B,C) with reference to machine zero rather than program zero. Can be helpful for tool changes. Nonmodal and absolute only. Subsequent blocks are interpreted as \"back to <a href=\"#G54_to_G59\">G54</a>\" even if it is not explicitly programmed."
        }, {
            code: "G54",
            ext: "G54 to G59",
            desc: "Work coordinate systems (WCSs)",
            m: "M",
            t: "T",
            info: "Have largely replaced position register (<a href=\"#G50_position_register\">G50</a> and <a href=\"#G92_position_register\">G92</a>). Each tuple of axis offsets relates program zero directly to machine zero. Standard is 6 tuples (G54 to G59), with optional extensibility to 48 more via G54.1 P1 to P48."
        }, {
            code: "G55",
            ext: "G54 to G59",
            desc: "Work coordinate systems (WCSs)",
            m: "M",
            t: "T",
            info: "Have largely replaced position register (<a href=\"#G50_position_register\">G50</a> and <a href=\"#G92_position_register\">G92</a>). Each tuple of axis offsets relates program zero directly to machine zero. Standard is 6 tuples (G54 to G59), with optional extensibility to 48 more via G54.1 P1 to P48."
        }, {
            code: "G56",
            ext: "G54 to G59",
            desc: "Work coordinate systems (WCSs)",
            m: "M",
            t: "T",
            info: "Have largely replaced position register (<a href=\"#G50_position_register\">G50</a> and <a href=\"#G92_position_register\">G92</a>). Each tuple of axis offsets relates program zero directly to machine zero. Standard is 6 tuples (G54 to G59), with optional extensibility to 48 more via G54.1 P1 to P48."
        }, {
            code: "G57",
            ext: "G54 to G59",
            desc: "Work coordinate systems (WCSs)",
            m: "M",
            t: "T",
            info: "Have largely replaced position register (<a href=\"#G50_position_register\">G50</a> and <a href=\"#G92_position_register\">G92</a>). Each tuple of axis offsets relates program zero directly to machine zero. Standard is 6 tuples (G54 to G59), with optional extensibility to 48 more via G54.1 P1 to P48."
        }, {
            code: "G58",
            ext: "G54 to G59",
            desc: "Work coordinate systems (WCSs)",
            m: "M",
            t: "T",
            info: "Have largely replaced position register (<a href=\"#G50_position_register\">G50</a> and <a href=\"#G92_position_register\">G92</a>). Each tuple of axis offsets relates program zero directly to machine zero. Standard is 6 tuples (G54 to G59), with optional extensibility to 48 more via G54.1 P1 to P48."
        }, {
            code: "G59",
            ext: "G54 to G59",
            desc: "Work coordinate systems (WCSs)",
            m: "M",
            t: "T",
            info: "Have largely replaced position register (<a href=\"#G50_position_register\">G50</a> and <a href=\"#G92_position_register\">G92</a>). Each tuple of axis offsets relates program zero directly to machine zero. Standard is 6 tuples (G54 to G59), with optional extensibility to 48 more via G54.1 P1 to P48."
        }, {
            code: "G54.1",
            ext: "P1 to P48",
            ext: "G54.1 P1 to P48",
            desc: "Extended work coordinate systems",
            m: "M",
            t: "T",
            info: "Up to 48 more WCSs besides the 6 provided as standard by G54 to G59. Note floating-point extension of G-code data type (formerly all integers). Other examples have also evolved (e.g., <a href=\"#G84.2\">G84.2</a>). Modern controls have the <a href=\"/wiki/Computer_hardware\" title=\"Computer hardware\">hardware</a> to handle it."
        }, {
            code: "G61",
            desc: "Exact stop check, modal",
            m: "M",
            t: "T",
            info: "Can be canceled with <a href=\"#G64\">G64</a>. The non-modal version is <a href=\"#G09\">G09</a>."
        }, {
            code: "G62",
            desc: "Automatic corner override",
            m: "M",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G64",
            desc: "Default cutting mode (cancel exact stop check mode)",
            m: "M",
            t: "T",
            info: "Cancels <a href=\"#G61\">G61</a>."
        }, {
            code: "G70",
            desc: "Fixed cycle, multiple repetitive cycle, for finishing (including contours)",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G71",
            desc: "Fixed cycle, multiple repetitive cycle, for roughing (Z-axis emphasis)",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G72",
            desc: "Fixed cycle, multiple repetitive cycle, for roughing (X-axis emphasis)",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G73",
            ext: "rough_turn_pattern_repeat",
            desc: "Fixed cycle, multiple repetitive cycle, for roughing, with pattern repetition",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G73 peck",
            ext: "peck drill",
            desc: "Peck drilling cycle for milling â€“ high-speed (NO full retraction from pecks)",
            m: "M",
            t: "",
            info: "Retracts only as far as a clearance increment (system parameter). For when chipbreaking is the main concern, but chip clogging of flutes is not. Compare <a href=\"#G83\">G83</a>."
        }, {
            code: "G74",
            ext: "pecking",
            desc: "Peck drilling cycle for turning",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G74 tapping",
            desc: "Tapping cycle for milling, <a href=\"/wiki/Screw_thread#Handedness\" title=\"Screw thread\">lefthand thread</a>, <a href=\"#M04\">M04 spindle direction</a>",
            m: "M",
            t: "",
            info: "See notes at <a href=\"#G84\">G84</a>."
        }, {
            code: "G75",
            desc: "Peck grooving cycle for turning",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G76",
            ext: "bore_on_mill",
            desc: "Fine boring cycle for milling",
            m: "M",
            t: "",
            info: "Includes OSS and shift (oriented spindle stop and shift tool off centerline for retraction)"
        }, {
            code: "G76 thread",
            ext: "thread_on_lathe",
            desc: "Threading cycle for turning, multiple repetitive cycle",
            m: "",
            t: "T",
            info: "&nbsp;"
        }, {
            code: "G80",
            desc: "Cancel canned cycle",
            m: "M",
            t: "T",
            info: "<b>Milling:</b> Cancels all cycles such as <a href=\"#G73_peck_drill\">G73</a>, <a href=\"#G81\">G81</a>, <a href=\"#G83\">G83</a>, etc. Z-axis returns either to Z-initial level or R&nbsp;level, as programmed (<a href=\"#G98_return_to_initial\">G98</a> or <a href=\"#G99_return_to_R_level\">G99</a>, respectively).<br><b>Turning:</b> Usually not needed on lathes, because a new group-1 G address (<a href=\"#G00\">G00</a> to <a href=\"#G03\">G03</a>) cancels whatever cycle was active.\""
        }, {
            code: "G81",
            desc: "Simple drilling cycle",
            m: "M",
            t: "",
            info: "No dwell built in"
        }, {
            code: "G82",
            desc: "Drilling cycle with dwell",
            m: "M",
            t: "",
            info: "Dwells at hole bottom (Z-depth) for the number of <a href=\"/wiki/Millisecond\" title=\"Millisecond\">milliseconds</a> specified by the <a href=\"#P\">P</a> address. Good for when hole bottom finish matters. Good for spot drilling because the divot will be certain to clean up evenly. Consider the \"<a href=\"#Choosing_dwell_duration\">choosing dwell duration</a>\" note at <a href=\"#G04\">G04</a>."
        }, {
            code: "G83",
            desc: "Peck drilling cycle (full retraction from pecks)",
            m: "M",
            t: "",
            info: "Returns to R-level after each peck. Good for clearing flutes of <a href=\"/wiki/Swarf\" title=\"Swarf\">chips</a>. Compare <a href=\"#G73_peck_drill\">G73</a>."
        }, {
            code: "G84",
            desc: "<a href=\"/wiki/Tap_and_die\" title=\"Tap and die\">Tapping</a> cycle, <a href=\"/wiki/Screw_thread#Handedness\" title=\"Screw thread\">righthand thread</a>, <a href=\"#M03\">M03</a> spindle direction",
            m: "M",
            t: "",
            info: "<a href=\"#G74_tapping\">G74</a> and G84 are the righthand and lefthand \"pair\" for old-school tapping with a non-rigid toolholder (\"tapping head\" style). Compare the rigid tapping \"pair\", <a href=\"#G84.2\">G84.2</a> and <a href=\"#G84.3\">G84.3</a>."
        }, {
            code: "G84.2",
            ext: "G84.2",
            desc: "Tapping cycle, <a href=\"/wiki/Screw_thread#Handedness\" title=\"Screw thread\">righthand thread</a>, <a href=\"#M03\">M03</a> spindle direction, rigid toolholder",
            m: "M",
            t: "",
            info: "See notes at <a href=\"#G84\">G84</a>. Rigid tapping synchronizes speed and feed according to the desired thread helix. That is, it synchronizes degrees of spindle rotation with microns of axial travel. Therefore it can use a rigid toolholder to hold the tap. This feature is not available on old machines or newer low-end machines, which must use \"tapping head\" motion (<a href=\"#G74_tapping\">G74</a>/<a href=\"#G84\">G84</a>)."
        }, {
            code: "G84.3",
            ext: "G84.3",
            desc: "Tapping cycle, <a href=\"/wiki/Screw_thread#Handedness\" title=\"Screw thread\">lefthand thread</a>, <a href=\"#M04\">M04</a> spindle direction, rigid toolholder",
            m: "M",
            t: "",
            info: "See notes at <a href=\"#G84\">G84</a> and <a href=\"#G84.2\">G84.2</a>."
        }, {
            code: "G85",
            desc: "boring cycle, feed in/feed out",
            m: "M",
            t: "&nbsp;",
            info: "<ul><li>Good cycle for a reamer.</li><li>In some cases good for single-point boring tool, although in other cases the lack of depth of cut on the way back out is bad for surface finish, in which case, <a href=\"#G76_bore_on_mill\">G76</a> (OSS/shift) can be used instead.</li><li>If need dwell at hole bottom, see <a href=\"#G89\">G89</a>.</li></ul>\""
        }, {
            code: "G86",
            desc: "boring cycle, feed in/spindle stop/rapid out",
            m: "M",
            t: "",
            info: "Boring tool will leave a slight score mark on the way back out. Appropriate cycle for some applications; for others, <a href=\"#G76_bore_on_mill\">G76</a> (OSS/shift) can be used instead."
        }, {
            code: "G87",
            desc: "boring cycle, backboring",
            m: "M",
            t: "",
            info: "For <a href=\"/wiki/Boring_(manufacturing)\" title=\"Boring (manufacturing)\">backboring</a>. Returns to initial level only (<a href=\"#G98_return_to_initial\">G98</a>); this cycle cannot use <a href=\"#G99_return_to_R_level\">G99</a> because its <a href=\"#R\">R level</a> is on the far side of the part, away from the spindle headstock."
        }, {
            code: "G88",
            desc: "boring cycle, feed in/spindle stop/manual operation",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G89",
            desc: "boring cycle, feed in/dwell/feed out",
            m: "M",
            t: "",
            info: "G89 is like <a href=\"#G85\">G85</a> but with dwell added at bottom of hole."
        }, {
            code: "G90",
            ext: "absolute",
            desc: "Absolute programming",
            m: "M",
            t: "T (B)",
            info: "Positioning defined with reference to part zero.<br><b>Milling:</b> Always as above.<br><b>Turning:</b> Sometimes as above (Fanuc group type B and similarly designed), but on most lathes (Fanuc group type A and similarly designed), G90/G91 are not used for absolute/incremental modes. Instead, <a href=\"#U\">U</a> and <a href=\"#W\">W</a> are the incremental addresses and <a href=\"#X\">X</a> and <a href=\"#Z\">Z</a> are the absolute addresses. On these lathes, G90 is instead a fixed cycle address for roughing."
        }, {
            code: "G90 roughing",
            desc: "Fixed cycle, simple cycle, for roughing (Z-axis emphasis)",
            m: "",
            t: "T (A)",
            info: "When not serving for absolute programming (above)"
        }, {
            code: "G91",
            desc: "Incremental programming",
            m: "M",
            t: "T (B)",
            info: "Positioning defined with reference to previous position.<br><b>Milling:</b> Always as above.<br><b>Turning:</b> Sometimes as above (Fanuc group type B and similarly designed), but on most lathes (Fanuc group type A and similarly designed), G90/G91 are not used for absolute/incremental modes. Instead, <a href=\"#U\">U</a> and <a href=\"#W\">W</a> are the incremental addresses and <a href=\"#X\">X</a> and <a href=\"#Z\">Z</a> are the absolute addresses. On these lathes, G90 is a fixed cycle address for roughing."
        }, {
            code: "G92",
            ext: "position_register",
            desc: "Position register (programming of vector from part zero to tool tip)",
            m: "M",
            t: "T (B)",
            info: "Same corollary info as at <a href=\"#G50_position_register\">G50 position register</a>.<br><b>Milling:</b> Always as above.<br><b>Turning:</b> Sometimes as above (Fanuc group type B and similarly designed), but on most lathes (Fanuc group type A and similarly designed), position register is <a href=\"#G50_position_register\">G50</a>."
        }, {
            code: "G92 threading",
            desc: "Threading cycle, simple cycle",
            m: "",
            t: "T (A)",
            info: "&nbsp;\""
        }, {
            code: "G94",
            ext: "feed_per_minute",
            desc: "Feedrate per minute",
            m: "M",
            t: "T (B)",
            info: "On group type A lathes, feedrate per minute is <a href=\"#G98_feed_per_minute\">G98</a>."
        }, {
            code: "G94 roughing",
            desc: "Fixed cycle, simple cycle, for roughing (<a href=\"#X\">X</a>-axis emphasis)",
            m: "",
            t: "T (A)",
            info: "When not serving for feedrate per minute (above)"
        }, {
            code: "G95",
            ext: "feed_per_rev",
            desc: "Feedrate per revolution",
            m: "M",
            t: "T (B)",
            info: "On group type A lathes, feedrate per revolution is <a href=\"#G99_feed_per_rev\">G99</a>.\""
        }, {
            code: "G96",
            desc: "Constant surface speed (CSS)",
            m: "",
            t: "T",
            info: "Varies spindle speed automatically to achieve a constant surface speed. See <a href=\"/wiki/Speeds_and_feeds\" title=\"Speeds and feeds\">speeds and feeds</a>. Takes an <a href=\"#S\">S</a> address integer, which is interpreted as <a href=\"/wiki/Surface_feet_per_minute\" title=\"Surface feet per minute\">sfm</a> in <a href=\"#G20\">G20</a> mode or as m/min in <a href=\"#G21\">G21</a> mode."
        }, {
            code: "G97",
            desc: "Constant spindle speed",
            m: "M",
            t: "T",
            info: "Takes an S address integer, which is interpreted as rev/min (rpm). The default speed mode per system parameter if no mode is programmed."
        }, {
            code: "G98",
            ext: "return_to_initial",
            desc: "Return to initial Z level in canned cycle",
            m: "M",
            t: "",
            info: "&nbsp;\""
        }, {
            code: "G98 feed",
            ext: "feed_per_minute",
            desc: "Feedrate per minute (group type A)",
            m: "",
            t: "T (A)",
            info: "Feedrate per minute is <a href=\"#G94_feed_per_minute\">G94</a> on group type B."
        }, {
            code: "G99",
            ext: "return_to_R_level",
            desc: "Return to <a href=\"#R\">R level</a> in canned cycle",
            m: "M",
            t: "",
            info: "&nbsp;"
        }, {
            code: "G99 feed",
            ext: "feed_per_rev",
            desc: "Feedrate per revolution (group type A)",
            m: "",
            t: "T (A)",
            info: "Feedrate per revolution is <a href=\"#G95_feed_per_rev\">G95</a> on group type B."
        }, {
            code: "M00",
            ext: "",
            desc: "Compulsory stop",
            m: "M",
            t: "T",
            info: "Non-optionalâ€”machine will always stop upon reaching M00 in the program execution."
        }, {
            code: "M01",
            ext: "",
            desc: "Optional stop",
            m: "M",
            t: "T",
            info: "Machine will only stop at M01 if operator has pushed the optional stop button."
        }, {
            code: "M02",
            ext: "",
            desc: "End of program",
            m: "M",
            t: "T",
            info: "Program ends; execution may or may not return to program top (depending on the control); may or may not reset register values. M02 was the original program-end code, now considered obsolete, but still supported for backward compatibility.[4] Many modern controls treat M02 as equivalent to M30.[4] See M30 for additional discussion of control status upon executing M02 or M30."
        }, {
            code: "M03",
            ext: "",
            desc: "Spindle on (clockwise rotation)",
            m: "M",
            t: "T",
            info: "The speed of the spindle is determined by the address S, in either revolutions per minute (G97 mode; default) or surface feet per minute or [surface] meters per minute (G96 mode [CSS] under either G20 or G21). The right-hand rule can be used to determine which direction is clockwise and which direction is counter-clockwise. Right-hand-helix screws moving in the tightening direction (and right-hand-helix flutes spinning in the cutting direction) are defined as moving in the M03 direction, and are labeled \"clockwise\" by convention. The M03 direction is always M03 regardless of local vantage point and local CW/CCW distinction."
        }, {
            code: "M04",
            ext: "",
            desc: "Spindle on (counterclockwise rotation)",
            m: "M",
            t: "T",
            info: "The speed of the spindle is determined by the address S, in either revolutions per minute (G97 mode; default) or surface feet per minute or [surface] meters per minute (G96 mode [CSS] under either G20 or G21). The right-hand rule can be used to determine which direction is clockwise and which direction is counter-clockwise. Right-hand-helix screws moving in the tightening direction (and right-hand-helix flutes spinning in the cutting direction) are defined as moving in the M03 direction, and are labeled \"clockwise\" by convention. The M03 direction is always M03 regardless of local vantage point and local CW/CCW distinction."
        }, {
            code: "M05",
            ext: "",
            desc: "Spindle stop",
            m: "M",
            t: "T",
            info: ""
        }, {
            code: "M06",
            ext: "",
            desc: "Automatic tool change (ATC)",
            m: "M",
            t: "T",
            info: "Many lathes do not use M06 because the T address itself indexes the turret. Programming on any particular machine tool requires knowing which method that machine uses. To understand how the T address works and how it interacts (or not) with M06, one must study the various methods, such as lathe turret programming, ATC fixed tool selection, ATC random memory tool selection, the concept of <i>next tool waiting</i>, and empty tools. These concepts are taught in textbooks such as Smid,[1] and online multimedia (videos, simulators, etc.); all of these teaching resources are usually paywalled to pay back the costs of their development. They are used in training classes for operators, both on-site and remotely (e.g., Tooling University)."
        }, {
            code: "M07",
            ext: "",
            desc: "Coolant on (mist)",
            m: "M",
            t: "T",
            info: ""
        }, {
            code: "M08",
            ext: "",
            desc: "Coolant on (flood)",
            m: "M",
            t: "T",
            info: ""
        }, {
            code: "M09",
            ext: "",
            desc: "Coolant off",
            m: "M",
            t: "T",
            info: ""
        }, {
            code: "M10",
            ext: "",
            desc: "Pallet clamp on",
            m: "M",
            t: "T",
            info: "For machining centers with pallet changers"
        }, {
            code: "M11",
            ext: "",
            desc: "Pallet clamp off",
            m: "M",
            t: "T",
            info: "For machining centers with pallet changers"
        }, {
            code: "M13",
            ext: "",
            desc: "Spindle on (clockwise rotation) and coolant on (flood)",
            m: "M",
            t: "",
            info: "This one M-code does the work of both M03 and M08. It is not unusual for specific machine models to have such combined commands, which make for shorter, more quickly written programs."
        }, {
            code: "M19",
            ext: "",
            desc: "Spindle orientation",
            m: "M",
            t: "T",
            info: "Spindle orientation is more often called within cycles (automatically) or during setup (manually), but it is also available under program control via M19. The abbreviation OSS (oriented spindle stop) may be seen in reference to an oriented stop within cycles."
        }, {
            code: "%",
            ext: "",
            desc: "Start or End of Program",
            m: "M",
            t: "T",
            info: "Demarcates the start and end of a program. Originally indicated the start and end of tape feed on NC machines, generally but not always required to be present on newer machines."
        }, {
            code: "M30",
            ext: "",
            desc: "End of program, with return to program top",
            m: "M",
            t: "T",
            info: "Today M30 is considered the standard program-end code, and will return execution to the top of the program. Today most controls also still support the original program-end code, M02, usually by treating it as equivalent to M30. Additional info: Compare M02 with M30. First, M02 was created, in the days when the punched tape was expected to be short enough to be spliced into a continuous loop (which is why on old controls, M02 triggered no tape rewinding).[6] The other program-end code, M30, was added later to accommodate longer punched tapes, which were wound on a reel and thus needed rewinding before another cycle could start.[6] On many newer controls, there is no longer a difference in how the codes are executedâ€”both act like M30."
        }, {
            code: "M82",
            ext: "",
            desc: "Set extruder to absolute mode",
            m: "M",
            t: "",
            info: "Makes the extruder interpret extrusion as absolute positions. This is the default in repetier.",
            src: "Reprap.org"
        }, {
            code: "M82",
            ext: "",
            desc: "Set extruder to relative mode",
            m: "M",
            t: "",
            info: "Makes the extruder interpret extrusion values as relative positions.",
            src: "Reprap.org"
        }, {
            code: "M84",
            ext: "",
            desc: "Stop idle hold",
            m: "M",
            t: "",
            info: "Stop the idle hold on all axis and extruder. In some cases the idle hold causes annoying noises, which can be stopped by disabling the hold. Be aware that by disabling idle hold during printing, you will get quality issues. This is recommended only in between or after printjobs.",
            src: "Reprap.org"
        }, 

        ],
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/QPG2v/show/light/ -->
</div>
                    <div id="dragdrop" class="hidden"></div>
                    <div id="com-chilipeppr-widget-gcode-tmparea" class="hidden"></div>
                    <div id="showstart"><button class="btn btn-default btn-xs" style="width:100%;margin-bottom:0;" data-original-title="" title=""><span class="glyphicon glyphicon-chevron-up"></span></button></div>
                    <table id="com-chilipeppr-widget-gcode-tbl" class="table table-condensed" style="width:100%;">
                        <thead>
                            <tr>
                                <th colspan="3" style="border:0;padding:0;margin:0">
                                    <div style="height:0px;">
                                        <!--This makes sure the table width is the full width of the container-->&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">1</td><td class="g"><span class="gcode-comment">( Made using CamBam - http://www.cambam.co.uk )</span></td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">2</td><td class="g">( chilipeppr logo gcode v2 6/10/2014 10:45:27 PM ) <span class="com-chilipeppr-gcode-tip hidden"></span></td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">3</td><td class="g"><span class="gcode-comment">( T0 : 0.0 )</span></td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">4</td><td class="g">G21 G90 G64 G40</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">5</td><td class="g">G0 Z3.0</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">6</td><td class="g"><span class="gcode-comment">( T0 : 0.0 )</span></td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">7</td><td class="g">T0 M6</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">8</td><td class="g"><span class="gcode-comment">( Profile1 )</span></td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">9</td><td class="g">G17</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">10</td><td class="g">M3 S1000</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">11</td><td class="g">G0 X39.2659 Y-3.4776</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">12</td><td class="g">G0 Z1.5</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">13</td><td class="g">G1 F300.0 Z0.0</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">14</td><td class="g">G2 F800.0 X39.0719 Y-3.7614 I-2.0806 J1.2144</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">15</td><td class="g">G2 X38.4511 Y-4.2692 I-1.5584 J1.2717</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">16</td><td class="g">G2 X37.6702 Y-4.452 I-0.7659 J1.5128</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">17</td><td class="g">G2 X36.9056 Y-4.2757 I-0.0154 J1.6797</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">18</td><td class="g">G2 X36.2959 Y-3.7819 I0.9002 J1.7348</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">19</td><td class="g">G2 X35.8365 Y-2.7942 I1.8061 J1.4408</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">20</td><td class="g">G2 X35.7284 Y-1.7102 I4.813 J1.0272</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">21</td><td class="g">G2 X35.8483 Y-0.5925 I4.765 J0.0543</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">22</td><td class="g">G2 X36.3301 Y0.4231 I2.4581 J-0.5442</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">23</td><td class="g">G2 X36.9417 Y0.9543 I1.7404 J-1.3862</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">24</td><td class="g">G2 X37.7249 Y1.1615 I0.7787 J-1.3594</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">25</td><td class="g">G2 X38.4864 Y0.9761 I0.0129 J-1.603</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">26</td><td class="g">G2 X39.0856 Y0.4709 I-0.956 J-1.7421</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">27</td><td class="g">G2 X39.5484 Y-0.5198 I-1.8693 J-1.4767</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">28</td><td class="g">G2 X39.6599 Y-1.6076 I-4.7114 J-1.0326</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">29</td><td class="g">G2 X39.5479 Y-2.7342 I-5.13 J-0.0589</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">30</td><td class="g">G2 X39.2659 Y-3.4776 I-2.3626 J0.471</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">31</td><td class="g">G0 Z3.0</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">32</td><td class="g">G0 X31.8196 Y-2.4008</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">33</td><td class="g">G0 Z1.5</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">34</td><td class="g">G1 F300.0 Z0.0</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">35</td><td class="g">G2 F800.0 X31.7601 Y-2.7342 I-5.0775 J0.7343</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">36</td><td class="g">G2 X31.2841 Y-3.7614 I-2.3626 J0.471</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">37</td><td class="g">G2 X30.6633 Y-4.2692 I-1.5584 J1.2717</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">38</td><td class="g">G2 X29.8824 Y-4.452 I-0.7659 J1.5128</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">39</td><td class="g">G2 X29.1178 Y-4.2757 I-0.0154 J1.6797</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">40</td><td class="g">G2 X28.5081 Y-3.7819 I0.9002 J1.7348</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">41</td><td class="g">G2 X28.0487 Y-2.7942 I1.8061 J1.4408</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">42</td><td class="g">G2 X27.9406 Y-1.7102 I4.813 J1.0272</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">43</td><td class="g">G2 X28.0605 Y-0.5925 I4.765 J0.0543</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">44</td><td class="g">G2 X28.5423 Y0.4231 I2.4581 J-0.5442</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">45</td><td class="g">G2 X29.154 Y0.9543 I1.7404 J-1.3862</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">46</td><td class="g">G2 X29.9371 Y1.1615 I0.7787 J-1.3594</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">47</td><td class="g">G2 X30.6986 Y0.9761 I0.0129 J-1.603</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">48</td><td class="g">G2 X31.2978 Y0.4709 I-0.956 J-1.7421</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">49</td><td class="g">G2 X31.7606 Y-0.5198 I-1.8693 J-1.4767</td></tr><tr><td><span class="glyphicon glyphicon-ok"></span></td><td class="indx">50</td><td class="g">G2 X31.8721 Y-1.6076 I-4.7114 J-1.0326</td></tr></tbody>
                    </table>
                    <div id="showend"><button class="btn btn-default btn-xs" style="width:100%;margin-bottom:0;" data-original-title="" title=""><span class="glyphicon glyphicon-chevron-down"></span></button></div>
                </div>
            </td>
            <td class="com-chilipeppr-gcode-jumpscroll" style="border:0px solid red;position:relative;width:21px;">
                <!--<div class="com-chilipeppr-gcode-jumpscroll" style="position:absolute;width:25px; top:0; height:100%; border:1px solid green;">-->
                    <div class="paginator" style="top:10%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""> <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:20%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""> <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:30%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""> <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:40%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""> <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:50%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""> <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:60%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""> <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:70%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""><span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator" style="top:80%;">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""><span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </div>
                    <div class="paginator paginator-first">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""><span class="glyphicon glyphicon-chevron-up"></span>
                        </button>
                    </div>
                    <div class="paginator paginator-last">
                        <button type="button" class="btn btn-xs btn-default " data-original-title="" title=""><span class="glyphicon glyphicon-chevron-down"></span>
                        </button>
                    </div>
                <!--</div>-->
            </td>
        </tr>
    </tbody></table>
    <div id="com-chilipeppr-widget-gcode-footer" class="panel-footer ">
        <div class="row ">
            <div class="col-xs-3 stats-hdr ">Lines</div>
            <div class="col-xs-3 stats-hdr ">Showing</div>
            <div class="col-xs-3 stats-hdr ">Sent</div>
            <div class="col-xs-3 stats-hdr ">Remaining</div>
        </div>
        <div class="row ">
            <div id="gcode-lines" class="col-xs-3 stats-val">572</div>
            <div id="gcode-lines-showing" class="col-xs-3 stats-val">1 - 50</div>
            <div id="gcode-lines-sent" class="col-xs-3 stats-val">0</div>
            <div id="gcode-lines-remaining" class="col-xs-3 stats-val">572</div>
        </div>
    </div>
<div class="ui-resizable-handle ui-resizable-e" style="z-index: 90;"></div><div class="ui-resizable-handle ui-resizable-s" style="z-index: 90;"></div><div class="ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se" style="z-index: 90;"></div></div>
<div class="modal fade " id="com-chilipeppr-widget-gcode-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h4 class="modal-title">Gcode Sender Options</h4>
      </div>
      <div class="modal-body">
          
          <form class="form-horizontal" role="form">
              <p>The Gcode Sender widget will send a command to the serial port by default. You can optionally have it instead/also send the command to the 3D Viewer to have it move the toolhead. If you are going to run a real CNC job, you will not want to send the command to the 3D Viewer, but rather have the feedback from the CNC controller update the 3D Viewer. You have been warned.</p>
              <!-- <h4>Send Gcode Commands To</h4> -->
              <p class="">When Playing <span class="glyphicon glyphicon-play"></span> or Stepping <span class="glyphicon glyphicon-step-backward"></span><span class="glyphicon glyphicon-step-forward"></span> Send Gcode Commands To</p>
              
              <div class="form-group">
                  <div class="col-sm-10">
                      <div class="radio">
                          <label>
                              <input type="radio" name="grpWhenPlay" id="com-chilipeppr-widget-gcode-option-whenplay-serial" value="serial" checked="true"> Serial Port (Default)
                          </label>
                      </div>
                      <div class="radio">
                          <label>
                              <input type="radio" name="grpWhenPlay" id="com-chilipeppr-widget-gcode-option-whenplay-3d" value="3d"> 3D Viewer
                          </label>
                      </div>
                  </div>
              </div>

              <p class="">When Clicking A Gcode Row <!-- <span class="callout" style="border:1px solid black;border-radius:4px;"><span class="glyphicon glyphicon-ok" style="color:gray"></span>&nbsp; 7 &nbsp;N7 G0 Z4.000 </span> -->Send Gcode Commands To</p>
              
              <div class="form-group">
                  <div class="col-sm-10">
                      <div class="radio">
                          <label>
                              <input type="radio" name="grpPerRow" id="com-chilipeppr-widget-gcode-option-perrow-serial" value="serial"> Serial Port
                          </label>
                      </div>
                      <div class="radio">
                          <label>
                              <input type="radio" name="grpPerRow" id="com-chilipeppr-widget-gcode-option-perrow-3d" value="3d" checked=""> 3D Viewer (Default)
                          </label>
                      </div>
                      <div style="padding-left:30px;">
                          <div class="radio">
                          <label>
                              <input type="radio" name="grpPerRow3dType" id="com-chilipeppr-widget-gcode-option-perrow-3d-goto" value="goto" checked=""> Just go to XYZA Position (Default)
                          </label>
                      </div>
                          <div class="radio">
                          <label>
                              <input type="radio" name="grpPerRow3dType" id="com-chilipeppr-widget-gcode-option-perrow-3d-anim" value="anim"> Go to XYZA Position and Animate Move
                          </label>
                      </div>
                      </div>
                  </div>
              </div>

              <!-- <div class="form-group">
                  <div class="col-sm-offset-2 col-sm-10">
                      <button type="submit" class="btn btn-default">Sign in</button>
                  </div>
              </div> -->

          </form>
          
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal" data-original-title="" title="">Close</button>
            <button type="button" class="btn btn-primary optionsbtnsave" data-original-title="" title="">Save changes</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

  


<script type="text/javascript">//<![CDATA[ 

// Load additional files via Chilipeppr's require.js
requirejs.config({
    paths: {
        //jqueryui: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/minified/jquery.ui.core.min',
        //jqueryuiResizeable: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/minified/jquery.ui.resizable.min',
        jqueryui: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.core',
        jqueryuiWidget: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.widget',
        jqueryuiMouse: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.mouse',
        jqueryuiResizeable: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.resizable',
        waypoints: '//cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.4/waypoints.min',
        //jqueryWaypointsInfinite: '//cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.4/waypoints-infinite.min'
    },
    shim: {
        //jqueryWaypointsInfinite: ['waypoints']
        //jqueryui: ['jquery'],
        jqueryuiWidget: ['jqueryui'],
        jqueryuiMouse: ['jqueryuiWidget'],
        jqueryuiResizeable: ['jqueryui', 'jqueryuiMouse']
    }
});

cpdefine("inline:com-chilipeppr-widget-gcode", ["chilipeppr_ready", "waypoints", "jqueryuiResizeable", "jquerycookie"], function () {
    return {
        id: "com-chilipeppr-widget-gcode",
        url: "http://fiddle.jshell.net/chilipeppr/F2Qn3/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/F2Qn3/",
        name: "Widget / Gcode v2",
        desc: "This widget shows your Gcode in a table. Hilites commands. Responds to file load events via pubsub. Will send serial events on play/pause/stop.",
        publish: {
            '/onplay': "When user hits play button",
            '/onpause': "When user hits pause button",
            '/onstop': "When user hits stop button",
            '/resize' : "When we resize in case any other widget wants to listen to that so it can resize itself."
        },
        foreignSubscribe: {
            "/com-chilipeppr-elem-dragdrop/ondropped" : "We watch for a drag drop event for our own implementation of drag drop. This is not used in production, only in local JSFiddle test mode.",
            '/com-chilipeppr-interface-cnccontroller/plannerpause' : "We need to pause when planner tells us.",
            '/com-chilipeppr-interface-cnccontroller/plannerresume' : "We need to resume when planner tells us.",
            "/com-chilipeppr-interface-cnccontroller/feedhold" : "We need to place a manual pause if we see the e-stop hit. That way user can start where they left off."
        },
        foreignPublish: {
            '/com-chilipeppr-widget-3dviewer/gcodeline': "When a user clicks a line of gcode. We'll send the gcode and the line number so the subscriber can sync to what we're sending, i.e. a 3D viewer that wants to hilite the line representing this command. The format of the signal data is something like {line: 12, gcode: \"G1 F300.0 Z0.0\"}.",
            "/com-chilipeppr-elem-flashmsg/flashmsg" : "Send a flash message on certain events. In particular, we send a flash message when a comment line is hit. We also send a flash message when the gcode is done sending."
        },
        fileLines: [], // contains the gcode file as array per line
        linesComplete: [],
        linesToShow: 50, // how many lines to show in the infinite scroll area
        linesToShowMax: 200, // how many max before we start unloading
        init: function () {
            //console.log("init called");

            // this is async, so hopefully it completes before the user drags a file
            // this loads all our tooltip popout info
            // to describe the g commands
            this.gcodeLoad();

            // load jquery-ui css, but make sure nobody else loaded it
            if (!$("link[href='//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css']").length)
            $('<link>')
            .appendTo('head')
            .attr({type : 'text/css', rel : 'stylesheet'})
            .attr('href', '//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css');
            
            // load local file
            //localStorage.removeItem('last-imported');
            var lastImported = localStorage.getItem('last-imported');
            var lastLoaded = localStorage.getItem('last-loaded');
            if (lastImported) {
                console.log("loading text from local storage");
                this.onFileLoaded(lastImported);
            } else {
                console.log("gcode viewer loading from path lastLoaded or 15mm_cube.gcode");
                var that = this;
                if (!lastLoaded) lastLoaded = 'http://www.chilipeppr.com/3d/chilipepprlogo.nc';
                $.get(lastLoaded, null, function (data) {
                    localStorage.setItem('last-loaded', lastLoaded);
                    localStorage.removeItem('last-imported');
                    // load gcode file, true: skip local store cuz i want a path
                    // stored instead for default file so it reloads when i change it
                    that.onFileLoaded(data, true);
                }, 'text')
                    .error(function () {
                    console.log("error loading default file");
                });
            }
            // subscribe to file load events
            chilipeppr.subscribe("/com-chilipeppr-elem-dragdrop/ondropped", this, this.onFileLoaded);
         
            // subscribe to pause/resume events
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/plannerpause", this, this.onPlannerPause);
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/plannerresume", this, this.onPlannerResume);
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/feedhold", this, this.onFeedhold);
            
            // setup buttons in top toolbar
            this.btnSetup();
            
            // get a trigger per row so we can hilite it
            this.setupRowTrigger();
            //this.createGcodeDesc();
            //console.log(gcode);
            this.parseGcode();
            //console.log(window.location);

            // Make widget resizeable
            this.setupResizeable();

            this.setupFeedrateAdjust();
            this.forkSetup();
            this.setupOptionsModal();
            
            console.log("Widget Gcode v2 done loading.");
        },
        // options: stores the cookie settings for the user
        // example: {whenPlay: "serial", perRow: "3d", perRow3dType: "goto"}
        // it is set during the setupOptionsModal()
        options: null,  
        setupOptionsModal: function() {
            console.log("setupOptionsModal");
            // read vals from cookies
            var options = $.cookie('com-chilipeppr-widget-gcode-options');
            
            if (true && options) {
                options = $.parseJSON(options);
                console.log("just evaled options: ", options);
            } else {
                options = {whenPlay: "serial", perRow: "3d", perRow3dType: "goto"}
            }
            this.options = options;
            console.log("options:", options);
            
            // setup the correct radio buttons in dialog
            if (this.options.whenPlay == "serial")
                $('#com-chilipeppr-widget-gcode-option-whenplay-serial').prop('checked', true);
            else
                $('#com-chilipeppr-widget-gcode-option-whenplay-3d').prop('checked', true);
            if (this.options.perRow == "serial")
                $('#com-chilipeppr-widget-gcode-option-perrow-serial').prop('checked', true);
            else
                $('#com-chilipeppr-widget-gcode-option-perrow-3d').prop('checked', true);
            if (this.options.perRow3dType == "goto")
                $('#com-chilipeppr-widget-gcode-option-perrow-3d-goto').prop('checked', true);
            else
                $('#com-chilipeppr-widget-gcode-option-perrow-3d-anim').prop('checked', true);

            // setup "save changes" button
            var that = this;
            $("#com-chilipeppr-widget-gcode-modal .optionsbtnsave").click(function(evt) {
                console.log("Got save changes on gcode options dialog. evt:", evt);
                
                var whenPlay, perRow, perRow3dType;
                if ($('#com-chilipeppr-widget-gcode-option-whenplay-serial').is(':checked'))
                    whenPlay = "serial";
                else if ($('#com-chilipeppr-widget-gcode-option-whenplay-3d').is(':checked'))
                    whenPlay = "3d";
                if ($('#com-chilipeppr-widget-gcode-option-perrow-serial').is(':checked'))
                    perRow = "serial";
                else if ($('#com-chilipeppr-widget-gcode-option-perrow-3d').is(':checked'))
                    perRow = "3d";
                if ($('#com-chilipeppr-widget-gcode-option-perrow-3d-goto').is(':checked'))
                    perRow3dType = "goto";
                else if ($('#com-chilipeppr-widget-gcode-option-perrow-3d-anim').is(':checked'))
                    perRow3dType = "anim";
                
                var options = {
                    whenPlay: whenPlay,
                    perRow: perRow,
                    perRow3dType: perRow3dType
                };
                var optionsStr = JSON.stringify(options);
                console.log("saving options:", options, "json.stringify:", optionsStr);
                // store cookie
                $.cookie('com-chilipeppr-widget-gcode-options', optionsStr, {
                    expires: 365 * 10,
                    path: '/'
                });
                that.options = options;
                
                that.hideOptionsModal();
            });
        },
        showOptionsModal: function() {
            $('#com-chilipeppr-widget-gcode-modal').modal('show');
        },
        hideOptionsModal: function() {
            $('#com-chilipeppr-widget-gcode-modal').modal('hide');
        },
        /*
        initControllerSpecific: function(controllerId) {
            // This is the init section specific to a controller, that way we can support different controllers
            // in the future like GrblShield, etc.
            
            if (controllerId == "tinyg" || controllerId == null) {
                // subscribe to the TinyG plannerresume/plannerpause signals so we know when to slow
                // down on our sending
                
            } else {
                console.error("Being asked to init controller we have no code for.");
            }
        },
        */
        btnSetup: function() {
            // setup buttons
            $('#com-chilipeppr-widget-gcode-play').click(this.onPlay.bind(this));
            $('#com-chilipeppr-widget-gcode-pause').click(this.onPause.bind(this));
            $('#com-chilipeppr-widget-gcode-stop').click(this.onStop.bind(this));
            $('#com-chilipeppr-widget-gcode-stepback').click(this.onStepBack.bind(this));
            $('#com-chilipeppr-widget-gcode-stepfwd').click(this.onStepFwd.bind(this));
            $('#com-chilipeppr-widget-gcode-btnoptions').click(this.showOptionsModal.bind(this));

            // setup planner indicator icon
            $('#com-chilipeppr-widget-gcodeviewer div.plannerpause').popover({
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto',
                container: 'body'
            });
        },
        onFeedhold: function() {
            if (! (this.isPaused)) {
                this.onPause();
            }
            //this.isPaused = true;
        },
        pauseBtnIcon: null,
        onPlannerPause: function() {
            console.log("gcode being asked to pause.");
            if (this.pauseBtnIcon == null) 
                this.pauseBtnIcon = $('#com-chilipeppr-widget-gcodeviewer div.plannerpause');
            
            if (!this.isPausedByPlanner) {
                // we are not paused, so go ahead and pause
                this.onPauseByPlanner();
                // visuall indicate we were paused by planner, not by a human
                this.pauseBtnIcon.addClass('btnIconWarning');
            } else {
                console.log("got planner pause, but we're already paused");
            }
        },
        onPlannerResume: function() {
            console.log("gcode being asked to resume.");
            if (this.pauseBtnIcon == null) 
                this.pauseBtnIcon = $('#com-chilipeppr-widget-gcodeviewer div.plannerpause');
            
            if (this.isPausedByPlanner) {
                // we are currently paused, so calling onPause will unpause (as if the user was toggling
                // pause button)
                this.onPauseByPlanner();
                this.pauseBtnIcon.removeClass('btnIconWarning');
            } else {
                console.log("got planner resume, but we're already resumed which is weird. maybe user did it.");
            }
        },
        forkSetup: function () {
            var topCssSelector = '#com-chilipeppr-widget-gcodeviewer';
            //$(topCssSelector + ' .fork').prop('href', this.fiddleurl);
            //$(topCssSelector + ' .standalone').prop('href', this.url);
            //$(topCssSelector + ' .fork-name').html(this.id);
            $(topCssSelector + ' .panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto'
            });
            
            // load the pubsub viewer / fork element which decorates our upper right pulldown
            // menu with the ability to see the pubsubs from this widget and the forking links
            var that = this;
            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($(topCssSelector + ' .panel-heading .dropdown-menu'), that);
                });
            });

        },
        setupResizeable: function () {
            //$( "#com-chilipeppr-widget-gcode-body" ).resizable({
            var that = this;
            $("#com-chilipeppr-widget-gcodeviewer").resizable({
                //alsoResize: "#com-chilipeppr-widget-gcode-body-2col > td:first"
                alsoResize: "#com-chilipeppr-widget-gcode-body",
                //ndex:1
                //handles: "s",

                //maxHeight:1000,
                resize: function (evt) {
                    console.log("resize resize", evt);
                    //$( "#com-chilipeppr-widget-gcodeviewer" ).removeAttr("style");
                    $("#com-chilipeppr-widget-gcodeviewer").css('height', 'initial');
                    $('#com-chilipeppr-widget-gcode-body').css('width', 'initial');
                },
                start: function (evt) {
                    console.log("resize start", evt);
                },
                stop: function (evt) {
                    console.log("resize stop", evt);
                    //$( "#com-chilipeppr-widget-gcodeviewer" ).removeAttr("style");
                    $("#com-chilipeppr-widget-gcodeviewer").css('height', 'initial');
                    $('#com-chilipeppr-widget-gcode-body').css('width', 'initial');
                    // publish that we just resized ourselves in case any other widget cares
                    chilipeppr.publish("/" + that.id + "/resize", "");
                }
            });
        },
        setupFeedrateAdjust: function () {
            $('#com-chilipeppr-widget-gcode-feedrate-up').click(this.feedrateUp.bind(this));
            $('#com-chilipeppr-widget-gcode-feedrate-down').click(this.feedrateDown.bind(this));
            $('#com-chilipeppr-widget-gcode-feedrate-reset').click(this.feedrateReset.bind(this));
            $('#com-chilipeppr-widget-gcode-feedrate-adjust').click(this.feedrateAdjust.bind(this));
        },
        feedrateUp: function () {
            //console.log("feed up", this);
            var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
            frdom.val((parseFloat(frdom.val()) + 0.1).toFixed(2));
            this.feedrateUpdateDom();
        },
        feedrateDown: function () {
            //console.log("feed down", this);
            var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
            var val = (parseFloat(frdom.val()));
            if (val <= 0.01) return;
            if (val <= 0.1) val -= 0.01;
            else val -= 0.1;
            frdom.val(val.toFixed(2));
            this.feedrateUpdateDom();
        },
        feedrateReset: function () {
            console.log("feed reset", this);
            var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
            frdom.val("1.00");
            this.feedrateUpdateDom();
        },
        feedrateAdjust: function () {
            console.log("feed adjust", this);
            //var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
            //frdom.val("1.00");
            this.feedrateUpdateDom();
        },
        feedrateUpdateDom: function () {
            var frdom = $('#com-chilipeppr-widget-gcode-feedrate-val');
            var val = parseFloat(frdom.val());
            var that = this;
            $('#com-chilipeppr-widget-gcode-tbl .g').each(function (index, td) {
                //console.log("i:", i, "td:", td);
                var origline = that.fileLines[index];
                var tdDom = $(td);
                origline = that.getFeedrateMarkup(origline);
                origline = that.getCommentMarkup(origline);
                
                tdDom.html(origline);
                /*
                //var html = tdDom.html();
                //console.log("html:", html);
                //var curF = html.match(/(F)(\d+\.{0,1}\d*?)([\s$])/g);
                var curF = origline.match(/(F)(\d+\.{0,1}\d*)/g);
                if (curF) {
                    //console.log("origline:", origline, "curF:", curF);
                    //console.log("original file line:", origline);
                    for (var i = 0; i < curF.length; i++) {
                        var item = curF[i];
                        var fval = parseFloat(item.replace(/F/i, ""));
                        //console.log("fval:", fval);
                        fval = val * fval;
                        //console.log("new fval:", fval);
                        origline = origline.replace(item, "<span class=\"feedrate-adjust\">F" + fval.toFixed(2) + "</span>");
                    }
                    tdDom.html(origline);
                }
                //curF = parseFloat(curF);
                //console.log("curF:", curF);
                */
            });
        },
        setupRowTrigger: function () {
            var that = this;
            $('#com-chilipeppr-widget-gcode-tbl')
                .on("mouseover", 'tr', function (evt) {
                //stuff to do on mouseover
                var td = $(evt.currentTarget).children(".g");
                //console.log("got mouseover on tr:", evt, evt.currentTarget, td);
                if (td.hasClass("g")) {
                    //console.log("calling parse");
                    that.parseGcodeForDomElem(td, true);
                }
            });

            /*
            $('#com-chilipeppr-widget-gcode-tbl')
            .on("mouseout", function() {
                that.cleanupHilites();
            });
            */

            /*
            $('#com-chilipeppr-widget-gcode-tbl')
            .on("mouseout", 'tr', function (evt) {
                console.log("got mouseout on tr:", evt);
                var td = $(evt.currentTarget).children(".g");
                if (td) {
                    that.cleanupDomElem(td);
                    //td.html(td.text());
                    //that.parseGcodeForDomElem(td, false);
                }
                $(".com-chilipeppr-widget-gcode .popover").remove();
            });
            */

            $('#com-chilipeppr-widget-gcode-tbl')
            .on("click", 'tr', function (evt) {
                //stuff to do on click
                console.log("got click on tr:", evt);
                var tr = $(evt.currentTarget);
                if (tr.hasClass("gcode-rowhilite")) tr.removeClass("gcode-rowhilite");
                else tr.addClass("gcode-rowhilite");
                
                /*
                var td = tr.children(".g");
                console.log(td);
                var gcodehtml = td.html();
                // remove divs and spans
                console.log("gcode html", gcodehtml);

                var tmp = $('#com-chilipeppr-widget-gcode-tmparea');
                tmp.html(gcodehtml);
                tmp.children(".popover").remove();
                var gcode = tmp.text();
                var rowind = td[0].parentNode.rowIndex;
                */
                var rowind = tr.children('.indx').text();
                var indx = parseInt(rowind) - 1;
                var gcode = that.fileLines[indx];
                console.log("rowindex:", rowind, "indx:", indx, "gcode is:", gcode);

                // publish to other widgets that a gcode line got hit so, for example,
                // the 3D viewer could jump the toolhead to this point and hilite the line
                if (that.options.perRow == "serial") {
                    // send this command to serial port instead
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/send", gcode);                    
                } else {
                    // send this command to 3d viewer
                    chilipeppr.publish("/com-chilipeppr-widget-3dviewer/gotoline", {
                        line: indx,
                        gcode: gcode,
                        anim: that.options.perRow3dType
                    });
                }
            });



        },
        isPlayStep: false,
        isPlaying: false,
        isPaused: false,
        isPausedByPlanner: false,
        currentLine: null,    // 0-based index of what gcode line we're playing
        onPauseByPlanner: function (event) {
            if (this.isPausedByPlanner) {
                console.log("onPauseByPlanner. was previously paused by planner, unpausing");
                //this.isPaused = false;
                this.isPausedByPlanner = false;
                this.onPlayNextLine();
            } else {
                console.log("onPauseByPlanner. was previously unpaused by planner, pausing from planner");
                //this.isPaused = true;
                this.isPausedByPlanner = true;
            }
        },
        onStepBack: function(evt) {
            console.log("onStepBack. ");
            this.currentLine = this.currentLine - 2;
            if (this.currentLine < 0) this.currentLine = 0;
            this.isPlayStep = true;
            this.onPlayNextLine();
        },
        onStepFwd: function(evt) {
            console.log("onStepFwd");
            this.isPlayStep = true;
            this.onPlayNextLine();
        },
        onPause: function (event) {
            if (this.isPaused) {
                console.log("onPause. was previously paused by user, unpausing");
                this.isPaused = false;
                $('#com-chilipeppr-widget-gcode-pause').removeClass("active");
                this.onPlayNextLine();
            } else {
                console.log("onPause. pausing at request of user");
                this.isPaused = true;
                $('#com-chilipeppr-widget-gcode-pause').addClass("active");
            }
        },
        onStop: function (event) {
            $('#com-chilipeppr-widget-gcode-play').prop("disabled", false);
            $('#com-chilipeppr-widget-gcode-stop').prop("disabled", true);
            $('#com-chilipeppr-widget-gcode-pause').prop("disabled", true);


            this.isPlaying = false;
            /*
            $('#com-chilipeppr-widget-gcode-tbl tr').each(function (i, tr) {
                $(tr).children("td:first").children("span").css("color", "");
            });
            */
        },
        onPlay: function (event) {
            // loop thru each line and send gcode
            console.log("got onPlay. this:", this, "event:", event);
            //console.log(event);
            
            // configure buttons
            $('#com-chilipeppr-widget-gcode-play').prop("disabled", true);
            $('#com-chilipeppr-widget-gcode-pause').prop("disabled", false);
            $('#com-chilipeppr-widget-gcode-stop').prop("disabled", false);
            
            this.isPlaying = true;
            this.isPaused = false;
            $('#com-chilipeppr-widget-gcode-pause').removeClass("active");

            // start from scratch. this is the same method
            // that the jumpscroll uses to go to top
            this.jumpToTop();
            
            this.currentLine = 0;
            
            this.onPlayNextLine();
            
            //for (var ctr = 0; ctr < this.fileLines.length; ctr++) {
                
                
            //}
            
            /*
            $('#com-chilipeppr-widget-gcode-tbl tr').each(function (i, tr) {
                //console.log("looking at row");
                //console.log(tr);
                $(tr).children("td:first span").each(function (i, sp) {
                    console.log(sp);
                    $(sp).css("color", "black");
                });
                var linetext = $(tr).children(".g").text();
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", linetext);
                com-chilipeppr-widget-3dviewer
            });
            */
            return true;
        },
        statEls: null,
        onPlayNextLine: function() {
            
            // if this is a single step, ignore the pause and playing params
            if (this.isPlayStep) {
                console.log("this is a single step");
            } else {
                if (this.isPaused) {
                    console.log("onPlayNextLine. we're now paused by user, so exiting. you can unpause and call me again.");
                    return;
                }
                if (!this.isPlaying) {
                    console.log("onPlayNextLine. we're being asked to stop, so exiting.");
                    return;
                }
            }
            if (this.isPausedByPlanner) {
                console.log("onPlayNextLine: we are paused by planner, so exiting.");
                return;
            }
            
            console.log("this.currentLine:", this.currentLine);
            var ctr = this.currentLine != null ? this.currentLine : 0;
            
            if (ctr >= this.fileLines.length) {
                console.log("at end of playing gcode. exiting.");
                chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Sender", "Done sending Gcode.");

                return;
            }
            
            var linegcode = this.fileLines[ctr];
            //console.log("    orig gcode:", linegcode);
            
            // see if comment
            if (linegcode.match(/\(.*\)/)) {
                // it's comment
                var re = /\((.*)\)/;
                re.exec(linegcode);
                var comment = RegExp.$1;
                console.log("Found comment:", comment);
                chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Gcode Comment", comment);
            }
                
            // we need to apply the feedrate multiplier
            linegcode = this.getFeedrateMarkup(linegcode, true);
            //console.log("after feedrate:", linegcode);
            
            //console.log("onPLay. line:", ctr, " gcode:", linegcode);
            
            // publish to serial port to send to cnc controller
            if (this.options.whenPlay == "serial")
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", linegcode);
            
            // we should mark this off as checked since it's sent
            // that doesn't mean it's executed yet, but that's proving to be really hard
            // to know exactly when our gcode command is executed
            // ACTUALLY just pass in "markSent" to gotoLine below
            
            // publish to 3d viewer so it syncs to us
            if (this.options.whenPlay == "3d")
                chilipeppr.publish("/com-chilipeppr-widget-3dviewer/gotoline", { line: ctr, gcode: linegcode });
            
            // sync gcode list view
            this.gotoLine(ctr + 1, true);
            this.currentLine++;
            
            // update DOM to show how many lines are sent
            if (this.statEls == null) {
                //console.log("lazy loading statEls");
                this.statEls = {
                    sent: $('#gcode-lines-sent'),
                    remaining: $('#gcode-lines-remaining')
                }
            }
            //console.log("udpating stats. statEls:", this.statEls);
            this.statEls.sent.text(this.currentLine);
            this.statEls.remaining.text(this.fileLines.length - this.currentLine);
            
            // delay next line
            if (this.isPlayStep) {
                // don't queue up next line, just mark we're done with step
                this.isPlayStep = false;
            } else {
                // queue up next line
                setTimeout(this.onPlayNextLine.bind(this), 200);
            }
        },
        // linenum is 1-based
        gotoLine: function(linenum, isMarkSent) {
            
            //console.log("gotoLine:", linenum);
            
            // linenum is 1-based (not 0-based) since table is 1-based
            if (linenum < this.showingStartIndex || linenum > this.showingEndIndex) {
                // we are needing to show a line way ahead of where we're being asked to show
                console.log("We are being asked to scroll to a line that does not exist so rendering new. linenum:", linenum);
                this.jumpToLine(linenum);
                //return;
            }
            
            var container = $('#com-chilipeppr-widget-gcode-body');
            // figure out correct index from this.showingStartIndex and linenum
            var indx = linenum - this.showingStartIndex;
            var tr = $('#com-chilipeppr-widget-gcode-tbl tbody tr').eq(indx);
            if (isMarkSent) {
                var check = tr.find('.glyphicon-ok');
                //console.log("marking as sent. black checkbox. checkDom:", check, "tr:", tr);
                check.css('color', 'black');
            }
            var scrollTo = tr;
            console.log("indx:", indx, "scrollTo:", scrollTo);

            
            container.scrollTop(
                scrollTo.offset().top - container.offset().top + container.scrollTop()
            );
            

            // Or you can animate the scrolling:
            /*
            container.animate({
                scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop()
            });
            */
            
        },
        onFileLoaded: function (txt, skipLocalStore) {
            console.log("Got onFileLoaded.");
            var that = this;
            //console.log(arguments);
            //console.log(txt);
            // parse the text file and generate rows
            $('#com-chilipeppr-widget-gcode-tbl > tbody').html("");
            this.fileLines = txt.split(/\r{0,1}\n/);

            // update dom to show lines
            $('#com-chilipeppr-widget-gcode-footer #gcode-lines').text(this.fileLines.length);
            $('#com-chilipeppr-widget-gcode-footer #gcode-lines-sent').text("0");
            $('#com-chilipeppr-widget-gcode-footer #gcode-lines-remaining').text(this.fileLines.length);

            this.appendRows(1);

            //this.setupInfiniteScroll();
            this.setupJumpScroll();

            // now format the gcode
            console.log("going to parse gcode to hilite it.");
            this.parseGcode();
            if (skipLocalStore != undefined && skipLocalStore == true) {
                console.log("skipping storing local file to retain url path load");
            } else {
                console.log("stored gcode view file in local store as text");
                localStorage.setItem('last-imported', txt);
                localStorage.removeItem('last-loaded');
            }
        },
        jumpToTop: function() {
            
            this.infiniteScrollDestroy();
            this.removeAllRows();
            this.appendRows(1);
            /*
                var elem = $('#com-chilipeppr-widget-gcode-tbl');
                console.log("elem.height():", elem.height());
                */
            $('#com-chilipeppr-widget-gcode-body').scrollTop(0);
        },
        // linenum is 1-based
        jumpToLine: function(linenum) {
            
            this.infiniteScrollDestroy();
            this.removeAllRows();
            this.appendRows(linenum);
            /*
                var elem = $('#com-chilipeppr-widget-gcode-tbl');
                console.log("elem.height():", elem.height());
                */
            $('#com-chilipeppr-widget-gcode-body').scrollTop(0);
        },
        setupJumpScroll: function () {
            var that = this;
            $('.com-chilipeppr-gcode-jumpscroll .paginator-first').click(function () {
                console.log("jump scroll to end");
                that.jumpToTop();

            });
            $('.com-chilipeppr-gcode-jumpscroll .paginator-last').click(function () {
                console.log("jump scroll to end");
                that.infiniteScrollDestroy();
                that.removeAllRows();
                that.appendRows(that.fileLines.length - that.linesToShow + 1);
                var elem = $('#com-chilipeppr-widget-gcode-tbl');
                console.log("elem.height():", elem.height());
                $('#com-chilipeppr-widget-gcode-body').scrollTop(elem.height() + 10);
            });
            // loop thru div 2 thru 8 to attach
            var rowsPerJump = parseInt(this.fileLines.length / 9);
            for (var ctr = 0; ctr <= 7; ctr++) {
                //console.log("attaching click to div ctr:", ctr);
                var jumpAmt = rowsPerJump * (ctr + 1);
                var el = $('.com-chilipeppr-gcode-jumpscroll .paginator').eq(ctr); 
                //console.log("EL:", el);
                el.click(jumpAmt, function (evt) {
                    console.log("jump scroll to:", evt.data);
                    that.infiniteScrollDestroy();
                    that.removeAllRows();
                    that.appendRows(evt.data);
                });

            }
            
            this.preSetupInfiniteScroll(true);
        },
        preSetupInfiniteScroll: function(doTopScrollOffset) {
            // Make clickable buttons at top/bottom in case waypoint fails us (which it has been doing)
            // I think the waypoint dies on resize
            var wayStart = $('#showstart');
            var wayEnd = $('#showend');
            var that = this;
            
            wayStart.click(function (evt) {
                console.log("click on waypoint for top. evt:", evt);
                if (that.showingStartIndex == 1) {
                    console.log("Already at startIndex 1. Not rendering more.");
                } else {
                    console.log("There's more to show at start. rendering...");
                    that.prependRows(that.showingStartIndex);
                }
            });
            if (doTopScrollOffset) $('#com-chilipeppr-widget-gcode-body').scrollTop(10);

            wayEnd.click(function (evt) {
                console.log("click on waypoint for bottom. evt:", evt);
                if (that.showingEndIndex >= that.fileLines.length) {
                    console.log("Already at endIndex max (fileLInes). Not rendering more.");
                } else {
                    console.log("There's more to show at end. rendering...");
                    that.appendRows(that.showingEndIndex + 1);
                }
            });

        },
        infiniteScrollDestroy: function () {
            //console.log("Destroying waypoints");
            var wayStart = $('#showstart');
            var wayEnd = $('#showend');

            // destory waypoints because as the DOM gets rows injected/removed
            // the waypoints cache their x/y pos and so we need to recreate them
            wayStart.waypoint('destroy');
            wayEnd.waypoint('destroy');
        },
        setupInfiniteScroll: function (doTopScrollOffset) {
            //console.log("setting up waypoints");
            //console.log($('#showstart'));

            var wayStart = $('#showstart');
            var wayEnd = $('#showend');

            // destory waypoints because as the DOM gets rows injected/removed
            // the waypoints cache their x/y pos and so we need to recreate them
            wayStart.waypoint('destroy');
            wayEnd.waypoint('destroy');

            var that = this;
            wayStart.waypoint(function (direction) {
                console.log("waypoint for top. dir:", direction);
                if (direction == "up") {
                    console.log("scroll was up. loading more at start.");
                    if (that.showingStartIndex == 1) {
                        console.log("Already at startIndex 1. Not rendering more.");
                    } else {
                        console.log("There's more to show at start. rendering...");
                        that.prependRows(that.showingStartIndex);
                    }
                }
            }, {
                context: '#com-chilipeppr-widget-gcode-body',
                offset: -1
                //offset: 'bottom-in-view',
            });
            if (doTopScrollOffset) $('#com-chilipeppr-widget-gcode-body').scrollTop(10);

            wayEnd.waypoint(function (direction) {
                console.log("waypoint for bottom. dir:", direction);
                if (direction == "down") {
                    console.log("sroll was down. loading more at end.");
                    if (that.showingEndIndex >= that.fileLines.length) {
                        console.log("Already at endIndex max (fileLInes). Not rendering more.");
                    } else {
                        console.log("There's more to show at end. rendering...");
                        that.appendRows(that.showingEndIndex + 1);
                    }
                }
            }, {
                context: '#com-chilipeppr-widget-gcode-body',
                offset: 'bottom-in-view',
            });
        },
        showingStartIndex: 0,
        showingEndIndex: 0,
        showingStats: function () {
            $('#gcode-lines-showing').text(this.showingStartIndex + " - " + this.showingEndIndex);
        },
        prependRows: function (endIndx) {

            var startIndx = endIndx - this.linesToShow;
            if (startIndx < 1) startIndx = 1;
            console.log("prependRows. startIndex:", startIndx, "endIndx:", endIndx);

            this.showingStartIndex = startIndx;
            //this.showingEndIndex = endIndx;

            // since we're adding rows, we have to destroy waypoints or things
            // get whacky when DOM changes
            this.infiniteScrollDestroy();

            // ok, now that we know our global start and end
            // figure out if we have too many rows showing
            if (this.showingEndIndex - this.showingStartIndex > this.linesToShowMax) {
                console.log("we are showing too many lines. will truncate at bottom");
                this.removeRowsFromEnd();
            }

            this.showingStats();

            for (var indxCtr = endIndx; indxCtr >= startIndx; indxCtr--) {

                var line = this.fileLines[indxCtr - 1];
                line = this.getFeedrateMarkup(line);
                line = this.getCommentMarkup(line);
                var cls = "g";
                var newTrDom = $("<tr>" +
                    '<td><span class="glyphicon glyphicon-ok"></span></td>' +
                    "<td class=\"indx\">" + indxCtr + "</td>" +
                    "<td class=\"" + cls + "\">" + line + "</td>" +
                    "</tr>");
                $('#com-chilipeppr-widget-gcode-tbl > tbody').prepend(newTrDom);

                //console.log("newTrDom:", newTrDom);
            }

            var that = this;
            setTimeout(function () {
                that.setupInfiniteScroll(true);
            }, 100);


        },
        appendRows: function (startIndx, skipWaypoint) {

            var endIndx = startIndx + this.linesToShow - 1;
            if (endIndx > this.fileLines.length) endIndx = this.fileLines.length;

            if (this.showingStartIndex == 0) this.showingStartIndex = startIndx;
            this.showingEndIndex = endIndx;

            // since we're adding rows, we have to destroy waypoints or things
            // get whacky when DOM changes
            this.infiniteScrollDestroy();

            // ok, now that we know our global start and end
            // figure out if we have too many rows showing
            if (this.showingEndIndex - this.showingStartIndex > this.linesToShowMax) {
                console.log("we are showing too many lines. will truncate at top");
                this.removeRowsFromStart();
            }

            this.showingStats();

            for (var indxCtr = startIndx; indxCtr <= endIndx; indxCtr++) {

                var line = this.fileLines[indxCtr - 1];
                line = this.getFeedrateMarkup(line);
                line = this.getCommentMarkup(line);
                var cls = "g";
                var newTrDom = $("<tr>" +
                    '<td><span class="glyphicon glyphicon-ok"></span></td>' +
                    "<td class=\"indx\">" + indxCtr + "</td>" +
                    "<td class=\"" + cls + "\">" + line + "</td>" +
                    "</tr>");
                $('#com-chilipeppr-widget-gcode-tbl > tbody').append(newTrDom);

                //console.log("newTrDom:", newTrDom);
            }

            if (!skipWaypoint) setTimeout(this.setupInfiniteScroll.bind(this), 100);
        },
        removeAllRows: function () {
            $('#com-chilipeppr-widget-gcode-tbl > tbody > tr').remove();
            this.showingStartIndex = 0;
            this.showingEndIndex = 0;
        },
        removeRowsFromStart: function () {
            console.log("removing rows from start.", this.linesToShow);
            $('#com-chilipeppr-widget-gcode-tbl > tbody > tr:lt(' + (this.linesToShow) + ")").remove();
            this.showingStartIndex = this.showingStartIndex + this.linesToShow;
        },
        removeRowsFromEnd: function () {
            console.log("removing rows from end.", this.linesToShow);
            $('#com-chilipeppr-widget-gcode-tbl > tbody > tr:gt(' + (this.showingEndIndex - this.linesToShow) + ")").remove();
            this.showingEndIndex = this.showingEndIndex - this.linesToShow;
        },
        feedrateEl: null,
        getFeedrateMarkup: function (html, isJustGettingRaw) {
            //console.log("getFeedrateMarkup");
            if (html === undefined) {
                //console.log("html was undefined. huh? ", html);
                return;
            }
            // lazy cache the dom el cuz this is slow
            if (this.feedrateEl == null) this.feedrateEl = $('#com-chilipeppr-widget-gcode-feedrate-val');
            var frdom = this.feedrateEl;
            var val = parseFloat(frdom.val());
            if (val == 1.0) return html;
            var origline = html;
            var curF = origline.match(/(F)(\d+\.{0,1}\d*)/gi);
            if (curF) {
                //console.log("origline:", origline, "curF:", curF);
                //console.log("original file line:", origline);
                for (var i = 0; i < curF.length; i++) {
                    var item = curF[i];
                    var fval = parseFloat(item.replace(/F/i, ""));
                    //console.log("fval:", fval);
                    fval = val * fval;
                    //console.log("new fval:", fval);
                    if (isJustGettingRaw == true) {
                        origline = origline.replace(item, "F" + fval.toFixed(2) + "");
                    } else {
                        origline = origline.replace(item, "<span class=\"feedrate-adjust\">F" + fval.toFixed(2) + "</span>");
                    }
                }
                //tdDom.html(origline);
            }
            return origline;
        },
        getCommentMarkup: function (html) {
            // check if comment, fade it out
            //console.log("getCommentMarkup. html:", html);
            if (html !== undefined && html.match(/\(.*\)|;/)) {
                console.log("got comments match");
                
                // this is kinda fancy. we are adding artificial spaces. this is so
                // we don't have a word too long that mucks with how beautiful our
                // widget is in terms for forcing the width too wide
                var newcomment;
                if (html.match(/(\(.*?\))/) || html.match(/(;.*)/)) {
                    var tmp = RegExp.$1;
                    console.log("$1 was:", tmp);
                    var arr = tmp.split(/ /);
                    var newarr = [];
                    $.each(arr, function(i, item) {
                        if (item.length > 30) {
                            console.log("found a comment with word too long. splitting");
                            var subarr = item.match(/.{1,30}/g);
                            console.log("subarr:", subarr);
                            newarr = newarr.concat(subarr);
                        } else {
                            newarr.push(item);
                        }
                    });
                    newcomment = newarr.join(" ");
                    console.log("newarr:", newarr);
                    console.log("our new html with artificial spaces:", newcomment);
                    if (html.match(/(\(.*?\))/)) html = html.replace(/(\(.*?\))/, newcomment);
                    if (html.match(/(;.*)/)) html = html.replace(/(;.*)/, newcomment);
                }
                
                // ok, just swap a span around comment
                html = html.replace(/(\(.*?\))/, '<span class="gcode-comment">$1</span>');
                html = html.replace(/(;.*)/, '<span class="gcode-comment">$1</span>');
                // also break really long words with no spaces so don't get rendering artifacts
                
            }
            return html;
        },
        getTooltipMarkup: function (txt) {
            // see if gcode matches a dictionary of gcode definitions
            // and swap in a popup to explain the defintion
            if (txt === undefined) {
                //console.error("txt was undefined. huh?");
                return;
            }

            //console.log("applying tooltip");
            var outtxt = "";
            var tokensout = [];
            
            // remove comments (put them back later)
            //txt = txt.replace(/(<span class="gcode-comment".*?<\/span>)/, "");
            //var comment = RegExp.$1;
            //console.log("comment:", comment);
            
            txt = txt.replace(/(\(.*\))/, "");
            var comment = RegExp.$1;
            //console.log("comment:", comment);
            
            // for gcode without spaces, add it so we can parse into tokens
            txt = txt.replace(/([gmxyzf])/gi, " $1");
            
            var tokens = txt.split(/\s+/);
            //console.log("tokens:", tokens);
            var that = this;
            $.each(tokens, function (index, gci) {

                //console.log("working on token: " + gci);
                var outgci = "";
                var isFound = false;
                // check that it's a G or M in gci, or else move on
                if (gci.match(/^(M|G|%)/i)) {
                    //console.log("looks like we got an M or G", gci);
                    $.each(that.gcodeData, function (i, elem) {
                        //console.log("trying to see if this token: " + gci + " == gcode: " + elem.code);
                        //console.log(elem.re);
                        //outgci = "";
                        var m = elem.re.exec(gci);
                        //if (!isFound && gci.match(elem.re)) {
                        if (!isFound && m != null) {
                            //if (m != null) {
                            //console.log("found a match. gci: " + gci);
                            outgci = gci.replace(
                            elem.re,
                                '<span class="com-chilipeppr-gcode-tip" data-toggle="popover" data-title="' + elem.desc + '" data-content="' + elem.info + ' <br></span><br/>Source: Wikipedia">' + m[0] + '</span>');


                            //return;
                            isFound = true;
                        }
                    });
                }
                if (isFound) {
                    //console.log("found a match so using outgci: " + outgci);
                    tokensout.push(outgci + "");
                } else {
                    //console.log("did not find match, so just using non-swapped gcode: " + gci);
                    tokensout.push(gci);
                }

            });
            //console.log("final markup. tokensout[]:", tokensout);
            var finalstr = tokensout.join(" ");
            finalstr += comment;
            return finalstr;
            //return  + "<span class=\"gcode-comment\">" + comment + "</span>";
        },
        lastElemIndex: null,
        cleanupHilites: function () {
            //console.log("cleanupHilites called.");
            
            var that = this;
            $('.com-chilipeppr-gcode-tip').each(function (i, elem) {
                var el = $(elem);
                var elp = $(el.context.parentNode);
                //console.log(el);
                //console.log(elp);
                
                // instead of doing cleanup, let's just rebuild from scratch
                //that.cleanupDomElem(elp);
                // get indx
                var indx = elp.parent().children('.indx').text();
                indx = parseInt(indx);
                var gcode = that.fileLines[indx-1];
                gcode = that.getFeedrateMarkup(gcode);
                gcode = that.getCommentMarkup(gcode);

                elp.html(gcode);
                //that.parseGcodeForDomElem(elp, false);
                
                /*
                elp.html(elp.text());
                // check if comment, fade it out
                if (elp.text().match(/\(.*\)/)) {
                    elp.html(elp.text().replace(/(\(.*\))/, '<span class="gcode-comment">$1</span>'));
                }
                */
                //that.parseGcodeForDomElem(elp, false);
            });
        },
        cleanupDomElem: function (elem) {

            console.log("cleanupDomElem:", elem);
            var elems = elem.children(".com-chilipeppr-gcode-tip");
            console.log("elements to cleanup:", elems);
            
            //elem.children(".com-chilipeppr-gcode-tip").contents().unwrap();
            //elem.children(".com-chilipeppr-gcode-tip").remove();

            //elem.html(elem.text());
            // check if comment, fade it out
            /*
            if (elem.text().match(/\(.*\)/)) {
                elem.html(elem.text().replace(/(\(.*\))/g, '<span class="gcode-comment">$1</span>'));
            }
            */
        },
        parseGcodeForDomElem: function (elem, doTooltip) {

            //console.log("inside parseGcodeForDomElem. lastRowIndex:", this.lastElemIndex, " curElemRowIndex:",  elem.context.rowIndex);
            //console.log("elem:", elem);
            // if we just got called again on same row due to mouseover causing multiple
            // events, then just exit
            if (this.lastElemIndex && this.lastElemIndex == elem.context.rowIndex) {
                //console.log("lastElem = elem. exiting.");
                return;
            }

            // cleanup other rows when we are rendering markup for a new row
            this.cleanupHilites();
            
            //$(".com-chilipeppr-widget-gcode .popover").remove();
            if (doTooltip) {
                // get original line
                var indx = elem.parent().children('.indx').text();
                indx = parseInt(indx);
                var gcode = this.fileLines[indx-1];

                var newhtml = this.getTooltipMarkup(gcode);
                //console.log("newhtml for td.g", newhtml);
                //newhtml = that.getFeedrateMarkup(newhtml);
                //newhtml = this.getCommentMarkup(newhtml);
                //console.log("newhtml after comments", newhtml);

                //this.cleanupHilites();

                // check if comment, fade it out
                //if (elem.text().match(/\(.*\)/)) {
                //    elem.html(elem.html().replace(/(\(.*\))/, '<span class="gcode-comment">$1</span>'));
                //}

                // see if we can add tooltips
                //this.cleanupDomElem(elem);
                //var newhtml = (this.getTooltipMarkup(elem.html()));
                // re-add feedrate and comment
                //newhtml = this.getFeedrateMarkup(newhtml);
                //newhtml = this.getCommentMarkup(newhtml);
                elem.html(newhtml);

                //console.log("elem after tooltips:", elem);

                //console.log($this.html());
                // turn on the popovers
                elem.find('span').popover({
                    animation: true,
                    html: true,
                    placement: 'auto left',
                    trigger: 'hover',
                    delay: {
                        show: 20,
                        hide: 20
                    },
                    container: elem
                });
            }

            // always append a span tip to trigger a cleanup
            elem.append(' <span class="com-chilipeppr-gcode-tip hidden"></span>');

            this.lastElemIndex = elem.context.rowIndex;
        },
        parseGcode: function () {
            // this method attaches tooltips to gcode
            // to help you understand what each cmd does
            //console.log("Parsing Gcode...");
            var that = this;
            console.log(that);
            $('#com-chilipeppr-widget-gcode-tbl .g').each(function (i, td) {
                $this = $(this);
                //console.log($this.text());

                // do per dom element call
                //that.parseGcodeForDomElem($this);

                // check if comment, fade it out
                if ($this.text().match(/\(.*\)/)) {
                    $this.html($this.text().replace(/(\(.*\))/, '<span class="gcode-comment">$1</span>'));
                    //$this.html('<span class="gcode-comment">' + $this.text() + '</span>');
                }
            });
        },
        createGcodeDesc: function () {
            // Take from Gcode Wikipedia page and turned into json
            //this.createGcodeList();
            // create regexp list
            //console.log("creating regexp list for gcode");
            //gcodeReList = [];
            $.each(this.gcodeData, function (i, elem) {
                //console.log(elem.code);
                //gcodeReList.push(new RegExp(elem.code, "ig"));
                //elem.code = elem.code.replace("%", "\%");
                elem.re = new RegExp("^(" + elem.code + ")$", "i");

                // collapse leading zeroes
                if (elem.code.match(/(G|M)0{1,}/i)) {
                    var code_collapsed = elem.code.replace(/(G|M)0{1,}/i, "$1");
                    if (code_collapsed == "G") code_collapsed = "G0";
                    if (code_collapsed == "G00") code_collapsed = "G0";
                    if (code_collapsed == "M") code_collapsed = "M0";
                    if (code_collapsed == "M00") code_collapsed = "M0";
                    elem.re2 = new RegExp(code_collapsed, "ig");
                    elem.code2 = code_collapsed;
                    elem.re = new RegExp("^(" + elem.code + "|" + elem.code2 + ")$", "i");
                }

                // escape double quotes in desc and info
                if (elem.desc) {
                    //elem.desc = elem.desc.replace(/"/g, '\\"');
                    // remove html
                    elem.desc = elem.desc.replace(/\<.*?\>/g, '');
                    // esc double quote
                    elem.desc = elem.desc.replace(/"/g, '&quot;');
                }
                if (elem.info) {
                    elem.info = elem.info.replace(/\<.*?\>/g, '');
                    // esc double quote
                    elem.info = elem.info.replace(/"/g, '&quot;');
                }
                //console.log(elem.re);
            });
            //console.log(gcode);
            //console.log("done creating regex list for gcode");
        },
        gcodeIsLoaded: false,
        gcodeData: [],
        gcodeLoad: function (callback, context) {
            var that = this;
            chilipeppr.load("com-chilipeppr-elem-gcodedata",
                "http://fiddle.jshell.net/chilipeppr/QPG2v/show/light/",

            function () {
                cprequire(["inline:com-chilipeppr-elem-gcodedata"], function (gcd) {
                    console.log("in callback from chilipeppr.load() for gcodedata");
                    that.gcodeIsLoaded = true;
                    that.gcodeData = gcd.gcode;
                    that.createGcodeDesc();
                    if (callback) callback.apply(context, gcd);
                });
            });
        }
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/F2Qn3/show/light/ -->
</div>
                <!-- Serial In/Out Text Log-->
                <div id="com-chilipeppr-serialport-log" class="zhigh"><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/JB2X7/show/light/ -->




<style type="text/css">
    /*html,body {
    height:100%;
    overflow:hidden;
}*/
.com-chilipeppr-widget-spconsole-console-log pre {
    margin:0;
    padding:0;
    background: none;
    border: none;
}
.com-chilipeppr-widget-spconsole .out {
    color: blue;
    /* margin-left:-5px; */
}
.panel.com-chilipeppr-widget-spconsole {
    /* height:100%; */
    /* min-height:250px; */
    /* position:relative; */
    margin:0;
    padding:0;
    /* height:60px; */
}
.com-chilipeppr-widget-spconsole .com-chilipeppr-widget-spconsole-body {
    padding:0;
    overflow: auto;
    overflow-x: hidden;
    width:100%;
    /* height:100%; */
    /* top:0; */
    /* bottom:0; */
    /* position:absolute; */
    position:relative;
}
.com-chilipeppr-widget-spconsole .com-chilipeppr-widget-spconsole-console-log {
    overflow: auto;
    /* margin:0; */
    margin-bottom:35px;
    /* padding: 0 0 40px 16px; */
    padding-left:12px;
    padding-bottom:4px;
    padding-right:12px;
    /* position:absolute; */
    width:100%;
    height:40px;
    /* top:44px; */
    /* bottom:36px; */
    /* height:100%; */
}
.com-chilipeppr-widget-spconsole-consoleinput {
    position: absolute;
    width:100%;
    left:0;
    bottom:0;
    /* padding-top:2px; */
    /* margin-top:1px; */
    /* background-color:silver; */
}
.com-chilipeppr-widget-spconsole .subtitle {
    font-size:9px;
}
  </style>
  


  <div class="panel panel-default com-chilipeppr-widget-spconsole ui-resizable">
    <div class="panel-heading">
        <div class="btn-group pull-right">
            <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>

            </button>
            <ul class="dropdown-menu" role="menu">
                <!-- <li role="presentation" class="dropdown-header fork-name"></li>
                <li><a href="" class="standalone" target="_blank">View Widget Standalone</a></li>
                <li><a href="" class="fork" target="_blank">Fork Widget</a></li> -->
            <li role="presentation" class="dropdown-header fork-name">com-chilipeppr-widget-spconsole</li><li><a href="javascript:" class="pubsublink">PubSub for this Widget</a></li><li><a href="http://fiddle.jshell.net/chilipeppr/JB2X7/show/light/" target="_blank" class="standalone">View Widget Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/JB2X7/" target="_blank" class="fork">Fork Widget</a></li></ul>
        </div>
        <span class="panel-title" data-original-title="" title="">Serial Port Console <span class="subtitle">(Single Port Mode)</span></span>
    </div>
    <div class="panel-body com-chilipeppr-widget-spconsole-body">
        <div class="com-chilipeppr-widget-spconsole-console-log" style="height: 72px;">
            <pre><div class="out">{"sr":""}
{"sv":1}
{"si":100}
{"qr":""}
{"qv":2}
</div></pre>
        </div>
        <div class="com-chilipeppr-widget-spconsole-consoleinput">
            <form id="com-chilipeppr-widget-spconsole-consoleform">
                <div class="input-group">
                    <span class="input-group-btn dropup">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""><span class="caret"></span></button>
                        <ul class="dropdown-menu" role="menu">
                            <!-- <li><a href="#" id="">{"sr":""}</a>
                            </li> -->
                        </ul>

                    </span>
                    <input type="text" class="form-control" placeholder="Type serial port command"> <span class="input-group-btn">
                    <button class="btn btn-default" type="submit" data-original-title="" title="">Go!</button>
                        </span>

                        <!-- /input-group -->
                </div>
            </form>
        </div>
                
    </div>
<div class="ui-resizable-handle ui-resizable-e" style="z-index: 90;"></div><div class="ui-resizable-handle ui-resizable-s" style="z-index: 90;"></div><div class="ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se" style="z-index: 90;"></div></div>

  


<script type="text/javascript">//<![CDATA[ 

// Load additional files via Chilipeppr's require.js
requirejs.config({
    paths: {
        jqueryui: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.core',
        jqueryuiWidget: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.widget',
        jqueryuiMouse: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.mouse',
        jqueryuiResizeable: '//chilipeppr.com/js/jquery-ui-1.10.4/ui/jquery.ui.resizable',
    },
    shim: {
        jqueryuiWidget: ['jqueryui'],
        jqueryuiMouse: ['jqueryuiWidget'],
        jqueryuiResizeable: ['jqueryuiMouse' ]
    }
});

cpdefine("inline:com-chilipeppr-widget-spconsole", ["chilipeppr_ready", "jquerycookie", 'jqueryuiResizeable'], function () {
    return {
        id: "com-chilipeppr-widget-spconsole",
        url: "http://fiddle.jshell.net/chilipeppr/JB2X7/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/JB2X7/",
        name: "Widget / Serial Port Console",
        desc: "This widget lets you see the data in/out of the serial port and send commands.",
        foreignPublish: {
            '/com-chilipeppr-widget-serialport/send' : "(High-level mode) When the user types a command, we send this signal so the serial port widget can pass the command along to the serial port server. This is the high-level send command that is used when in single port mode where we can ignore which serial port we are sending to and let the serial port widget figure it out. To get into this mode you must call init(true) to put this widget into singlePortMode. Optionally you can also call setSinglePortMode().", 
            '/com-chilipeppr-widget-serialport/ws/send' : '(Low-level mode) When the user types in a command, we send it to the serial port widget. This is the low-level command where we have to specify the serial port and the command. This happens in non-single port mode. When in single port mode, we do not send commands on this signal. We instead send a /com-chilipeppr-widget-serialport/send signal because we can then let the serial port widget decide which serial port to send to.',
            '/com-chilipeppr-widget-serialport/getlist' : "(Low-level mode) When in low-level mode we must request the serial port list from the serial port widget so we can show the user which port to pick. When in single port mode, we do not use this signal because we do not have to worry about which port we are sending on."
        },
        foreignSubscribe: {
            '/com-chilipeppr-widget-serialport/recvline' : "(High-level mode) When in high-level mode, i.e. setSinglePortMode(), this is the signal we receive incoming serial data on. This signal sends us data in a per-line format so we do not have to piece the data together like we do in low-level mode.",
            '/com-chilipeppr-widget-serialport/ws/recv' : "(Low-level mode) When in low-level mode, this is the signal we receive the incoming serial data on. We will have to filter which data we want to show based on the port the user bound this widget to because we will get data for all connected serial ports including ones we do not want data for. It is up to this widget to decide what to show.",
            '/com-chilipeppr-widget-serialport/list' : "(Low-level mode) We subscribe to this signal so we know what the list of serial ports is, so we can ask the user to bind this widget to the correct serial port. This is useful if you are instantiating this widget a couple of times or opening multiple serial ports for your app and you just want this specific widget to bind to a particular serial port. This is considered low-level mode because you have more work to do. This widget then must also send the commands using the /com-chilipeppr-widget-serialport/ws/send publish signal and specify the port and command when sending."
        },
        portBoundTo: null,
        portIsBound: false,
        isSinglePortMode: false,
        init: function (isSinglePortMode) {
            //console.log("init called");

            // load jquery-ui css, but make sure nobody else loaded it
            if (!$("link[href='//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css']").length)
            $('<link>')
            .appendTo('head')
            .attr({type : 'text/css', rel : 'stylesheet'})
            .attr('href', '//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css');

            this.btnBarSetup();
            this.consoleSetup();
            this.setupResizeable();
            //this.resizerSetup();
            //this.resize();
            if (isSinglePortMode) {
                this.setSinglePortMode();
            } else {
                this.subscribeSetup();
                this.onPortList();
            }
            
            // let other widgets load
            setTimeout(this.resize.bind(this), 3000);
            
            console.log(this.name + " done loading.");
        },
        setSinglePortMode: function() {
            // in this mode we just show signals from the channel
            // /com-chilipeppr-widget-serialport/recvline 
            // we also just send on the channel
            // /com-chilipeppr-widget-serialport/send 
            // that way we don't have to know what serial port the user
            // is connected to. 
            this.isSinglePortMode = true;
            
            // in single port mode, we only recv serial data in line by line
            // mode (as opposed to multi-port where we get it block by block
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/recvline", this, this.onRecvLine);
            // if another widget sends a serial cmd, echo it here
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/send", this, this.onEchoOfSend);
            
            // update title of widget to reflect single port mode
            $('.com-chilipeppr-widget-spconsole .subtitle').text("(Single Port Mode)");
            
        },
        onRecvLine: function(data) {
            if (data.dataline) {
                this.appendLog(data.dataline);
            }
        },
        onEchoOfSend: function(data) {
            this.appendLogEchoCmd(data);
        },
        setupResizeable: function() {
            //$( "#com-chilipeppr-widget-gcode-body" ).resizable({
            $( ".com-chilipeppr-widget-spconsole" ).resizable({
                //alsoResize: "#com-chilipeppr-widget-gcode-body-2col > td:first"
                alsoResize: ".com-chilipeppr-widget-spconsole-console-log",
                //ndex:1
                //handles: "s",
                
                //maxHeight:1000,
                resize: function(evt) {
                    console.log("resize resize", evt);
                    //$( ".com-chilipeppr-widget-spconsole" ).removeAttr("style");
                    $( ".com-chilipeppr-widget-spconsole" ).css('height', 'initial');
                    $( ".com-chilipeppr-widget-spconsole-console-log" ).css('width', 'initial');
                },
                start: function(evt) {
                    console.log("resize start", evt);
                },
                stop: function(evt) {
                    console.log("resize stop", evt);
                    //$( ".com-chilipeppr-widget-spconsole" ).removeAttr("style");
                    $( ".com-chilipeppr-widget-spconsole" ).css('height', 'initial');
                    $( ".com-chilipeppr-widget-spconsole-console-log" ).css('width', 'initial');
                }
            });
        },
        subscribeSetup: function() {
            // We will subscribe to the port list.
            // If anything is open, we'll pick the first one
            // If multiple opens, we'll show a pulldown
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/list", this, this.onPortList);
            // Since we may load after the ChiliPeppr Serial Port Server object
            // we can also publish a request to resend the list
            chilipeppr.publish("/com-chilipeppr-widget-serialport/getlist", "");
        },
        onPortList: function(ports) {
            // This gets called when a publish occurs on
            // "/com-chilipeppr-widget-serialport/list"
            // We are sent an object of ports
            console.log("Got port list from a publish on the serial port selector widget. Going to use that to pick a port for the console. ports:", ports);
            // find if any are open
            var isAnyOpen = false;
            var that = this;
            var ctrPorts = 0;
            if (!ports) ports = "";
            $.each(ports, function(item, val) {
                console.log("item:", item, "val:", val);
                if (val.IsOpen) {
                    ctrPorts++;
                    isAnyOpen = true;
                    that.portBoundTo = val;
                    that.portIsBound = true;
                }
            });
            var hdr = $('.com-chilipeppr-widget-spconsole .panel-heading');
            if (ctrPorts == 1) {
                // we have a single port. good. this is easy
                hdr.text("Serial Port Console - " + this.portBoundTo.Friendly + "");
            } else if (ctrPorts > 1) {
                hdr.text("Serial Port Console - " + "Multiple serial ports selected (pick one for now).");
            } else {
                hdr.text("Serial Port Console - " + "No port selected");
            }
        },
        resize: function() {
            // add the top of the widget + height of widget
            // to get sizing. then subtract that from height of window to figure out what height to add (subtract) from log
            var wdgt = $('.com-chilipeppr-widget-spconsole');
            var wht = wdgt.offset().top + wdgt.height();
            var delta = $( window ).height() - wht;
            //console.log("delta:", delta, "wht:", wht);
            var loght = $('.com-chilipeppr-widget-spconsole-console-log').height();
            $('.com-chilipeppr-widget-spconsole-console-log').height(loght + delta - 13);
        },
        resizerSetup: function() {
            // due to the layout complexity here of being
            // nested very deep, doing absolute positioning
            // for pure CSS resize is not working, so use
            // jquery resize
            var that = this;
            $( window ).resize(function() {
                //console.log("New height of window after resize: ", $( window ).height() );
                //console.log("New pos of .com-chilipeppr-widget-spconsole:", $('.com-chilipeppr-widget-spconsole').offset(), "height:",  $('.com-chilipeppr-widget-spconsole').height());
                //console.log("New height of .com-chilipeppr-widget-spconsole-console-log:", $('.com-chilipeppr-widget-spconsole-console-log').height() );
                that.resize();
            });
        },
        forkSetup: function () {
            //$('.com-chilipeppr-widget-spconsole .fork').prop('href', this.fiddleurl);
            //$('.com-chilipeppr-widget-spconsole .standalone').prop('href', this.url);
            //$('.com-chilipeppr-widget-spconsole .fork-name').html(this.id);
            $('.com-chilipeppr-widget-spconsole .panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto'
            });
            
            // load the pubsub viewer / fork element which decorates our upper right pulldown
            // menu with the ability to see the pubsubs from this widget and the forking links
            var that = this;
            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($('.com-chilipeppr-widget-spconsole .panel-heading .dropdown-menu'), that);
                });
            });

        },
        btnBarSetup: function () {
            var that = this;
            this.forkSetup();
            $('.com-chilipeppr-widget-spconsole .btn').tooltip({
                animation: true,
                delay: 100,
                container: 'body'
            });
        },
        history: [], // store history of commands so user can iterate back
        historyLastShownIndex: null,    // store last shown index so iterate from call to call
        pushOntoHistory: function(cmd) {
            this.history.push(cmd);
            
            // push onto dropup menu
            var el = $('<li><a href="javascript:">' + cmd + '</a></li>');
            $('#com-chilipeppr-widget-spconsole-consoleform .dropdown-menu').append(el);
            el.click(cmd, this.onHistoryMenuClick.bind(this));
        },
        onHistoryMenuClick: function(evt) {
            console.log("got onHistoryMenuClick. data:", evt.data);
            $("#com-chilipeppr-widget-spconsole-consoleform input").val(evt.data);
            //return true;
        },
        consoleSetup: function () {
            var that = this;
            
            if (!that.isSinglePortMode) {
                that.consoleSubscribeToLowLevelSerial();
            }

            $("#com-chilipeppr-widget-spconsole-consoleform").submit(function (evt) {
                //console.log("got submit on form");
                evt.preventDefault();
                
                var msg = $('#com-chilipeppr-widget-spconsole-consoleform input');
                console.log("msg:", msg.val());
                //if (!msg.val()) {
                //    return false;
                //}
                
                // push onto history stack
                if (msg.val().length > 0) {
                    //console.log("pushing msg to history. msg:", msg.val());
                    that.pushOntoHistory(msg.val());
                    
                }
                
                var newline = "\n";
                
                // publish the cmd to the serial port
                if (that.isSinglePortMode) {
                    // we're in single port mode, so publish to high-level
                    // /send channel and let serial port widget figure out
                    // what port to send to
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/send", msg.val() + newline);
                    
                } else {
                    // show this msg in the log as an echo cmd
                    that.appendLogEchoCmd(msg.val());
                    // publish to the low-level /ws/send so we can
                    // specify the port
                    //console.log("that:", that);
                    //console.log("portBoundTo:", that.portBoundTo);
                    if (that.portBoundTo && that.portBoundTo.Name) {
                        var cmd = "send " + that.portBoundTo.Name + " " + msg.val() + newline;
                        //console.log("Publishing cmd: ", cmd);
                        chilipeppr.publish("/com-chilipeppr-widget-serialport/ws/send", cmd);
                    }
                }
                
                // reset input box to empty
                msg.val("");
                // reset history on submit
                that.historyLastShownIndex = null;
                return false;
            });
            
            // show history by letting user do up/down arrows
            $("#com-chilipeppr-widget-spconsole-consoleform").keydown(function(evt) {
                //console.log("got keydown. evt.which:", evt.which, "evt:", evt);
                if (evt.which == 38) {
                    // up arrow
                    if (that.historyLastShownIndex == null)
                        that.historyLastShownIndex = that.history.length;
                    that.historyLastShownIndex--;
                    if (that.historyLastShownIndex < 0) {
                        console.log("out of history to show. up arrow.");
                        that.historyLastShownIndex = 0;
                        return;
                    }
                    $("#com-chilipeppr-widget-spconsole-consoleform input").val(that.history[that.historyLastShownIndex]);
                } else if (evt.which == 40) {
                    if (that.historyLastShownIndex == null)
                        return;
                        //that.historyLastShownIndex = -1;
                    that.historyLastShownIndex++;
                    if (that.historyLastShownIndex >= that.history.length) {
                        console.log("out of history to show. down arrow.");
                        that.historyLastShownIndex = that.history.length;
                        $("#com-chilipeppr-widget-spconsole-consoleform input").val("");
                        return;
                    }
                    $("#com-chilipeppr-widget-spconsole-consoleform input").val(that.history[that.historyLastShownIndex]);
                }
            });

        },
        consoleSubscribeToLowLevelSerial: function() {
            // subscribe to websocket events
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/ws/recv", this, function (msg) {
                // make sure the data is for the port we're bound to
                if (msg.match(/^\{/)) {
                    // it's json
                    //console.log("it is json");
                    var data = $.parseJSON(msg);
                    if (this.portBoundTo && this.portBoundTo.Name && data.P && data.P == this.portBoundTo.Name) {
                        // this is our serial port data
                        var d = data.D;
                        // convert newlines
                        //console.log("data before replace:", d);
                        //d.replace(/\r\n|\r|\n/gm, "<br/>");
                        //var spd = $("<div></div>").text(data.D);
                        //console.log("data after replace:", d);
                        this.appendLog(d);
                    }
                }
            });
        },
        appendLogEchoCmd: function(msg) {
            //console.log("appendLogEchoCmd. msg:", msg);
            var msg2 = $("<div class=\"out\"></div>").text("" + msg);
            //console.log(msg2);
            this.appendLog(msg2);
        },
        logEls: {
            log: null,
            logOuter: null,
        },
        appendLog: function (msg) {
            //console.log("appendLog. msg:", msg);
            if (this.logEls.log == null) {
                console.log("lazy loading logEls. logEls:", this.logEls);
                this.logEls.log = $('.com-chilipeppr-widget-spconsole-console-log pre');
                this.logEls.logOuter = $('.com-chilipeppr-widget-spconsole-console-log');
            }
            //console.log("logEls:", this.logEls);
            //console.log(this.logEls.logOuter);
            var d = this.logEls.logOuter[0];
            var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
            var log = this.logEls.log;
            if (log.html().length > 5000) {
                // truncating log
                console.log("Truncating log.");
                /*
                var logHtml = log.html().split(/\n/);
                var sliceStart = logHtml.length - 200;
                if (sliceStart < 0) sliceStart = 0;
                log.html(logHtml.slice(sliceStart).join("\n"));
                */
                var loghtml = log.html();
                log.html("--truncated--" + loghtml.substring(loghtml.length - 2500));
            }
            if (msg.appendTo)
                msg.appendTo(log);
            else
                log.html(log.html() + msg);
            
            //if (doScroll) {
                d.scrollTop = d.scrollHeight - d.clientHeight;
            //}
        },
        serialConsoleSaveCookie: function(portname) {
            var settings = JSON.stringify({ name:portname });
            
            // store our port/baud settings in cookie for convenience
            $.cookie('com-chilipeppr-spconsole-port', settings, {
                expires: 365,
                path: '/'
            });

        },
        serialConsoleGetCookie: function(portname) {
            // get cookies that may have been stored for the previous settings
            // of the baud, rts, dtr settings
            // make sure we loaded jquery.cookie plugin
            var settings = $.cookie('com-chilipeppr-spconsole-port');
            //console.log("getCookie:", settings);
            if (settings) {
                settings = $.parseJSON(settings);
                //console.log("just evaled settings: ", settings);
            }
            return settings;
        },
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/JB2X7/show/light/ -->
</div>
            </div>
            <!-- 3D Viewer -->
            <div class="widget col-xs-6">
                <div class="">
                <div id="com-chilipeppr-3dviewer-controlpanel" style=""><div class="panel-heading well">
        <div class="btn-toolbar pull-right" role="toolbar">
            <div class="btn-group" data-style="padding-right:6px;">
                <button type="button" class="btn btn-xs btn-default com-chilipeppr-widget-3d-menu-viewextents" data-container="body" data-toggle="popover" data-placement="auto" data-content="View extents of GCode object" data-trigger="hover" data-delay="800" data-original-title="" title=""> <span class="glyphicon glyphicon-eye-open"></span>
                </button>
                <button type="button" class="btn btn-xs btn-default com-chilipeppr-widget-3d-menu-lookattoolhead active btn-primary" data-container="body" data-toggle="popover" data-placement="auto" data-content="Look at the toolhead toggle button. If toggled on, during the sample or real run of Gcode the 3D view will always place the toolhead at the center. Toggling this off means the camera will not reposition onto the toolhead during moves." data-trigger="hover" data-delay="800" data-original-title="" title=""> <span class="glyphicon glyphicon-facetime-video"></span>
                </button>
            </div>
        <div class="btn-group" data-style="padding-right:6px;">
            <button type="button" class="btn btn-xs btn-default com-chilipeppr-widget-3d-menu-samplerun" data-container="body" data-toggle="popover" data-placement="auto" data-content="Play a sample run of the GCode" data-trigger="hover" data-delay="800" data-original-title="" title=""> <span class="glyphicon glyphicon-play"></span>
            </button>
            <button type="button" class="btn btn-xs btn-default com-chilipeppr-widget-3d-menu-samplerunspeed" data-container="body" data-toggle="popover" data-placement="auto" data-content="Speed up from x1 to x1000" data-trigger="hover" data-delay="800" data-original-title="" title="">x1</button>
            <button type="button" class="btn btn-xs btn-default com-chilipeppr-widget-3d-menu-samplerunpause" data-container="body" data-toggle="popover" data-placement="auto" data-content="Pause the sample run of the GCode" data-trigger="hover" data-delay="800" disabled="" data-original-title="" title=""> <span class="glyphicon glyphicon-pause"></span>
            </button>
            <button type="button" class="btn btn-xs btn-default com-chilipeppr-widget-3d-menu-samplerunstop" data-container="body" data-toggle="popover" data-placement="auto" data-content="Stop the sample run of the GCode" data-trigger="hover" data-delay="800" disabled="" data-original-title="" title=""> <span class="glyphicon glyphicon-stop"></span>
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span></button>
            <ul id="com-chilipeppr-widget-3dviewer-dropdown" class="dropdown-menu dropdown-menu-right" role="menu">
                <li><a class="com-chilipeppr-widget-3d-menu-samplerun" href="javascript:">Play Sample Run</a></li>
                <!-- <li class="divider"></li>
                <li role="presentation" class="dropdown-header fork-name"></li>
                <li><a href="" class="standalone" target="_blank">View Widget Standalone</a></li>
                <li><a href="" class="fork" target="_blank">Fork Widget</a></li> -->
            <li class="divider"></li><li role="presentation" class="dropdown-header fork-name">com-chilipeppr-widget-3dviewer</li><li><a href="javascript:" class="pubsublink">PubSub for this Widget</a></li><li><a href="http://fiddle.jshell.net/chilipeppr/y3HRF/show/light/" target="_blank" class="standalone">View Widget Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/y3HRF/" target="_blank" class="fork">Fork Widget</a></li></ul>
        </div>
        </div>
        <span class="panel-title" style="padding-right:10px;" data-toggle="popover" data-trigger="hover" data-placement="auto" data-content="" data-original-title="" title="">3D&nbsp;Viewer</span>
    </div></div>
                </div>
            </div>
            <div class="col-xs-3 nopadding">
                <!-- XYZ -->
                <div id="com-chilipeppr-xyz" class=""><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/gh45j/show/light/ -->




<style type="text/css">
    #com-chilipeppr-widget-xyz-body {
    padding:2px;
}
#com-chilipeppr-widget-xyz-body .col {
    padding:0;
}
.com-chilipeppr-xyz-pos {
    padding:0 0 0 0px;
    margin:0;
}
.com-chilipeppr-xyz-label {
    padding:0;
    margin:0;
}
.com-chilipeppr-xyz-label-well h2 {
    text-align: center;
}
#com-chilipeppr-widget-xyz-body .com-chilipeppr-xyz-label-well {
    background-color: white;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    margin-bottom: 0px;
    margin-right: 2px;
}
#com-chilipeppr-widget-xyz-body .com-chilipeppr-xyz-well {
    overflow: hidden;
    /* position: relative; */
    margin-bottom: 0px;
    padding: 3px 16px;
}
#com-chilipeppr-widget-xyz-body .com-chilipeppr-xyz-pos-well {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}
#com-chilipeppr-widget-xyz-body .com-chilipeppr-xyz-menu {
    /* z-index: 2; */
    position: absolute;
    left: 3px;
    top: 3px;
}
.com-chilipeppr-xyz-menu > .btn {
    border:0;
}
.com-chilipeppr-xyz-dim {
    position: absolute;
    top:0px;
    right:14px;
    font-size:13px;
}
#com-chilipeppr-widget-xyz-ftr {
    overflow-x: hidden;
}
#com-chilipeppr-widget-xyz-ftr:focus {
    background-color: #428bca;
}
.xyz-dimmed {
    color:#e9e9e9;
}
.xyz-active {
    color: black;
}

.flatbottom {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-bottom: 0px solid red;
}
.flattop {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}
.flatleft {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}
.flatright {
    border-bottom-right-radius: 0;
    border-top-right-radius: 0;
}
.btn-nobg {
    background:none;
    border:none;
}
.btn-nobg:hover {
    background:none;
    border:none;
}
#com-chilipeppr-widget-xyz .btnIconWarning {
    color: #f0ad4e;
}

  </style>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-widget-xyz", ["chilipeppr_ready"], function () {
    return {
        id: "com-chilipeppr-widget-xyz",
        url: "http://fiddle.jshell.net/chilipeppr/gh45j/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/gh45j/",
        name: "Widget / XYZ Axes",
        desc: "This widget shows your XYZ position. It can also show your A position. You have jog controls and axis zeroing and homing.",
        publish: {},
        subscribe: {},
        foreignPublish: {
            '/com-chilipeppr-widget-serialport/send' : "We publish to the serial port Gcode jog commands"            
        },
        foreignSubscribe: {
            "/com-chilipeppr-interface-cnccontroller/axes" : "We want XYZA axis updates.",
            "/com-chilipeppr-interface-cnccontroller/units" : "We want to know if the units changed for inch/mm.",
            "/com-chilipeppr-interface-cnccontroller/plannerpause" : "We need to know when to pause sending jog cmds.",
            "/com-chilipeppr-interface-cnccontroller/plannerresume" : "We need to know when to resume jog cmds."
        },
        init: function () {

            // Subscribe to the signal published from the specific controller implementing the generic interface
            // for CNC controllers that normalizes the XYZ Axis updates so we don't have to worry about
            // the specific implementation
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/axes", this, this.updateAxesFromStatus);

            // Update units if we get a notification published to us
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/units", this, this.updateUnitsFromStatus);

            // Subscribe to the generic interface signals of plannerresume/plannerpause so we know when to slow
            // down on our sending of gcode commands when jogging. 
            // If a different controller is implemented, they can send on these signals
            // and abstract away the specific hardware details from us so this widget is reusable
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/plannerpause", this, this.onPlannerPause);
            chilipeppr.subscribe("/com-chilipeppr-interface-cnccontroller/plannerresume", this, this.onPlannerResume);

            // Do UI setup
            this.forkSetup();
            this.btnSetup();
            this.menuSetup();
            this.jogSetup();

            // setup onconnect pubsub event
            /*
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/ws/onconnect", this, function (msg) {
                console.log("got onconnect so will query for status");
            });
            */

            // setup recv pubsub event
            // this is when we receive data in a per line format from the serial port
            /*
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/recvline", this, function (msg) {
                this.onRecvCmd(msg);
            });
            */
            

            // setup DOM elements fro the Axes in the UI
            this.setupAxes();
            
            // setup controller specific init items
            //this.initControllerSpecific();

            var that = this;
            console.log(this.name + " done loading.");
        },
        /*
        initControllerSpecific: function(controllerId) {
            // This is the init section specific to a controller, that way we can support different controllers
            // in the future like GrblShield, etc.
            
            if (controllerId == "tinyg" || controllerId == null) {
                // subscribe to the TinyG plannerresume/plannerpause signals so we know when to slow
                // down on our sending
                chilipeppr.subscribe("/com-chilipeppr-widget-tinyg/plannerpause", this, this.onPlannerPause);
                chilipeppr.subscribe("/com-chilipeppr-widget-tinyg/plannerresume", this, this.onPlannerResume);
            } else {
                console.error("Being asked to init controller we have no code for.");
            }
        },
        */
        pauseBtnIcon: null,
        isPausedByPlanner: false,    // keeps track of whether we've been told to pause sending by the planner buffer
        onPlannerPause: function() {
            console.log("xyz-onPlannerPause. being asked to pause.");
            if (this.pauseBtnIcon == null) 
                this.pauseBtnIcon = $('#com-chilipeppr-widget-xyz div.plannerpause');
            
            if (!this.isPausedByPlanner) {
                // we are not paused, so go ahead and pause
                //this.onPauseByPlanner();
                this.isPausedByPlanner = true;
                // visuall indicate we were paused by planner, not by a human
                this.pauseBtnIcon.addClass('btnIconWarning');
            } else {
                console.log("got planner pause, but we're already paused");
            }
        },
        onPlannerResume: function() {
            console.log("xyz-onPlannerResume. being asked to resume.");
            if (this.pauseBtnIcon == null) 
                this.pauseBtnIcon = $('#com-chilipeppr-widget-xyz div.plannerpause');
            
            if (this.isPausedByPlanner) {
                // we are currently paused, so unpause 
                //this.onPauseByPlanner();
                this.isPausedByPlanner = false;
                this.pauseBtnIcon.removeClass('btnIconWarning');
            } else {
                console.log("got planner resume, but we're already resumed which is weird.");
            }
        },
        /*
        onRecvCmd: function (recvline) {
            // get a per line command from the serial port server via pubsub
            //console.log("onRecvCmd. recvline:", recvline);
            // we want to process the status reports
            // sample: 
            // {"sr":{"vel":0.02,"mpoy":10.474,"dist":1,"stat":5}}
            // {"sr":{"vel":0.06,"mpox":0.001,"dist":0}}
            
            if (!(recvline.dataline)) {
                console.log("got recvline but it's not a dataline, so returning.");
                return;
            }
            var msg = recvline.dataline;
            if (msg.match(/^{/)) {
                // it is json
                d = $.parseJSON(msg);
                //console.log("d:", d);
                if (d.sr) {
                    //console.log("it is a status report");
                    this.updateAxesFromStatus(d.sr);
                } else if (d.r && d.r.sr) {
                    //console.log("it is a status report from a direct request");
                    this.updateAxesFromStatus(d.r.sr);
                }
            }

        },
        */
        updateUnitsFromStatus: function(units) {
            console.log("updateUnitsFromStatus. units:", units);
            $('.com-chilipeppr-xyz-dim').text(units);
        },
        axisx: null,
        axisy: null,
        axisz: null,
        axisa: null,
        axes: {},
        setupAxes: function () {
            this.axisx = {
                intblack: $('#com-chilipeppr-widget-xyz-x .xyz-intblack'),
                intgray: $('#com-chilipeppr-widget-xyz-x .xyz-intgray'),
                negpos: $('#com-chilipeppr-widget-xyz-x .xyz-negpos'),
                decimal: $('#com-chilipeppr-widget-xyz-x .xyz-decimal')
            };
            this.axisy = {
                intblack: $('#com-chilipeppr-widget-xyz-y .xyz-intblack'),
                intgray: $('#com-chilipeppr-widget-xyz-y .xyz-intgray'),
                negpos: $('#com-chilipeppr-widget-xyz-y .xyz-negpos'),
                decimal: $('#com-chilipeppr-widget-xyz-y .xyz-decimal')
            };
            this.axisz = {
                intblack: $('#com-chilipeppr-widget-xyz-z .xyz-intblack'),
                intgray: $('#com-chilipeppr-widget-xyz-z .xyz-intgray'),
                negpos: $('#com-chilipeppr-widget-xyz-z .xyz-negpos'),
                decimal: $('#com-chilipeppr-widget-xyz-z .xyz-decimal')
            };
            this.axisa = {
                intblack: $('#com-chilipeppr-widget-xyz-a .xyz-intblack'),
                intgray: $('#com-chilipeppr-widget-xyz-a .xyz-intgray'),
                negpos: $('#com-chilipeppr-widget-xyz-a .xyz-negpos'),
                decimal: $('#com-chilipeppr-widget-xyz-a .xyz-decimal')
            };
            this.axes = {
                x: this.axisx,
                y: this.axisy,
                z: this.axisz,
                a: this.axisa
            }
        },
        updateAxesFromStatus: function (axes) {
            console.log("updateAxesFromStatus:", axes);
            if ('x' in axes && axes.x != null) {
                this.updateAxis("x", axes.x);
            }
            if ('y' in axes && axes.y != null) {
                this.updateAxis("y", axes.y);
            }
            if ('z' in axes && axes.z != null) {
                this.updateAxis("z", axes.z);
            }
            if ('a' in axes && axes.a != null) {
                this.updateAxis("a", axes.a);
            }
        },
        // keep track of lastval so less dom updates to perform
        lastVal: {
            x: 0,
            y: 0,
            z: 0,
            a: 0,
        },
        updateAxis: function (axis, val) {
            //console.log("updateAxis. axis:", axis, "val:", val);
            var ax = this.axes[axis];
            var axl = this.lastVal[axis];
            
            // if this val is same as last val, return immediately
            // this happens alot as the cnc controller could send lots of redundant position updates
            if (val == axl) {
                //console.log("new val:", val, "is same as last val:", axl, "axis:", axis, "exiting");
                return;
            }

            // set the negative indicator, but only do it if there was a change
            // to reduce dom updates for efficiency
            if (val < 0 && axl >= 0) {
                ax.negpos.removeClass("xyz-dimmed");
                ax.negpos.addClass("xyz-active");
            } else if (val >= 0 && axl < 0) {
                ax.negpos.removeClass("xyz-active");
                ax.negpos.addClass("xyz-dimmed");
            }

            // convert float into integer part and decimal part
            var arr = (Math.abs(val) + "").split(".");
            var intval = arr[0];
            //console.log("arr.length:", arr.length, arr);
            //var decval;
            //if (arr.length > 0) decval = arr[1];
            //else decval = "000";
            var decval = ((arr.length > 1) ? arr[1] : "000");
            decval += decval.length == 1 ? "00" : decval.length == 2 ? "0" : "";
            //console.log("abs intval:", intval, "decval:", decval);
            
            // set the integer part into dom
            ax.intblack.html(intval);

            // see about what dimmed out 0 padding we need
            // use lastval to see if any delta so we have less dom updates to perform since they're slow
            var axla = Math.abs(axl);
            //console.log("abs last val:", axla);
            if (intval >= 100 && axla < 100) ax.intgray.html("");
            else if (intval < 100 && intval >= 10 && (axla < 10 || axla >= 100)) ax.intgray.html("0");
            else if (intval == 0 && axla > 0) ax.intgray.html("00");

            ax.decimal.html(decval);

            // set lastVal so we have it next time into this method
            this.lastVal[axis] = val;
        },
        menuSetup: function() {
            $('#com-chilipeppr-widget-xyz .xyz-showa').click(this.showHideAxisA.bind(this));
            // per axis menu
            $('#com-chilipeppr-widget-xyz-x .dropdown-menu a').eq(0).click("x", this.zeroOutAxis.bind(this)).prop('href', 'javascript:');
            $('#com-chilipeppr-widget-xyz-y .dropdown-menu a').eq(0).click("y", this.zeroOutAxis.bind(this)).prop('href', 'javascript:');;
            $('#com-chilipeppr-widget-xyz-z .dropdown-menu a').eq(0).click("z", this.zeroOutAxis.bind(this)).prop('href', 'javascript:');;
            $('#com-chilipeppr-widget-xyz-a .dropdown-menu a').eq(0).click("a", this.zeroOutAxis.bind(this)).prop('href', 'javascript:');;
        },
        zeroOutAxis: function(evt) {
            console.log("zeroOutAxis. evt.data:", evt.data, "evt:", evt);
            var cmd = "G28.3 ";
            if (evt.data == "xyz") cmd += "X0 Y0 Z0 A0";
            else cmd += evt.data + "0";
            console.log(cmd);
            chilipeppr.publish("/com-chilipeppr-widget-serialport/send", cmd);

        },
        showHideAxisA: function() {
            var el = $('#com-chilipeppr-widget-xyz-a');
            if (el.hasClass('hidden'))
                el.removeClass('hidden');
            else
                el.addClass('hidden');
        },
        btnSetup: function () {
            // setup planner indicator icon
            $('#com-chilipeppr-widget-xyz div.plannerpause').popover({
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto',
                container: 'body'
            });
        },
        jogSetup: function () {
            // attach to focus and blur events
            // when focused, we'll jog
            var that = this;
            $('#com-chilipeppr-widget-xyz-jog').popover();

            // setup button events
            $('#com-chilipeppr-widget-xyz-ftr .jogx').click("X+", this.jogBtn.bind(this));
            $('#com-chilipeppr-widget-xyz-ftr .jogy').click("Y+", this.jogBtn.bind(this));
            $('#com-chilipeppr-widget-xyz-ftr .jogz').click("Z+", this.jogBtn.bind(this));
            $('#com-chilipeppr-widget-xyz-ftr .jogxneg').click("X-", this.jogBtn.bind(this));
            $('#com-chilipeppr-widget-xyz-ftr .jogyneg').click("Y-", this.jogBtn.bind(this));
            $('#com-chilipeppr-widget-xyz-ftr .jogzneg').click("Z-", this.jogBtn.bind(this));
            
            $('#com-chilipeppr-widget-xyz-ftr .jogzero').click("xyz", this.zeroOutAxis.bind(this));

            // setup jog btn
            $('#com-chilipeppr-widget-xyz-jog').click(function () {
                console.log("setting focus/blur to footer");
                var elFtr = $('#com-chilipeppr-widget-xyz-ftr');
                //if ($('#com-chilipeppr-widget-xyz').hasClass('panel-primary'))
                //    elFtr.blur();
                //else
                    elFtr.focus();
            });

            $('#com-chilipeppr-widget-xyz-ftr').focus(function () {
                console.log("jog area focus");
                $('#com-chilipeppr-widget-xyz').addClass("panel-primary");
            });
            $('#com-chilipeppr-widget-xyz-ftr').blur(function () {
                console.log("jog area blur");
                $('#com-chilipeppr-widget-xyz').removeClass("panel-primary");
            });
            $('#com-chilipeppr-widget-xyz-ftr').keypress(function (evt) {
                console.log("got keypress for jog. evt:", evt, evt.which);
            });
            lastKeydown: 0,
            $('#com-chilipeppr-widget-xyz-ftr').keydown(function (evt) {
                //if (evt.which != 16 && evt.which != 17 && evt.which != 18) console.log("got keydown for jog. evt:", evt, evt.which);
                // let's slow down keypresses so we don't overwhelm the jogging
                var curTime = new Date().getTime();
                if (curTime - this.lastKeydown < 200) {
                    console.log("yeilding cuz time was too quick");
                    return;
                }
                this.lastKeydown = curTime;
                
                // see if planner buffer full, if so yeild
                if (this.isPausedByPlanner) {
                    console.log("planner buffer full. yeilding.");
                    return;
                }

                var key = evt.which;
                var direction = null;
                var isFast, is100xFast, is1000xFast, is10000xFast = false;
                if (evt.shiftKey == true) {
                    isFast = true;
                }
                if (evt.ctrlKey == true) {
                    is100xFast = true;
                }
                if (evt.shiftKey == true && evt.altKey == true) {
                    is10000xFast = true;
                }
                if (evt.shiftKey == true && evt.ctrlKey) {
                    is1000xFast = true;
                }

                if (key == 38) {
                    // up arrow. Y+
                    direction = "Y+";
                } else if (key == 40) {
                    // down arrow. Y-
                    direction = "Y-";
                } else if (key == 37) {
                    direction = "X-";
                } else if (key == 39) {
                    direction = "X+";
                } else if (key == 33) {
                    // page up
                    direction = "Z+";
                } else if (key == 34) {
                    // page down
                    direction = "Z-";
                }

                if (direction) {
                    that.jog(direction, isFast, is100xFast, is1000xFast, is10000xFast);
                }
            });
        },
        jogBtn: function (evt) {
            //console.log("jogBtn:", arguments);
            var direction = evt.data;
            var isFast, is100xFast, is1000xFast, is10000xFast = false;
            //var isSuperFast = false;
            if (evt.shiftKey == true) {
                isFast = true;
            }
            if (evt.ctrlKey == true) {
                is100xFast = true;
            }
            if (evt.altKey == true) {
                is1000xFast = true;
            }
            if (evt.shiftKey == true && evt.altKey == true) {
                is10000xFast = true;
            }
            if (evt.shiftKey == true && evt.ctrlKey) {
                is1000xFast = true;
            }

            this.jog(direction, isFast, is100xFast, is1000xFast, is10000xFast);
        },
        jog: function (direction, isFast, is100xFast, is1000xFast, is10000xFast) {
            var key = direction;
            var cmd = "G91 G1 ";
            var feedrate = "F100";
            var mult = 1;
            var xyz = "";
            var val = 0.001;
            if (isFast == true) {
                feedrate = "F500";
                mult = 10;
            }
            if (is100xFast == true) {
                feedrate = "F1000";
                mult = 100;
            }
            if (is1000xFast == true) {
                feedrate = "F5000";
                mult = 1000;
            }
            if (is10000xFast == true) {
                feedrate = "F10000";
                mult = 10000;
            }

            if (key == "Y+") {
                // up arrow. Y+
                xyz = "Y";
                val = 0.001;
            } else if (key == "Y-") {
                // down arrow. Y-
                xyz = "Y";
                val = -0.001;
            } else if (key == "X+") {
                // right arrow. X+
                xyz = "X";
                val = 0.001;
            } else if (key == "X-") {
                // left arrow. X-
                xyz = "X";
                val = -0.001;
            } else if (key == "Z+") {
                // page up. Z+
                xyz = "Z";
                val = 0.001;
            } else if (key == "Z-") {
                // page down. Z-
                xyz = "Z";
                val = -0.001;
            }
            val = val * mult;

            if (xyz.length > 0) {
                cmd += xyz + val + " " + feedrate + "\nG90\n";
                // do last minute check to see if planner buffer is too full, if so ignore this cmd
                if (!(this.isPausedByPlanner))
                    chilipeppr.publish("/com-chilipeppr-widget-serialport/send", cmd);
                else
                    console.log("planner buffer full, so not sending jog cmd");
            }
        },
        forkSetup: function () {
            //$('#com-chilipeppr-widget-xyz-tbar-fork').prop('href', this.fiddleurl);
            //$('#com-chilipeppr-widget-xyz-tbar-standalone').prop('href', this.url);
            //$('#com-chilipeppr-widget-xyz .fork-name').html(this.id);
            $('#com-chilipeppr-widget-xyz .panel-title').popover({
                title: this.name,
                content: this.desc,
                trigger: 'hover',
                placement: "auto",
                html: true,
                delay: 200,
                animation: true
            });
            
            // load the pubsub viewer / fork element which decorates our upper right pulldown
            // menu with the ability to see the pubsubs from this widget and the forking links
            var that = this;
            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($('#com-chilipeppr-widget-xyz .panel-heading .dropdown-menu'), that);
                });
            });

        },
    }
});
//]]>  

</script>




  <div id="com-chilipeppr-widget-xyz" class="panel panel-default">
    <div class="panel-heading">
        <div class="btn-toolbar pull-right" role="toolbar" data-style="position:absolute;right:0px;top:0px;padding:10px 15px;">
            <div class="btn-group plannerpause" data-toggle="popover" data-content="This indicator shows that we're being asked to pause our sending of commands to the CNC controller so we don't overfill the buffer." data-original-title="" title="">
                <span disabled="true" class="plannerpauseindicator glyphicon glyphicon glyphicon-time btn btn-sm" data-original-title="" title=""></span>
            </div>
            <div class="btn-group">
                <div class="dropdown">
                <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""><span class="caret"></span>
    
                </button>
                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                    <li><a href="#" class="xyz-showa">Show/Hide A Axis</a></li>
                    <!-- <li class="divider"></li>
                    <li role="presentation" class="dropdown-header fork-name"></li>
                    <li><a href="" target="_blank" id="com-chilipeppr-widget-xyz-tbar-standalone">View Widget Standalone</a></li>
                    <li><a href="" target="_blank" id="com-chilipeppr-widget-xyz-tbar-fork">Fork Widget</a></li> -->
                <li class="divider"></li><li role="presentation" class="dropdown-header fork-name">com-chilipeppr-widget-xyz</li><li><a href="javascript:" class="pubsublink">PubSub for this Widget</a></li><li><a href="http://fiddle.jshell.net/chilipeppr/gh45j/show/light/" target="_blank" class="standalone">View Widget Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/gh45j/" target="_blank" class="fork">Fork Widget</a></li></ul>
                </div>
            </div>
        </div>
        <span class="panel-title" data-toggle="popover" data-original-title="" title="">Axes</span>
    </div>
    <div id="com-chilipeppr-widget-xyz-body" class="panel-body">
        <div class="container-fluid">
            <!-- X -->
            <div id="com-chilipeppr-widget-xyz-x" class="row">
                <!-- Label -->
                <div class="col col-xs-3" style="position:relative;">
                    <div class="btn-group com-chilipeppr-xyz-menu">
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>

                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="javascript:">Zero Out X Axis</a></li>
                            <li><a href="">Home Axis (Must have limit switch)</a></li>
                        </ul>
                    </div>
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-label-well flatbottom">
                         <h2 class="com-chilipeppr-xyz-label">X</h2>

                    </div>
                </div>
                <!-- Value -->
                <div class="col col-xs-9">
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-pos-well flatbottom">
                         <h2 class="com-chilipeppr-xyz-pos"><table><tbody><tr><td style="width:70px;text-align:right;"><span class="xyz-negpos xyz-dimmed">-</span><span class="xyz-intgray xyz-dimmed">00</span><span class="xyz-intblack">0</span></td><td>.<span class="xyz-decimal">000</span></td></tr></tbody></table></h2>

                        <div class="com-chilipeppr-xyz-dim">mm</div>
                    </div>
                </div>
            </div>
            <!-- Y -->
            <div id="com-chilipeppr-widget-xyz-y" class="row">
                <!-- Label -->
                <div class="col col-xs-3" style="position:relative;">
                    <div class="btn-group com-chilipeppr-xyz-menu">
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>

                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="javascript:">Zero Out Y Axis</a></li>
                            <li><a href="">Home Axis (Must have limit switch)</a></li>
                        </ul>
                    </div>
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-label-well flatbottom flattop">
                         <h2 class="com-chilipeppr-xyz-label">Y</h2>

                    </div>
                </div>
                <!-- Value -->
                <div class="col col-xs-9">
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-pos-well flatbottom flattop">
                         <h2 class="com-chilipeppr-xyz-pos"><table><tbody><tr><td style="width:70px;text-align:right;"><span class="xyz-negpos xyz-dimmed">-</span><span class="xyz-intgray xyz-dimmed">00</span><span class="xyz-intblack">0</span></td><td>.<span class="xyz-decimal">000</span></td></tr></tbody></table></h2>

                        <div class="com-chilipeppr-xyz-dim">mm</div>
                    </div>
                </div>
            </div>
            <!-- Z -->
            <div id="com-chilipeppr-widget-xyz-z" class="row">
                <!-- Label -->
                <div class="col col-xs-3" style="position:relative;">
                    <div class="btn-group com-chilipeppr-xyz-menu">
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>

                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="javascript:">Zero Out Z Axis</a></li>
                            <li><a href="">Home Axis (Must have limit switch)</a></li>
                        </ul>
                    </div>
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-label-well flattop">
                         <h2 class="com-chilipeppr-xyz-label">Z</h2>

                    </div>
                </div>
                <!-- Value -->
                <div class="col col-xs-9">
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-pos-well flattop">
                         <h2 class="com-chilipeppr-xyz-pos"><table><tbody><tr><td style="width:70px;text-align:right;"><span class="xyz-negpos xyz-dimmed">-</span><span class="xyz-intgray xyz-dimmed">00</span><span class="xyz-intblack">0</span></td><td>.<span class="xyz-decimal">000</span></td></tr></tbody></table></h2>

                        <div class="com-chilipeppr-xyz-dim">mm</div>
                    </div>
                </div>
            </div>
            <!-- A -->
            <div id="com-chilipeppr-widget-xyz-a" class="row hidden">
                <!-- Label -->
                <div class="col col-xs-3" style="position:relative;">
                    <div class="btn-group com-chilipeppr-xyz-menu">
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>

                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="javascript:">Zero Out A Axis</a></li>
                            <li><a href="">Home Axis (Must have limit switch)</a></li>
                        </ul>
                    </div>
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-label-well">
                         <h2 class="com-chilipeppr-xyz-label">A</h2>

                    </div>
                </div>
                <!-- Value -->
                <div class="col col-xs-9">
                    <div class="well com-chilipeppr-xyz-well com-chilipeppr-xyz-pos-well">
                         <h2 class="com-chilipeppr-xyz-pos"><table><tbody><tr><td style="width:70px;text-align:right;"><span class="xyz-negpos xyz-dimmed">-</span><span class="xyz-intgray xyz-dimmed">00</span><span class="xyz-intblack">0</span></td><td>.<span class="xyz-decimal">000</span></td></tr></tbody></table></h2>

                        <div class="com-chilipeppr-xyz-dim">mm</div>
                    </div>
                </div>
            </div>
            <!-- end -->
        </div>
    </div>
    <div id="com-chilipeppr-widget-xyz-ftr" tabindex="1" class="panel-footer" style="padding:2px;">
        <div class="btn-group btn-group-justified">
            <div class="btn-group">
                    <button class="btn btn-default jogzero flatbottom" data-original-title="" title="">Zero</button>
            </div>
            <div class="btn-group">
                <button id="com-chilipeppr-widget-xyz-jog" class="btn btn-default flatbottom btn-nobg" style="width:100%;" data-toggle="popover" data-placement="top" data-title="Jog Shortcut Keys" data-content="X+ : Left Arrow<br>X- : Right Arrow<br>Y+ : Up Arrow<br>Y- : Down Arrow<br>Z+ : Page Up<br>Z- : Page Down<br>Shift : 10x Fast Mode (0.01 mm|inch)<br>Ctrl : 100x Fast Mode (0.1 mm|inch) <br>Shift + Ctrl : 1,000x Fast Mode (1.0 mm|inch)<!--<br>Shift + Alt : 10,000x Fast Mode-->" data-html="true" data-delay="200" data-trigger="hover" data-container="body" data-original-title="" title="">Jog</button>
            </div>
             <div class="btn-group">
                <button class="btn btn-default jogy flatbottom" data-original-title="" title="">Y <span class="glyphicon glyphicon-circle-arrow-up"></span>

                    </button>
            </div>
            <div class="btn-group">
            </div>
            <div class="btn-group">
                    <button class="btn btn-default jogz flatbottom" data-original-title="" title="">Z <span class="glyphicon glyphicon-plus-sign"></span>

                    </button>
            </div>
        </div>
        <div class="btn-group btn-group-justified">
            <div class="btn-group">
                    <button class="btn btn-default joghome flattop" style="width:100%;" data-original-title="" title=""><span class="glyphicon glyphicon-home"></span>

                    </button>
            </div>
            <div class="btn-group">
                    <button class="btn btn-default jogxneg flatright" style="border-left:0;border-right:0;" data-original-title="" title="">X <span class="glyphicon glyphicon-circle-arrow-left"></span>

                    </button>
            </div>
            <div class="btn-group">
                    <button class="btn btn-default jogyneg flattop flatleft flatright" data-original-title="" title="">Y <span class="glyphicon glyphicon-circle-arrow-down"></span>

                    </button>
            </div>
            <div class="btn-group">
                    <button class="btn btn-default jogx flatleft" style="border-left:0;border-right:0;" data-original-title="" title=""><span class="glyphicon glyphicon-circle-arrow-right"></span> X</button>
            </div>
            <div class="btn-group">
                    <button class="btn btn-default jogzneg flattop" data-original-title="" title="">Z <span class="glyphicon glyphicon-minus-sign"></span>

                    </button>
            </div>
        </div>
    </div>
</div>
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/gh45j/show/light/ -->
</div>
                <!-- Tinyg -->
                <div id="com-chilipeppr-tinyg" class=""><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/XxEBZ/show/light/ -->




<style type="text/css">
    #com-chilipeppr-widget-tinyg-body {
    /* padding:0; */
}
.com-chilipeppr-interface-cnccontroller-stat .col {
    padding:0 10px 0 0;
}
.com-chilipeppr-interface-cnccontroller-stat .col:last-child {
    padding:0;
}
.com-chilipeppr-interface-cnccontroller-stat .progress {
    margin-bottom:0;
}
.com-chilipeppr-interface-cnccontroller-stat .stat-row {
    padding-top:2px;
}
.com-chilipeppr-interface-cnccontroller-stat div.col.lblpad {
    padding-left:10px;
}
.com-chilipeppr-interface-cnccontroller-stat  .stat-unit {
    font-size:9px;
    display:none;
}
.com-chilipeppr-interface-cnccontroller-stat  div.col.well {
    margin-bottom:0px;
    padding-left:5px;
}
.com-chilipeppr-interface-cnccontroller-stat  .stat-sm {
    font-size:10px;
}
  </style>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-widget-tinyg", ["chilipeppr_ready"], function () {
    return {
        id: "com-chilipeppr-widget-tinyg",
        implements: { 
            "com-chilipeppr-interface-cnccontroller" : "The CNC Controller interface is a loosely defined set of publish/subscribe signals. The notion of an interface is taken from object-oriented programming like Java where an interface is defined and then specific implementations of the interface are created. For the sake of a Javascript mashup like what ChiliPeppr is, the interface is just a rule to follow to publish signals and subscribe to signals by different top-level names than the ID of the widget or element implementing the interface. Most widgets/elements will publish and subscribe on their own ID. In this widget we are publishing/subscribing on an interface name. If another controller like Grbl is defined by a member of the community beyond this widget for TinyG, this widget can be forked and used without other widgets needing to be changed and the user could pick a Grbl or TinyG implementation of the interface."
        },
        url: "http://fiddle.jshell.net/chilipeppr/XxEBZ/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/XxEBZ/",
        name: "Widget / Tinyg",
        desc: "This widget shows the TinyG planner buffer so other widgets can limit their flow of sending commands and other specific TinyG features.",
        publish: {
            '/com-chilipeppr-interface-cnccontroller/feedhold' : "Feedhold (Emergency Stop). This signal is published when user hits the Feedhold button for an emergency stop of the TinyG. Other widgets should see this and stop sending all commands such that even when the plannerresume signal is received when the user clears the queue or cycle starts again, they have to manually start sending code again. So, for example, a Gcode sender widget should place a pause on the sending but allow user to unpause.",
            '/com-chilipeppr-interface-cnccontroller/plannerpause' : "This widget will publish this signal when it determines that the planner buffer is too full on the TinyG and all other elements/widgets need to stop sending data. You will be sent a /plannerresume when this widget determines you can start sending again. The TinyG has a buffer of 28 slots for data. You want to fill it up with around 12 commands to give the planner enough data to work on for optimizing velocities of movement. However, you can't overfill the TinyG or it will go nuts with buffer overflows. This signal helps you fire off your data and not worry about it, but simply pause the sending of the data when you see this signal. This signal does rely on the TinyG being in {qv:2} mode which means it will auto-send us a report on the planner every time it changes. This widget watches for those changes to generate the signal. The default setting is when we hit 12 remaining planner buffer slots we will publish this signal.",
            '/com-chilipeppr-interface-cnccontroller/plannerresume' : "This widget will send this signal when it is ok to send data to the TinyG again. This widget watches the {qr:[val]} status report from the TinyG to determine when the planner buffer has enough room in it to send more data. You may not always get a 1 to 1 /plannerresume for every /plannerpause sent because we will keep sending /plannerpause signals if we're below threshold, but once back above threshold we'll only send you one /plannerresume. The default setting is to send this signal when we get back to 16 available planner buffer slots.",
            '/com-chilipeppr-interface-cnccontroller/axes' : "This widget will normalize the TinyG status report of axis coordinates to send off to other widgets like the XYZ widget. The axes publish payload contains {x:float, y:float, z:float, a:float} If a different CNC controller is implemented, it should normalize the coordinate status reports like this model. The goal of this is to abstract away the specific controller implementation from generic CNC widgets.",
            '/com-chilipeppr-interface-cnccontroller/units' : "This widget will normalize the TinyG units to the interface object of units {units: \"mm\"} or {units: \"inch\"}. This signal will be published on load or when this widget detects a change in units so other widgets like the XYZ widget can display the units for the coordinates it is displaying."
        },
        subscribe: {},
        foreignPublish: {
            "/com-chilipeppr-widget-serialport/send" : "We send to the serial port certain commands like the initial configuration commands for the TinyG to be in the correct mode and to get initial statuses like planner buffers and XYZ coords. We also send the Emergency Stop and Resume of ! and ~"
        },
        foreignSubscribe: {
            "/com-chilipeppr-widget-serialport/ws/onconnect" : "When we see a new connect, query for status.",
            "/com-chilipeppr-widget-serialport/recvline" : "When we get a dataline from serialport, process it and fire off generic CNC controller signals to the /com-chilipeppr-interface-cnccontroller channel."
        },
        plannerPauseAt: 12, // if planner buffer gets to this number, then send pause
        plannerResumeAt: 18, // when planner buffer gets back to this number, send a resume
        init: function () {

            this.forkSetup();

            // setup onconnect pubsub event
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/ws/onconnect", this, function (msg) {
                console.log("got onconnect so will query for status");
                this.queryControllerForStatus(); 
            });

            // setup recv pubsub event
            // this is when we receive data in a per line format from the serial port
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/recvline", this, function (msg) {
                this.onRecvCmd(msg);
            });
            
            this.btnSetup();
            
            // query for status as well as put TinyG in correct reporting mode
            this.queryControllerForStatus();      
            
            console.log(this.name + " done loading.");
        },
        btnSetup: function() {
            $('#com-chilipeppr-widget-tinyg .tinyg-feedhold').click(function() {
                console.log("tinyg-feedhold emergency stop");
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", "!\n");
                // announce to other widgets that user hit e-stop
                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerpause', "");
                chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/feedhold", "");
            });
            $('#com-chilipeppr-widget-tinyg .tinyg-cyclestart').click(function() {
                console.log("tinyg-cyclestart");
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", '~\n{"qr":""}\n');
                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
            });
            $('#com-chilipeppr-widget-tinyg .tinyg-queueflush').click(function() {
                console.log("tinyg-queueflush");
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", '%\n{"qr":""}\n');
                chilipeppr.publish('/com-chilipeppr-interface-cnccontroller/plannerresume', "");
                
            });
            
            $('#com-chilipeppr-widget-tinyg .btn-toolbar .btn').popover({
                animation: true,
                placement: "auto",
                trigger: "hover",
                container: 'body'
            });
        },
        queryControllerForStatus: function(isWithDelay) {
            
            var delay1 = isWithDelay ? 1000 : 0;
            var delay2 = isWithDelay ? 5000 : 1000;
            
            // publish to see what the status of the planner buffer is of the cnc controller
            // this code is specific to tinyg
            // wait 1 and 5 seconds to do this though because the full load is such that
            // we may not have everything good to go yet, i.e. other widgets looking for responses
            // to these issued commands
            
            // TODO: watch when we get an event from serial port to send this
            
            // {"qv":2}
            // also send {"qv":1} to put tinyg in planner buffer reporting mode just in case
            // it's not in that mode

            // {"sr":""}
            // requests a status report which gives us xyz coords from TinyG

            // {"sv":1}
            // this command asks tinyg to turn on filtered automatic status reports. we will get
            // a report every time there's relevant updates on position
            
            // {"si":100}
            // set minimum status report interval to 100 milliseconds so we don't get overwhelmed

            // {"qr":""}
            // requests a queue report to see how much room is in the planner buffer

            var initCmds = '{"sr":""}\n{"sv":1}\n{"si":100}\n{"qr":""}\n{"qv":2}\n';
            setTimeout(function() {
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", initCmds);
            }, delay1);
            setTimeout(function() {
                chilipeppr.publish("/com-chilipeppr-widget-serialport/send", initCmds);
            }, delay2);
            

        },
        onRecvCmd: function (recvline) {
            // get a per line command from the serial port server via pubsub
            //console.log("onRecvCmd. recvline:", recvline);

            // we want to process the qr reports for buffer planner
            // sample: 
            // {"qr":27}
            
            if (!(recvline.dataline)) {
                console.log("got recvline but it's not a dataline, so returning.");
                return;
            }
            var msg = recvline.dataline;
            if (msg.match(/^{/)) {
                // it is json
                d = $.parseJSON(msg);
                //console.log("d:", d);
                if (d.qr) {
                    //console.log("it is a status report");
                    this.processPlannerStatus(d.qr);
                } else if (d.r && d.r.qr) {
                    //console.log("it is a status report from a direct request");
                    this.processPlannerStatus(d.r.qr);
                } else if (d.r && d.r.sr) {
                    // status report of position
                    this.publishAxisStatus(d.r.sr);
                } else if (d.sr) {
                    this.publishAxisStatus(d.sr);
                }
            }

        },
        lastUnits: null,
        isShowingStats: true,
        publishAxisStatus: function(sr) {
            // build normalized interface object
            var axes = {
                x: sr.posx != undefined ? sr.posx : null,
                y: sr.posy != undefined ? sr.posy : null,
                z: sr.posz != undefined ? sr.posz : null,
                a: sr.posa != undefined ? sr.posa : null,
                type: "work"
            }
            // also check if it's the mpox/mpoy/mpoz form (machine coords instead of work coords)
            if ("mpox" in sr || "mpoy" in sr || "mpoz" in sr || "mpoa" in sr) {
                // we have machine coords
                axes.x = "mpox" in sr ? sr.mpox : null;
                axes.y = "mpoy" in sr ? sr.mpoy : null;
                axes.z = "mpoz" in sr ? sr.mpoz : null;
                axes.a = "mpoa" in sr ? sr.mpoa : null;
                axes.type = "machine";
            }
                    
            chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/axes", axes);
            
            // also check if units are attached and are different from last units
            // [unit] units_mode - 0=inch, 1=mm
            if ("unit" in sr) {
                var units = sr.unit == 0 ? "inch" : "mm";
                
                // yes we have units. see if changed and thus why we should publish
                if (this.lastUnits != units) {
                    console.log("we have a unit change. publish it. units:", units);
                    chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/units", units);
                }
            }
            
            // check other stats if user is showing full stats
            if (this.isShowingStats) {
                this.processStats(sr);   
            }
                    
        },
        statEls : null,
        processStats: function(sr) {
            console.log("processStats. sr:", sr);
            if (this.statEls == null) this.statGetDomElements(); // lazy load stat dom for speed
            var e = this.statEls;
            // sample stats
            // '{"r":{"sr":{"line":0,"vel":0.00,"mpox":0.005,"mpoy":10.460,"mpoz":0.304,"mpoa":0.000,"coor":1,"ofsa":0.000,"ofsx":0.000,"ofsy":0.000,"ofsz":0.000,"dist":0,"unit":1,"stat":3,"homz":0,"homy":0,"homx":0,"momo":1},"f":[1,0,10,5440]}}'
            // {"r":{"sr":{"line":0,"posx":0.000,"posy":0.028,"posz":0.000,"posa":0.000,"feed":0.00,"vel":0.00,"unit":1,"coor":1,"dist":0,"frmo":0,"momo":1,"stat":4},"f":[1,0,10,4683]}}
            if ("line" in sr) e.line.text(sr.line);
            if ("feed" in sr) e.feedrate.text(sr.feed);
            if ("vel" in sr) e.velocity.text(sr.vel);
            if ("dist" in sr) e.distance.text(sr.dist == 0 ? "Absolute" : "Incremental");
            if ("unit" in sr) e.units.text(sr.unit == 0 ? "Inch" : "mm");
            if ("stat" in sr) {
                var state = ["Initializing", "Ready", "Shutdown", "Stop", "End", "Run", "Hold", "Homing" ];
                e.state.text(state[sr.stat]);
            }
            if ("momo" in sr) {
                var motion = ["Traverse", "Straight", "CW Arc", "CCW Arc"];
                e.motion.text(motion[sr.momo]);
            }
            if ("coor" in sr) {
                var coor = ["G53", "G54", "G55", "G56", "G57", "G58", "G59"];
                e.coords.text(coor[sr.coor]);
            }
            if ("plan" in sr) {
                var plane = ["XY", "XZ", "YZ"];
                e.plane.text(plane[sr.plan]);
            }
            if ("path" in sr) {
                var path = ["Exact Stop", "Exact Path", "Continuous"];
                e.path.text(path[sr.path]);
            }
            
            
        },
        statGetDomElements: function() {
            console.log("statGetDomElements. this should only get called once."); 
            this.statEls = {
                line: $('.com-chilipeppr-interface-cnccontroller-stat .stat-line'),
                velocity: $('.com-chilipeppr-interface-cnccontroller-stat .stat-velocity'),
                feedrate: $('.com-chilipeppr-interface-cnccontroller-stat .stat-feedrate'),
                state: $('.com-chilipeppr-interface-cnccontroller-stat .stat-state'),
                units: $('.com-chilipeppr-interface-cnccontroller-stat .stat-units'),
                coords: $('.com-chilipeppr-interface-cnccontroller-stat .stat-coords'),
                motion: $('.com-chilipeppr-interface-cnccontroller-stat .stat-motion'),
                plane: $('.com-chilipeppr-interface-cnccontroller-stat .stat-plane'),
                path: $('.com-chilipeppr-interface-cnccontroller-stat .stat-path'),
                distance: $('.com-chilipeppr-interface-cnccontroller-stat .stat-distance')
            }
        },
        plannerLastEvent: "resume",
        processPlannerStatus: function(qr) {
            //console.log("processPlannerStatus. qr:", qr);
            // see if we're below our happy threshold of where we'll allow the planner to get
            if (qr <= this.plannerPauseAt) {
                // we need to send pause signal
                if (this.plannerLastEvent == "resume")
                    this.publishPlannerPause();
            } else if (qr >= this.plannerResumeAt) {
                // we need to send resume signal
                // but only if our last send was pause
                if (this.plannerLastEvent == "pause")
                    this.publishPlannerResume();
            }
                
            // update ui
            this.updatePlannerProgBar(qr);
        },
        publishPlannerPause: function() {
            // tell other widgets to pause their sending because we're too far into
            // filling up the planner buffer
            this.plannerLastEvent = "pause";
            chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/plannerpause", "");
        },
        publishPlannerResume: function() {
            // tell other widgets they can send again
            this.plannerLastEvent = "resume";
            chilipeppr.publish("/com-chilipeppr-interface-cnccontroller/plannerresume", "");
        },
        progBar: null,
        progBarLbl: null,
        updatePlannerProgBar: function(qr) {
            if (this.progBar == null) {
                this.progBar = $('#com-chilipeppr-widget-tinyg .progress-bar');
                this.progBarLbl = this.progBar.find('span');
            }
            // calc %
            var pct = (qr / 28) * 100;
            this.progBar.css('width', pct + "%");
            this.progBarLbl.text(qr);
            
            // color code based on planner fullness
            if (qr < this.plannerPauseAt) {
                this.progBar.addClass('progress-bar-danger');
                this.progBar.removeClass('progress-bar-warning');
            } else if (qr <= this.plannerResumeAt) {
                this.progBar.addClass('progress-bar-warning');
                this.progBar.removeClass('progress-bar-danger');
            } else {
                this.progBar.removeClass('progress-bar-warning');
                this.progBar.removeClass('progress-bar-danger');
            }
            
        },
        forkSetup: function () {
            var topCssSelector = '#com-chilipeppr-widget-tinyg';
            
            //$(topCssSelector + ' .fork').prop('href', this.fiddleurl);
            //$(topCssSelector + ' .standalone').prop('href', this.url);
            //$(topCssSelector + ' .fork-name').html(this.id);
            $(topCssSelector + ' .panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto'
            });
            
            var that = this;
            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($('#com-chilipeppr-widget-tinyg .panel-heading .dropdown-menu'), that);
                });
            });
            
        },
    }
});
//]]>  

</script>




  <div id="com-chilipeppr-widget-tinyg" class="panel panel-default">
    <div class="panel-heading">
        <div class="btn-toolbar pull-right" role="toolbar">
            <div class="btn-group">
                <button type="button" class="btn btn-xs btn-default btn-danger tinyg-feedhold" data-title="Feedhold" data-content="Stop movement immediately. Maintains positional accuracy. Sends ! command to TinyG which jumps past the planner buffer so you get immediate stop. Movement can be resumed with ~ command. If you want to jog you should flush queue with %." data-original-title="" title=""><span class="glyphicon glyphicon-stop"></span></button>
                <button type="button" class="btn btn-xs btn-default tinyg-cyclestart" data-title="Cycle Start" data-content="Resume movement from stopping point" data-original-title="" title=""><span class="">~</span></button>
                <button type="button" class="btn btn-xs btn-default tinyg-queueflush" data-title="Queue Flush" data-content="Empty planner buffer. Used for jogging and other cycles" data-original-title="" title=""><span class="">%</span></button>
            </div>
            <div class="btn-group">
                <div class="dropdown">
                <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""><span class="caret"></span></button>
                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                <!-- <li class="divider"></li> -->
                    <!-- <li role="presentation" class="dropdown-header fork-name"></li>
                    <li><a href="" target="_blank" class="standalone">View Widget Standalone</a></li>
                    <li><a href="" target="_blank" class="fork">Fork Widget</a></li> -->
                <li role="presentation" class="dropdown-header fork-name">com-chilipeppr-widget-tinyg</li><li><a href="javascript:" class="pubsublink">PubSub for this Widget</a></li><li><a href="http://fiddle.jshell.net/chilipeppr/XxEBZ/show/light/" target="_blank" class="standalone">View Widget Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/XxEBZ/" target="_blank" class="fork">Fork Widget</a></li></ul>
                </div>
            </div>
        </div>
        <span class="panel-title" data-toggle="popover" data-original-title="" title="">TinyG</span>
    </div>
    <div id="com-chilipeppr-widget-tinyg-body" class="panel-body">
        <div class="container-fluid com-chilipeppr-interface-cnccontroller-stat">
            <div class="row">
                <div class="col col-xs-4">
                    Planner Buffer
                </div>
                <div class="col col-xs-8">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="6" aria-valuemin="0" aria-valuemax="28" style="width: 50%;">
                            <span class="" style="min-width:20px;">Unknown</span>
                        </div>
                    </div>
                </div>
            </div><!-- row -->
            <div class="row stat-row">
                <div class="col col-xs-3">
                    Velocity
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-velocity">0.00</span> <span class="stat-unit">mm/min</span>
                </div>
                <div class="col col-xs-3 lblpad">
                    Feedrate
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-feedrate">0</span> <span class="stat-unit">mm/min</span>                    
                </div>
            </div><!-- row -->
            <div class="row stat-row">
                <div class="col col-xs-3">
                    Line
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-line">-</span>
                </div>
                <div class="col col-xs-3 lblpad">
                    State
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-sm stat-state">-</span>
                </div>
            </div><!-- row -->
            <div class="row stat-row">
                <div class="col col-xs-3">
                    Units
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-units">-</span>
                </div>
                <div class="col col-xs-3 lblpad">
                    Coords
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-coords">-</span>
                </div>
            </div><!-- row -->
            <div class="row stat-row">
                <div class="col col-xs-3">
                    Motion
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-sm stat-motion">-</span>
                </div>
                <div class="col col-xs-3 lblpad">
                    Plane
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-smx stat-plane">-</span>
                </div>
            </div><!-- row -->
            <div class="row stat-row">
                <div class="col col-xs-3">
                    Path
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-sm stat-path">-</span>
                </div>
                <div class="col col-xs-3 lblpad">
                    Distance
                </div>
                <div class="col col-xs-3 well">
                    <span class="stat-sm stat-distance">-</span>
                </div>
            </div><!-- row -->

        </div>
    </div>
    <div id="com-chilipeppr-widget-tinyg-ftr" class="panel-footer hidden">
</div>
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/XxEBZ/show/light/ -->
</div></div>
                <!-- Serial Port Selector -->
                <div id="com-chilipeppr-serialport-spselector" class=""><!-- start chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/4RgrS/show/light/ -->




<style type="text/css">
    .com-chilipeppr-widget-serialport .com-chilipeppr-widget-serialport-body {
    padding:0;
    overflow: auto;
    overflow-x: hidden;
}
.com-chilipeppr-widget-serialport-install .alert-warning {
    max-height:130px;
    overflow: scroll;
    overflow-x: hidden;
}
.com-chilipeppr-widget-serialport .com-chilipeppr-widget-serialport-body .row .col-xs-12 {
    padding:0;
}
.com-chilipeppr-widget-serialport .table {
    margin-bottom:0;
}
.com-chilipeppr-widget-serialport-disconnected {
    position: absolute;
    width: 100%;
    background-color: rgba(0,0,0,0.7);
    color: white;
    height:80%;
    text-align: center;
    vertical-align: middle;
    display: table-cell;
    line-height: 100%;
    z-index: 100;
    margin:0;
    padding:20px;
}
.com-chilipeppr-widget-serialport .com-chilipeppr-widget-serialport-status .well.well-sm {
    margin: 0;
    padding-left:16px;
    font-size: 10px;
}
.com-chilipeppr-widget-serialport .btn .glyphicon-ok-circle {
    padding: 0 16px;
}
.com-chilipeppr-widget-serialport .com-chilipeppr-widget-serialport-console {
    padding-top: 0px;
}
.com-chilipeppr-widget-serialport .com-chilipeppr-widget-serialport-console-log {
    overflow: auto;
    height: 160px;
    margin:0;
    padding: 0 8px;
}
.com-chilipeppr-widget-serialport .panel-footer {
    font-size: 11px;
}
.com-chilipeppr-widget-serialport-portlist {
    margin-bottom:0;
}
.com-chilipeppr-widget-serialport-portlistarea {
    max-height:150px;
    overflow: auto;
}
.com-chilipeppr-widget-serialport input[type=checkbox] {
    margin-left:10px;
}
.com-chilipeppr-widget-serialport .com-chilipeppr-widget-serialport-baud {
    margin-right:10px;
}
.com-chilipeppr-widget-serialport-install p {
    padding-top:10px;
}
.com-chilipeppr-widget-serialport-install p:first {
    padding-top:0px;
}
.com-chilipeppr-widget-serialport .panel-heading .subtitle {
    font-size:10px;
    display:inline;
}
  </style>
  


  <div class="panel panel-default com-chilipeppr-widget-serialport">
    <div class="panel-heading">
        <div class="btn-group pull-right">
            <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" data-original-title="" title=""> <span class="caret"></span>

            </button>
            <ul class="dropdown-menu" role="menu">
                <li><a href="javascript:" id="com-chilipeppr-widget-serialport-tbar-showhideconsole">Show / Hide Console</a></li>
                <li><a href="javascript:" id="com-chilipeppr-widget-serialport-tbar-showhidestatus">Show / Hide Status</a></li>
                <li class="divider"></li>
                <li class="hidden"><a href="javascript:" id="com-chilipeppr-widget-serialport-tbar-disconws">Disconnect</a></li>
                <li><a href="javascript:" id="com-chilipeppr-widget-serialport-tbar-reconws">Reconnect</a></li>
                <li class="hidden"><a href="javascript:" id="com-chilipeppr-widget-serialport-tbar-refresh">Refresh Serial Port List</a></li>
                <!-- <li class="divider"></li>
                    <li role="presentation" class="dropdown-header fork-name"></li>
                    <li><a href="" class="standalone" target="_blank">View Widget Standalone</a></li>
                    <li><a href="" class="fork" target="_blank">Fork Widget</a></li> -->
            <li class="divider"></li><li role="presentation" class="dropdown-header fork-name">com-chilipeppr-widget-serialport</li><li><a href="javascript:" class="pubsublink">PubSub for this Widget</a></li><li><a href="http://fiddle.jshell.net/chilipeppr/4RgrS/show/light/" target="_blank" class="standalone">View Widget Standalone</a></li><li><a href="http://jsfiddle.net/chilipeppr/4RgrS/" target="_blank" class="fork">Fork Widget</a></li></ul>
        </div>
        <div class="btn-group pull-right" style="padding-right:6px;">
            <button type="button" class="btn btn-xs btn-default refresh" data-toggle="popover" data-placement="auto" data-container="body" data-content="Reload serial port list from ajax server" data-trigger="hover" data-original-title="" title=""><span class="glyphicon glyphicon-refresh"></span></button>
            <button type="button" class="btn btn-xs btn-default disconnect" data-toggle="popover" data-placement="auto" data-container="body" data-content="Disconnect from serial port server" data-trigger="hover" data-original-title="" title=""><span class="glyphicon glyphicon-remove-sign"></span></button>
        </div>
        <div class="title" style="">
            <span class="panel-title" data-original-title="" title="">Serial Port <div class="subtitle">Single Port Mode</div></span>

        </div>
    </div>
    <div class="panel-body com-chilipeppr-widget-serialport-body">
        <div class="container-fluid">
            <div class="row com-chilipeppr-widget-serialport-install">
                <div class="col-xs-12">
                    <div class="alert alert-warning" style="margin:0;">
                        <p style="padding-top:0;">You need to install and run the Serial Port Json Server on the machine that has the serial port connected to your device.
                        </p>
                        <p>Typically you will install the server on your localhost as this Serial Port Widget first looks there for a webocket connection. </p>
                        <p>Optionally you may run the Serial Port Json Server on another host and directly connect to the IP address by typing it in below. This is handy if you're running the server on a Raspberry Pi for example. </p>
                        <p>In case you don't know the IP address of your machine running the server, there is a port scan feature available below to quickly scan your entire subnet for available servers. Most home networks are on the 192.168.1.* subnet so try scanning with that address first.
                        </p>
                            
                        <p>Click to download Serial Port Json Server</p>
                        <div class="list-group">
                            <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-windows-386-v1-1.zip">Windows x32</a>
                            <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-windows-amd64-v1-1.zip">Windows x64</a>
                            <!-- <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-macosx.zip">Mac OS X</a> -->
                            <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-linux-386-v1-1.zip">Linux x32</a>
                            <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-linux-amd64-v1-1.zip">Linux x64</a>
                            <!-- <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-raspi.tar.gz">Raspberry Pi</a> -->
                            <a class="list-group-item" href="//chilipeppr.com/downloads/serial-port-json-server-beagleboneblack-arm-a8-v1-1.zip">Beagle Bone Black ARM A8</a>
                            <a class="list-group-item" target="_blank" href="http://github.com/johnlauer/serial-port-json-server">Compile from source</a>
                        </div>
                        Or if you already have the server downloaded, you may just need to launch it from the command line.
                        
                        <p>If the server is not on your localhost, you may connect to a remote host here.</p>
                        <div id="com-chilipeppr-widget-serialport-hostconnectmsg"></div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="com-chilipeppr-widget-serialport-host" placeholder="Remote Host">
                            <span class="input-group-btn">
                                <button class="btn btn-default" id="com-chilipeppr-widget-serialport-hostbtn" data-original-title="" title="">Connect</button>
                            </span>
                        </div>
                        <p>Or scan your local subnet</p>
                        <div id="com-chilipeppr-widget-serialport-scanresult"></div>
                        <div id="com-chilipeppr-widget-serialport-scanresultcnt"></div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="com-chilipeppr-widget-serialport-scan" placeholder="Subnet" value="192.168.1.*">
                            <span class="input-group-btn">
                                <button id="com-chilipeppr-widget-serialport-scanbtn" class="btn btn-default" data-original-title="" title="">Scan</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div style="position:relative;margin:0;padding:0;">
                <div class="com-chilipeppr-widget-serialport-disconnected hidden">
                    <p>Serial Port Server Websocket Disconnected.</p>
                    <button type="button" class="btn btn-xs btn-default refresh" data-toggle="popover" data-placement="auto" data-content="Reconnect to serial port websocket server" data-original-title="" title=""><span class="glyphicon glyphicon-refresh"></span>
                    </button>
                </div>
            <div class="row">
                <div class="col-xs-12 com-chilipeppr-widget-serialport-portlistarea">
                    
                    <table class="table table-hover table-condensed com-chilipeppr-widget-serialport-portlist">
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row com-chilipeppr-widget-serialport-console hidden">
                <div class="col-xs-12">
                    <div class="com-chilipeppr-widget-serialport-console-log well"></div>
                </div>
            </div>
            <div class="row com-chilipeppr-widget-serialport-consoleinput hidden">
                <form id="com-chilipeppr-widget-serialport-consoleform">
                    <div class="col-xs-12">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Type serial port server command"> <span class="input-group-btn">
                            <button class="btn btn-default" type="button" data-original-title="" title="">Go!</button>
                        </span>

                        </div>
                        <!-- /input-group -->
                    </div>
                </form>
            </div>
            <div class="row com-chilipeppr-widget-serialport-status hidden">
                <div class="col-xs-12">
                    <div class="well well-sm ">Serial port ajax connection closed. readyState: 3</div>
                </div>
            </div>
                
            </div>
        </div>
    </div>
    <div class="panel-footer hidden">
        <div class="btn-group pull-left" style="padding-right:10px;">
            <button type="button" class="btn btn-xs btn-default wsconnect disabled" data-toggle="tooltip" data-placement="auto" title="" data-original-title="Connect to websocket serial port server."><span class="glyphicon glyphicon-ok-sign"></span>

            </button>
            <button type="button" class="btn btn-xs btn-default wsdisconnect" data-toggle="tooltip" data-placement="auto" title="" data-original-title="Disconnect from websocket serial port server."><span class="glyphicon glyphicon-remove-sign"></span>

            </button>
        </div>
        <div class="disconnected hidden"> <span class="glyphicon glyphicon-exclamation-sign" style="color:red"></span> Serial Port Server Disconnected</div>
        <div class="connected "> <span class="glyphicon glyphicon-ok-sign" style="color:gray"></span> Serial Port Server Connected</div>
    </div>
</div>
  


<script type="text/javascript">//<![CDATA[ 

cpdefine("inline:com-chilipeppr-widget-serialport", ["chilipeppr_ready", "jquerycookie"], function () {
    return {
        id: "com-chilipeppr-widget-serialport",
        url: "http://fiddle.jshell.net/chilipeppr/4RgrS/show/light/",
        fiddleurl: "http://jsfiddle.net/chilipeppr/4RgrS/",
        name: "Widget / Serial Port v2",
        desc: "This widget shows your available serial ports. It must connect with your local serial port Ajax server that ChiliPeppr provides for Windows, Mac, and Linux.",
        publish: {
            '/list' : "Sends the list of serial ports shown in this widget including the connect state so other widgets/elements in ChiliPeppr can use the list including knowing what serial ports to send/recv from", 
            '/ws/onconnect' : "When the websocket connects. Since this supports multiple serial port servers an identifier is sent when this signal is published.",
            '/ws/ondisconnect' : "When the websocket disconnects.", 
            '/ws/sys' : "A system message. Mostly for visual display like an error.",
            '/ws/recv' : "A signal published when the websocket receives data from the serial port server. The serial port, i.e. COM21, the websocket identifier, and data are sent.",
            '/recvline' : "We publish this signal in tandem with /ws/recv but we only publish this signal per newline. That way your widget can consume per line data which is typically the way you want it. We recommend you subscribe to this channel instead of /ws/recv to have less work to do of looking for newlines. When in setSingleSelectMode() we will only send you data for the port that is selected (in green in UI)."
        },
        subscribe: {
            '/ws/send' : "This widget subscribes to this signal so anybody can publish to a serial port by publishing here. You must specify which websocket (since multiple are supported, i.e. you could have 10 serial port servers running), and which serial port, i.e. COM21, and the data you are sending. Choosing which websocket not supported yet.",
            '/send' : "This widget subscribes to this signal whereby you can simply send to this pubsub channel (instead of /ws/send which is lower level) and the widget will send to all serial ports that you are connected to at the same time. This is useful if you are sychronizing multiple hardware. You may put this widget into setSingleSelectMode() and then it will be the last port you opened that the data is sent to indicated by a green highlight in the UI. Most serial devices expect newline characters, so you should send those in your string as this pubsub channel does not add them.",
            '/getlist' : "In case any other widget/element wants to request the list at any time, they can send a signal to this channel and we'll respond back with a /list",
            '/getsingleselectport' : "In case any other widget/element wants to know what port is single selected (when in setSingleSelectMode()), they can send a signal to this channel and we'll respond back with a /singleselectport (TODO Not implemented yet)",
        },
        foreignPublish: {
            '/com-chilipeppr-elem-flashmsg/flashmsg' : "We publish system messages from the serial port server to the flash message element to display informational messages to the user."
        },
        isWsConnected: false,
        host: null,
        portlist: null,
        conn: null,     // the websocket we're connected to (eventually make this an array so we can have multiple websockets)
        isSingleSelectMode: false,  // means you can multiple open ports, or only open one
        singleSelectPort: null,     // this will get set to the last port opened based on cookie or click
        init: function (host) {
            //console.log("init called");

            this.btnBarSetup();
            this.consoleSetup();
            this.statusWatcher();
            this.wsConnect(null, host);
            
            // setup onconnect pubsub event
            chilipeppr.subscribe("/" + this.id + "/ws/onconnect", this, function (msg) {
                this.getPortList();
            });

            // setup recv pubsub event
            // this is when we receive data from the serial port
            chilipeppr.subscribe("/" + this.id + "/ws/recv", this, function (msg) {
                this.onWsMessage(msg);
            });

            // setup low-level send pubsub event
            // this is when a widget sends data to the serial port
            chilipeppr.subscribe("/" + this.id + "/ws/send", this, function (msg) {
                this.wsSend(msg);
            });
            
            // setup send pubsub event
            // this is when a widget sends data to the serial port
            chilipeppr.subscribe("/" + this.id + "/send", this, function (msg) {
                this.send(msg);
            });
            
            // Allow others to request our serial port list
            chilipeppr.subscribe("/" + this.id + "/getlist", this, function () {
                chilipeppr.publish("/" + this.id + "/list", this.portlist);
            });

            var that = this;
            
            // show last remote host, if there is one
            if ($.cookie('lasthost')) {
                var lasthost = $.cookie('lasthost');
                lasthost = lasthost.replace(/ws:\/\/(.*):.*/, "$1");
                $('#com-chilipeppr-widget-serialport-host').val(lasthost);
            }
            
            // if connect btn or enter key on remote host connect
            var remoteCon = $('#com-chilipeppr-widget-serialport-hostbtn');
            remoteCon.click(function() {
                that.onRemoteHostConnect();
            });
            $('#com-chilipeppr-widget-serialport-host').keypress(function(event){
                //console.log("got keypress. event:", event);
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if (keycode == '13'){
                    that.onRemoteHostConnect(); 
                }
            });
            
            // setup the port scan button
            $('#com-chilipeppr-widget-serialport-scanbtn').click(function() {
                var subnet = $('#com-chilipeppr-widget-serialport-scan').val();
                that.wsScan(null, subnet);
            });
            
            // cleanup popovers that are getting created by some other widget's code
            //$('.com-chilipeppr-widget-serialport').find('.popover').remove();
            
            console.log(this.name + " done loading.");
        },
        onRemoteHostConnect: function() {
            var host = $('#com-chilipeppr-widget-serialport-host').val();
            $('#com-chilipeppr-widget-serialport-hostconnectmsg').html(
                "Trying to connect to " +
                $('#com-chilipeppr-widget-serialport-host').val() + "...");
            this.wsConnect(host, function() {
                $('#com-chilipeppr-widget-serialport-hostconnectmsg').html("Last connect successful.");
            }, function() {
                $('#com-chilipeppr-widget-serialport-hostconnectmsg').html("Failed to connect to host.");
            });
        },
        setSingleSelectMode: function() {
            this.isSingleSelectMode = true;
            $('.com-chilipeppr-widget-serialport .panel-heading .subtitle').html('Single Port Mode');            
            this.singleSelectPort = $.cookie("singleSelectPort");
            console.log("setSingleSelectMode. port:", this.singleSelectPort);
        },
        forkSetup: function () {
            var topCssSelector = '.com-chilipeppr-widget-serialport';
            //$(topCssSelector + ' .fork').prop('href', this.fiddleurl);
            //$(topCssSelector + ' .standalone').prop('href', this.url);
            //$(topCssSelector + ' .fork-name').html(this.id);
            $(topCssSelector + ' .panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto'
            });

            // load the pubsub viewer / fork element which decorates our upper right pulldown
            // menu with the ability to see the pubsubs from this widget and the forking links
            var that = this;
            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($('.com-chilipeppr-widget-serialport .panel-heading .dropdown-menu'), that);
                });
            });
        },
        getPortListCount: 0,
        getPortList: function () {
            if (this.isWsConnected) {
                this.getPortListCount = 0;
                this.wsSend("list");
            } else {
                if (this.getPortListCount > 5) {
                    // give up, so we don't get in endless loop
                    this.publishSysMsg("Tried to get serial port list, but we are not connected to serial port json server.");
                } else {
                    this.getPortListCount++;
                    this.wsConnect();
                }
            }

        },
        btnBarSetup: function () {
            var that = this;
            this.forkSetup();
            
            /*
            $('.com-chilipeppr-widget-serialport .btn').tooltip({
                animation: true,
                delay: 100,
                //container: 'body'
            });
            */
            $('.com-chilipeppr-widget-serialport .btn').popover({
                animation: true,
                delay: 100,
                //container: 'body'
            });
            
            $('.com-chilipeppr-widget-serialport .btn.refresh').click(function () {
                that.getPortList();
            });
            $('#com-chilipeppr-widget-serialport-tbar-showhideconsole').click(
                this.consoleToggle.bind(this)
            );
            $('#com-chilipeppr-widget-serialport-tbar-showhidestatus').click(
                this.statusToggle.bind(this)
            );
            $('#com-chilipeppr-widget-serialport-tbar-refresh').click(function () {
                that.getPortList();
            });
            $('#com-chilipeppr-widget-serialport-tbar-reconws').click(function () {
                that.wsConnect();
            });
            $('#com-chilipeppr-widget-serialport-tbar-disconws').click(this.disconnect.bind(this));
            $('.com-chilipeppr-widget-serialport .btn.disconnect').click(this.disconnect.bind(this));
           
        },
        disconnect: function() {
            console.log("closing websocket:", this.conn);
            if (this.conn) {
                this.conn.close();
                $('.com-chilipeppr-widget-serialport-install').removeClass('hidden');
            }
        },
        consoleToggle: function() {
            var con = $('.com-chilipeppr-widget-serialport-console');
            var coni = $('.com-chilipeppr-widget-serialport-consoleinput');
            if (con.hasClass('hidden')) {
                // the console is hidden, so let's show
                con.removeClass('hidden');
                coni.removeClass('hidden');
                this.logIsShowing = true;
            } else {
                // it's showing, so they want to hide it
                con.addClass('hidden');
                coni.addClass('hidden');
                this.logIsShowing = false;
            }
            
        },
        statusToggle: function() {
            var stat = $('.com-chilipeppr-widget-serialport-status');
            if (stat.hasClass('hidden')) {
                // the status is hidden, so let's show
                stat.removeClass('hidden');
            } else {
                // it's showing, so they want to hide it
                stat.addClass('hidden');
            }
        },
        consoleSetup: function () {
            // subscribe to websocket events
            chilipeppr.subscribe("/" + this.id + "/ws/recv", this, function (msg) {
                var msg = $("<div></div>").text(msg);
                this.appendLog(msg);
            });

            var that = this;
            $("#com-chilipeppr-widget-serialport-consoleform").submit(function () {
                console.log("got submit on form");
                if (!that.isWsConnected) {
                    return false;
                }
                var msg = $('#com-chilipeppr-widget-serialport-consoleform input');
                if (!msg.val()) {
                    return false;
                }
                that.wsSend(msg.val());
                msg.val("");
                return false;
            });

        },
        log: null,
        logIsShowing: false,
        appendLog: function (msg) {
            // don't do this if log not showing
            if (!this.logIsShowing) {
                //console.log("being asked to append, but log is not showing. exiting.");
                return;
            }
            
            if (this.log == null) this.log = $('.com-chilipeppr-widget-serialport-console-log');
            var log = this.log;
            var d = log[0];
            var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
            // see if log is too long
            if (log.text().length > 5000) {
                // truncating log
                console.log("Truncating log.");
                log.text(log.text().substring(log.text().length-2500));
            }
            msg.appendTo(log);
            if (doScroll) {
                d.scrollTop = d.scrollHeight - d.clientHeight;
            }
        },
        send: function(msg) {
            // this method is called when we get a publish on our pubsub channel of /send
            // we have to figure out what port to send to which depends on whether we're in multi mode or single mode
            var listOfPortsToSendTo = [];
            
            if (this.isSingleSelectMode) {
                if (this.singleSelectPort != null && this.singleSelectPort.length > 1) 
                    listOfPortsToSendTo.push(this.singleSelectPort);
                else
                    this.publishSysMsg("Tried to send a serial port message, but there is no port selected.");

            } else {
                // TODO push open ports onto array instead
            }
            var that = this;
            $.each(listOfPortsToSendTo, function(i, port) {
                msg = "send " + port + " " + msg;
                that.wsSend(msg);
            });

        },
        wsSend: function (msg) {
            if (this.isWsConnected) {
                this.conn.send(msg);
            } else {
                this.publishSysMsg("Tried to send message, but we are not connected to serial port ajax server.");
            }
        },
        serialSaveCookie: function(portname, baud, isrts, isdtr) {
            /*var settings = '{ "baud" : ' + baud + ',' +
                ' "isRts" : ' + isrts + ',' +
                ' "isDtr" : ' + isdtr + ' }';*/
            var settings = JSON.stringify({ baud:baud, isRts:isrts, isDtr:isdtr });
            
            // store our port/baud settings in cookie for convenience
            $.cookie('port-' + portname, settings, {
                expires: 365,
                path: '/'
            });

        },
        serialGetCookie: function(portname) {
            // get cookies that may have been stored for the previous settings
            // of the baud, rts, dtr settings
            // make sure we loaded jquery.cookie plugin
            var settings = $.cookie('port-' + portname);
            //console.log("getCookie:", settings);
            if (settings) {
                settings = $.parseJSON(settings);
                //console.log("just evaled settings: ", settings);
            }
            return settings;
        },
        serialConnect: function (portname, baud) {

            // save the cookie for future convenience so we can load the baud and other stuff
            // so the user can be lazy
            this.serialSaveCookie(portname, baud);
            
            // if we are not ajax server connected, try to reconnect
            var that = this;
            if (!this.isWsConnected) {
                this.wsConnect(function () {
                    chilipeppr.publish("/" + that.id + "/ws/send",
                        "open " + portname + " " + baud);
                });
            } else {
                chilipeppr.publish("/" + this.id + "/ws/send",
                    "open " + portname + " " + baud);
            }
        },
        serialDisconnect: function (portname) {

            // if we are not ajax server connected, try to reconnect
            var that = this;
            if (!this.isWsConnected) {
                this.wsConnect(function () {
                    chilipeppr.publish("/" + that.id + "/ws/send",
                        "close " + portname);
                });
            } else {
                chilipeppr.publish("/" + this.id + "/ws/send",
                    "close " + portname);
            }
        },
        reconMsgShow: function() {
            $('.com-chilipeppr-widget-serialport-disconnected').removeClass('hidden');
        },
        reconMsgHide: function() {
            $('.com-chilipeppr-widget-serialport-disconnected').addClass('hidden');
        },
        wsWasEverConnected: false,
        wsConnect: function (hostname, onsuccess, onfail) {
            if (window["WebSocket"]) {
                var host = hostname;
                if (!host) {
                    // see if cookie
                    if ($.cookie('lasthost')) {
                        console.log("there is a previous hostname. use it.", $.cookie('lasthost'));
                        host = $.cookie('lasthost');
                    } else {
                        host = "localhost";
                    }
                }
                var fullurl;
                if (host.match(/^ws/))
                    fullurl = host;
                else if (host.match(/:\d+$/))
                    fullurl = "ws://" + host + "/ws";
                else
                    fullurl = "ws://" + host + ":8989/ws";
                this.conn = new WebSocket(fullurl);
                console.log(this.conn);
                var that = this;
                that.conn.onopen = function (evt) {
                    that.wsWasEverConnected = true;
                    that.reconMsgHide();
                    that.onWsConnect(evt);
                    $.cookie('lasthost', that.conn.url, {
                        expires: 365,
                        path: '/'
                    });
                    if (onsuccess) onsuccess.apply(that);
                };
                that.conn.onerror = function (evt) {
                    console.log(evt);
                    that.publishSysMsg("Serial port ajax error.");
                    if (onfail) onfail.apply(that);
                };
                that.conn.onclose = function (evt) {
                    if (that.wsWasEverConnected) that.reconMsgShow();
                    that.onWsDisconnect(evt);
                }
                that.conn.onmessage = function (evt) {
                    that.publishMsg(evt.data);
                };
            } else {
                this.publishSysMsg("Your browser does not support WebSockets.");
            }
        },
        wsScan: function (callback, subnet) {
            // this method will scan your local subnet
            // for hosts
            if (window["WebSocket"]) {
                console.log("starting scan of network for serial port servers...");
                var validAddrs = [];
                var that = this;
                if (subnet)
                    subnet = subnet.replace("*", "");
                else
                    subnet = "192.168.1.";
                var scancntsuccess = 0;
                var scancnterr = 0;
                var cnt = $('#com-chilipeppr-widget-serialport-scanresultcnt');
                cnt.text("Starting scan of " + subnet + "*");
                $('#com-chilipeppr-widget-serialport-scanresult').html("");
                for (var ctr = 1; ctr < 255; ctr++) {
                    var conn = new WebSocket("ws://" + subnet + ctr + ":8989/ws");
                    conn.onopen = function (evt) {
                        scancntsuccess++;
                        console.log("found a server. ip:", evt.target.url, evt);
                        validAddrs.push(evt.target);
                        console.log("found one:", validAddrs);
                        var server = $("<div><a href=\"javascript:\">" + evt.target.url + "</a></div>");
                        server.click(evt.target.url, function(evt) {
                            console.log("got click. evt:", evt, "data:", evt.data);
                            that.wsConnect(null, evt.data);
                        });
                        $('#com-chilipeppr-widget-serialport-scanresult').append(server);
                    };
                    conn.onerror = function(evt) {
                        scancnterr++;
                        //console.log("error opening url:", evt.target.url, evt);
                        
                        cnt.text("Found " + scancntsuccess + ", Scanned " + (scancntsuccess + scancnterr));
                    };
                };
                //console.log("done scanning network. found:", validAddrs);
                return validAddrs;
            }                
        },
        lastMsg: null,
        lastMsgTime: 0,
        publishSysMsg: function (msg) {
            chilipeppr.publish("/" + this.id + "/ws/sys", msg);
            var now = Date.now();
            if (this.lastMsg == msg && now - this.lastMsgTime < 20000) {
                // skip publish
                console.log("skipping publish. same msg or too fast.");
            } else {
                chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", "Serial Port System Message", msg);
                this.lastMsg = msg;
                this.lastMsgTime = now;
            }
        },
        publishMsg: function (msg) {
            chilipeppr.publish("/" + this.id + "/ws/recv", msg);
        },
        dataBuffer: {},
        onWsMessage: function (msg) {
            //console.log("inside onWsMessage. msg: " + msg);
            if (msg.match(/^\{/)) {
                // it's json
                //console.log("it is json");
                var data = $.parseJSON(msg);
                if (data && data.Cmd && data.Cmd == "OpenFail") {
                    // we tried to open the serial port, but it failed. usually access denied.
                    this.onPortOpenFail(data);
                } else if (data && data.Cmd && data.Cmd == "Open") {
                    // the port was opened, possibly by other browser or even locally from sys tray
                    this.onPortOpen(data);
                } else if (data && data.Cmd && data.Cmd == "Close") {
                    // the port was closed, possibly by other browser or even locally from sys tray
                    this.onPortClose(data);
                } else if (data && data.SerialPorts) {
                    // we got a serial port list
                    console.log("got serial port list");
                    console.log(data);
                    this.onPortList(data.SerialPorts);
                } else if (data && data.P && data.D) {
                    
                    // we got actual raw serial port data
                    // we need to parse into newlines and buffer
                    // for the next time we get here and only fire off
                    // a publish per newline
                    
                    if (this.isSingleSelectMode && this.singleSelectPort == data.P) {
                        
                        //console.log("this:", this);
                        //console.log("dataBuffer:", this.dataBuffer);
                        //console.log("p:", data.P, "d:", data.D);
                        //console.log(this.dataBuffer[data.P]);
                        if(!(data.P in this.dataBuffer))
                            this.dataBuffer[data.P] = data.D;
                        else
                            this.dataBuffer[data.P] += data.D;
                        //console.log(this.dataBuffer[data.P]);
                        //console.log("dataBuffer:", this.dataBuffer);
                        
                        //var portBuf = this.dataBuffer[data.P];
                        
                        // see if we got newline
                        while (this.dataBuffer[data.P].match(/\n/)) {
                            //console.log("we have a newline.");
                            var tokens = this.dataBuffer[data.P].split(/\n/);
                            var line = tokens.shift() + "\n";
                            this.dataBuffer[data.P] = tokens.join("\n");
                            //console.log("publishing line:", line);
                            //console.log("new buffer:", this.dataBuffer[data.P], "len:", this.dataBuffer[data.P].length);
                            
                            chilipeppr.publish("/" + this.id + "/recvline", {
                                ws: this.conn.url,
                                port: data.P,
                                dataline: line
                            });
                            
                        }
                    } else {
                        console.log("have a /recvline to publish, but since in single select mode we don't have a match to the selected port so ignoring.");
                    }
                    
                }
                
            } else if (msg.match(/We could not find the serial port/)) {
                // kind of a hack to send publishSysMsg when we get this
                // the serial-port-json-server should be changed to send this as json
                this.publishSysMsg(msg);
            }
        },
        onPortOpen: function(data) {
            console.log("Open a port: ", data, data.Port);
            var portname = data.Port;
            // swap back weird characters
            portname = this.toSafePortName(portname);
            console.log("got onPortOpen. portname to use for dom lookups:", portname);
            $('#' + portname + "Cb").prop('checked', true);
            $('#' + portname + "Row .glyphicon-exclamation-sign").addClass("hidden");
            if (this.isSingleSelectMode) {
                console.log("got port open but in single select mode.");
                // hilite this port
                $('.com-chilipeppr-widget-serialport-portlist > tbody > tr').removeClass("success");
                $('#' + portname + "Row").addClass("success");
                this.singleSelectPort = data.Port;
                // save cookie, but let path be to this workspace so other workspaces using this
                // widget leave their own default last singleSelectPort
                $.cookie("singleSelectPort", data.Port, { expires: 365 * 10 });
            }
            
            // publish /ws/onconnect
            chilipeppr.publish('/' + this.id + '/ws/onconnect', data);
        },
        onPortClose: function(data) {
            console.log("Close a port: ", data, data.Port);
            var portname = data.Port;
            portname = this.toSafePortName(portname);
            $('#' + portname + "Cb").prop('checked', false);
            $('#' + portname + "Row .glyphicon-exclamation-sign").addClass("hidden");
        },
        onPortOpenFail: function(data) {
            console.log("Opening a port failed: ", data, data.Port);
            var portname = data.Port;
            portname = this.toSafePortName(portname);
            $('#' + portname + "Cb").prop('checked', false);
            //$('#' + portname + "Row .glyphicon-exclamation-sign").prop("title", data.Desc);
            $('#' + portname + "Row .glyphicon-exclamation-sign").removeClass("hidden");
            $('#' + portname + "Row .glyphicon-exclamation-sign").tooltip({
                title: data.Desc,
                animation: true,
                delay: 100,
                container: 'body'
            });
        },
        toSafePortName: function(portname) {
            // we need to convert vals that could show up in the port name
            // with vals that are safe to use in the DOM as id's
            portname = portname.replace(/\//g, "-fslash-");
            portname = portname.replace(/\./g, "-dot-");
            return portname;
        },
        fromSafePortName: function(safeportname) {
            safeportname = safeportname.replace(/-fslash-/g, "/");
            safeportname = safeportname.replace(/-dot-/g, ".");
            return safeportname;
        },
        onPortList: function (portlist) {
            //console.log("inside onPortList");
            var html = "";
            var htmlFirst = ""; // show the connected ports first in the HTML
            var that = this;
            this.portlist = portlist;
            // publish the port list for other listeners
            chilipeppr.publish("/com-chilipeppr-widget-serialport/list", portlist);
            // now build the UI
            $.each(portlist, function (i, item) {
                console.log("looping thru ports. item:", item);
                var rowClass = "";
                if (item.Name == that.singleSelectPort) {
                    rowClass = "success";
                }
                var i = item.Name;
                i = that.toSafePortName(i);
                console.log("the port name we will use is:", i);
                var row = "<tr id=\"" + i + "Row\" class=\"" + rowClass + "\"><td>" +
                    "<input id=\"" + i + "Cb\" type=\"checkbox\" /> <span class=\"glyphicon glyphicon-exclamation-sign text-danger hidden\" data-toggle=\"tooltip\" data-placement=\"auto\"></span>" +
                    "</td><td id=\"" + i + "Friendly\" style=\"cursor:pointer;\">" + item.Friendly + "</td>" +
                    "<td><select id=\"" + i + "Baud\" class=\"com-chilipeppr-widget-serialport-baud\" class=\"form-control\">" +
                    that.getBaudRates() +
                    "</select>" +
                    "</td></tr>";
                if ('IsOpen' in item && item.IsOpen == true)
                    htmlFirst += row;
                else
                    html += row;
            });
            html = htmlFirst + html;
            $('.table.com-chilipeppr-widget-serialport-portlist tbody').html(html);
            
            $.each(portlist, function (i, item) {
                // now set the values from the cookie so we make their life easier
                var cookie = that.serialGetCookie(item.Name);
                //console.log("got cookie for ", item.Name, " cookie:", cookie);
                //console.log(cookie.baud);
                
                var i = that.toSafePortName(item.Name);
                
                if (cookie && cookie.baud) {
                    // choose baud stored in the cookie
                    $('#' + i + "Baud").val(cookie.baud);
                }
                // we may have set the default vals from the cookie, but now override
                // based on what the serial port server has open and what those settings are
                if (item.IsOpen) {
                    $('#' + i + "Cb").prop('checked', item.IsOpen);
                    // choose baud it was opened at
                    $('#' + i + "Baud").val(item.Baud);
                }
                // pass my item inside the data val on the click event
                $('#' + i + "Cb").click({that:that,port:item}, that.onPortCbClicked);
                $('#' + i + "Friendly").click({that:that,port:item}, that.onPortFriendlyClicked);
            });
            
        },
        onPortFriendlyClicked: function(evt) {
            console.log("got onPortFriendlyClicked: ", evt);
            var item = evt.data.port;
            var that = evt.data.that;
            var isSelected = false;
            var i = that.toSafePortName(item.Name);
            if ($('#' + i + "Cb").is(":checked")) isSelected = true;
            if (isSelected) {
                // then we want to close, so uncheck
                $('#' + i + "Cb").prop('checked', false);
            } else {
                $('#' + i + "Cb").prop('checked', true);
            }
            // call the checkbox click event as if we had clicked it
            that.onPortCbClicked(evt);
        },
        onPortCbClicked: function(evt) {
            console.log("got onPortClicked: ", evt);
            var item = evt.data.port;
            var that = evt.data.that;
            console.log(item);
            // see if selected/unselected to know if close/open
            var isSelected = false;
            var i = that.toSafePortName(item.Name);
            if ($('#' + i + "Cb").is(":checked")) isSelected = true;
            
            //console.log("isSelected:", isSelected);
            if (isSelected) {
                // open the port
                // get baud rate picked
                var baud = $('#' + i + "Baud").val();
                that.serialConnect(item.Name, baud);
                //that.publishSysMsg("Serial port " + port.Friendly + " opened with baud rate " + baud);
            } else {
                // close the port
                that.serialDisconnect(item.Name);
                //that.publishSysMsg("Serial port " + port.Friendly + " closed");
            }
        },
        getBaudRates : function() {
            var bauds = ["2,400", "4,800", "9,600", "19,200", "38,400", "57,600", "115,200"];
            var baudHtml = "";
            $.each(bauds, function(i, item) {
                var clean = item.replace(/,/, "");
                baudHtml += "<option value=\"" + clean + "\">" + item + "</option>";
            });
            return baudHtml;
        },
        onWsConnect: function (event) {
            this.isWsConnected = true;
            //console.log(this.conn);
            //console.log(event);
            chilipeppr.publish("/" + this.id + "/ws/onconnect", "connected");
            this.publishSysMsg("Serial port ajax connection opened at " + this.conn.url +
                ", readyState: " + this.conn.readyState);
            $('.com-chilipeppr-widget-serialport-install').addClass('hidden');
        },
        onWsDisconnect: function (event) {
            this.isWsConnected = false;
            chilipeppr.publish("/" + this.id + "/ws/ondisconnect", "disconnected");
            this.publishSysMsg("Serial port ajax connection closed. " +
                "readyState: " + this.conn.readyState);
        },
        statusWatcher: function () {
            // This method subscribes to "/ws/sys" and updates the UI with
            // the latest msg
            chilipeppr.subscribe("/" + this.id + "/ws/sys", this, function (msg) {
                $('.com-chilipeppr-widget-serialport-status .well.well-sm').text(msg);
            });
        },
    }
});
//]]>  

</script>








<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/4RgrS/show/light/ -->
</div>
            </div>
        </div>
    </div>
</div>
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/2J3JH/show/light/ -->
</div>
            <!-- Right Sidebar (Workspace Picker, etc) Area -->
            <div id="pnlRtSidebar" class=""></div>
        </div>
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51962619-1', 'chilipeppr.com');
  ga('send', 'pageview');

</script>
  






<!-- end chilipeppr.load() url: http://fiddle.jshell.net/chilipeppr/2H9us/show/light/ -->
</div>



</body></html>
